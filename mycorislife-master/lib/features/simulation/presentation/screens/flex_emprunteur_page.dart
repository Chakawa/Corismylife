import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:mycorislife/features/souscription/presentation/screens/souscription_flex.dart';
import 'package:mycorislife/services/produit_sync_service.dart';
import 'package:mycorislife/models/tarif_produit_model.dart';
import 'package:mycorislife/services/auth_service.dart';
import 'package:mycorislife/features/simulation/domain/simulation_service.dart';

class FlexEmprunteurPage extends StatefulWidget {
  const FlexEmprunteurPage({super.key});

  @override
  State<FlexEmprunteurPage> createState() => _FlexEmprunteurPageState();
}

class _FlexEmprunteurPageState extends State<FlexEmprunteurPage> {
  final _capitalController = TextEditingController();
  final _dureeController = TextEditingController();
  final _dateNaissanceController = TextEditingController();

  // Garanties
  final _capitalPrevoyanceController = TextEditingController();
  final _capitalPerteEmploiController = TextEditingController();

  String dureeType = 'mois';
  String typePret = 'Pr√™t amortissable';
  bool garantiePrevoyance = false;
  bool garantiePerteEmploi = false;

  bool isLoading = false;
  Map<String, dynamic>? result;

  static const Color bleuCoris = Color(0xFF002B6B);
  static const Color rougeCoris = Color(0xFFE30613);
  static const Color vertCoris = Color(0xFF00A650);
  static const Color grisClairBg = Color(0xFFF8FAFB);

  // Service pour synchroniser avec la base de donn√©es
  final ProduitSyncService _produitSyncService = ProduitSyncService();

  // Donn√©es hardcod√©es pour fallback (si la base de donn√©es n'est pas disponible)
  final Map<String, double> tarifsPretAmortissable = {
    '18_12': 0.14979,
    '18_24': 0.29513,
    '18_36': 0.44644,
    '18_48': 0.60215,
    '18_60': 0.76109,
    '18_72': 0.92246,
    '18_84': 1.08582,
    '18_96': 1.25088,
    '18_108': 1.41752,
    '18_120': 1.58568,
    '18_132': 1.75523,
    '18_144': 1.92604,
    '18_156': 2.09796,
    '18_168': 2.27076,
    '18_180': 2.44436,
    '19_12': 0.15947,
    '19_24': 0.31185,
    '19_36': 0.46833,
    '19_48': 0.62787,
    '19_60': 0.78976,
    '19_72': 0.95367,
    '19_84': 1.11938,
    '19_96': 1.28681,
    '19_108': 1.45592,
    '19_120': 1.62663,
    '19_132': 1.79880,
    '19_144': 1.97227,
    '19_156': 2.14683,
    '19_168': 2.32238,
    '19_180': 2.49903,
    '20_12': 0.16518,
    '20_24': 0.32176,
    '20_36': 0.48131,
    '20_48': 0.64322,
    '20_60': 0.80723,
    '20_72': 0.97319,
    '20_84': 1.14106,
    '20_96': 1.31084,
    '20_108': 1.48242,
    '20_120': 1.65570,
    '20_132': 1.83051,
    '20_144': 2.00662,
    '20_156': 2.18393,
    '20_168': 2.36257,
    '20_180': 2.54288,
    '21_12': 0.16864,
    '21_24': 0.32772,
    '21_36': 0.48922,
    '21_48': 0.65297,
    '21_60': 0.81886,
    '21_72': 0.98689,
    '21_84': 1.15707,
    '21_96': 1.32931,
    '21_108': 1.50349,
    '21_120': 1.67943,
    '21_132': 1.85690,
    '21_144': 2.03579,
    '21_156': 2.21627,
    '21_168': 2.39867,
    '21_180': 2.58334,
    '22_12': 0.17063,
    '22_24': 0.33138,
    '22_36': 0.49458,
    '22_48': 0.66015,
    '22_60': 0.82812,
    '22_72': 0.99850,
    '22_84': 1.17120,
    '22_96': 1.34608,
    '22_108': 1.52298,
    '22_120': 1.70163,
    '22_132': 1.88195,
    '22_144': 2.06409,
    '22_156': 2.24845,
    '22_168': 2.43537,
    '22_180': 2.62515,
    '23_12': 0.17223,
    '23_24': 0.33469,
    '23_36': 0.49975,
    '23_48': 0.66747,
    '23_60': 0.83788,
    '23_72': 1.01086,
    '23_84': 1.18629,
    '23_96': 1.36396,
    '23_108': 1.54363,
    '23_120': 1.72520,
    '23_132': 1.90886,
    '23_144': 2.09502,
    '23_156': 2.28406,
    '23_168': 2.47629,
    '23_180': 2.67200,
    '24_12': 0.17424,
    '24_24': 0.33861,
    '24_36': 0.50592,
    '24_48': 0.67620,
    '24_60': 0.84930,
    '24_72': 1.02509,
    '24_84': 1.20338,
    '24_96': 1.38388,
    '24_108': 1.56652,
    '24_120': 1.75152,
    '24_132': 1.93934,
    '24_144': 2.13036,
    '24_156': 2.32491,
    '24_168': 2.52329,
    '24_180': 2.72580,
    '25_12': 0.17632,
    '25_24': 0.34308,
    '25_36': 0.51308,
    '25_48': 0.68615,
    '25_60': 0.86214,
    '25_72': 1.04085,
    '25_84': 1.22200,
    '25_96': 1.40552,
    '25_108': 1.59169,
    '25_120': 1.78099,
    '25_132': 1.97385,
    '25_144': 2.17060,
    '25_156': 2.37154,
    '25_168': 2.57699,
    '25_180': 2.78731,
    '26_12': 0.17926,
    '26_24': 0.34884,
    '26_36': 0.52170,
    '26_48': 0.69769,
    '26_60': 0.87664,
    '26_72': 1.05822,
    '26_84': 1.24243,
    '26_96': 1.42956,
    '26_108': 1.62018,
    '26_120': 1.81472,
    '26_132': 2.01354,
    '26_144': 2.21693,
    '26_156': 2.42521,
    '26_168': 2.63876,
    '26_180': 2.85808,
    '27_12': 0.18235,
    '27_24': 0.35476,
    '27_36': 0.53055,
    '27_48': 0.70951,
    '27_60': 0.89131,
    '27_72': 1.07597,
    '27_84': 1.26388,
    '27_96': 1.45564,
    '27_108': 1.65172,
    '27_120': 1.85247,
    '27_132': 2.05820,
    '27_144': 2.26922,
    '27_156': 2.48593,
    '27_168': 2.70883,
    '27_180': 2.93857,
    '28_12': 0.18532,
    '28_24': 0.36069,
    '28_36': 0.53945,
    '28_48': 0.72123,
    '28_60': 0.90614,
    '28_72': 1.09463,
    '28_84': 1.28736,
    '28_96': 1.48484,
    '28_108': 1.68741,
    '28_120': 1.89538,
    '28_132': 2.10905,
    '28_144': 2.32885,
    '28_156': 2.55527,
    '28_168': 2.78901,
    '28_180': 3.03068,
    '29_12': 0.18864,
    '29_24': 0.36696,
    '29_36': 0.54848,
    '29_48': 0.73340,
    '29_60': 0.92227,
    '29_72': 1.11584,
    '29_84': 1.31460,
    '29_96': 1.51889,
    '29_108': 1.72901,
    '29_120': 1.94527,
    '29_132': 2.16808,
    '29_144': 2.39799,
    '29_156': 2.63568,
    '29_168': 2.88182,
    '29_180': 3.13690,
    '30_12': 0.19165,
    '30_24': 0.37262,
    '30_36': 0.55734,
    '30_48': 0.74645,
    '30_60': 0.94076,
    '30_72': 1.14072,
    '30_84': 1.34666,
    '30_96': 1.55888,
    '30_108': 1.77766,
    '30_120': 2.00345,
    '30_132': 2.23679,
    '30_144': 2.47842,
    '30_156': 2.72900,
    '30_168': 2.98906,
    '30_180': 3.25901,
    '31_12': 0.19434,
    '31_24': 0.37875,
    '31_36': 0.56805,
    '31_48': 0.76306,
    '31_60': 0.96421,
    '31_72': 1.17178,
    '31_84': 1.38606,
    '31_96': 1.60733,
    '31_108': 1.83605,
    '31_120': 2.07280,
    '31_132': 2.31834,
    '31_144': 2.57336,
    '31_156': 2.83840,
    '31_168': 3.11387,
    '31_180': 3.40009,
    '32_12': 0.19884,
    '32_24': 0.38834,
    '32_36': 0.58410,
    '32_48': 0.78646,
    '32_60': 0.99565,
    '32_72': 1.21195,
    '32_84': 1.43566,
    '32_96': 1.66726,
    '32_108': 1.90737,
    '32_120': 2.15679,
    '32_132': 2.41623,
    '32_144': 2.68624,
    '32_156': 2.96723,
    '32_168': 3.25953,
    '32_180': 3.56323,
    '33_12': 0.20509,
    '33_24': 0.40167,
    '33_36': 0.60522,
    '33_48': 0.81599,
    '33_60': 1.03425,
    '33_72': 1.26033,
    '33_84': 1.49474,
    '33_96': 1.73814,
    '33_108': 1.99139,
    '33_120': 2.25522,
    '33_132': 2.53018,
    '33_144': 2.81669,
    '33_156': 3.11508,
    '33_168': 3.42543,
    '33_180': 3.74753,
    '34_12': 0.21377,
    '34_24': 0.41842,
    '34_36': 0.63065,
    '34_48': 0.85076,
    '34_60': 1.07909,
    '34_72': 1.31621,
    '34_84': 1.56281,
    '34_96': 1.81982,
    '34_108': 2.08799,
    '34_120': 2.36788,
    '34_132': 2.65990,
    '34_144': 2.96438,
    '34_156': 3.28138,
    '34_168': 3.61068,
    '34_180': 3.95180,
    '35_12': 0.22237,
    '35_24': 0.43592,
    '35_36': 0.65775,
    '35_48': 0.88820,
    '35_60': 1.12792,
    '35_72': 1.37765,
    '35_84': 1.63837,
    '35_96': 1.91085,
    '35_108': 2.19565,
    '35_120': 2.49319,
    '35_132': 2.80376,
    '35_144': 3.12744,
    '35_156': 3.46396,
    '35_168': 3.81281,
    '35_180': 4.17338,
    '36_12': 0.23264,
    '36_24': 0.45606,
    '36_36': 0.68853,
    '36_48': 0.93076,
    '36_60': 1.18354,
    '36_72': 1.44792,
    '36_84': 1.72470,
    '36_96': 2.01441,
    '36_108': 2.31745,
    '36_120': 2.63413,
    '36_132': 2.96449,
    '36_144': 3.30824,
    '36_156': 3.66483,
    '36_168': 4.03362,
    '36_180': 4.41391,
    '37_12': 0.24345,
    '37_24': 0.47781,
    '37_36': 0.72247,
    '37_48': 0.97827,
    '37_60': 1.24630,
    '37_72': 1.52738,
    '37_84': 1.82199,
    '37_96': 2.13056,
    '37_108': 2.45335,
    '37_120': 2.79040,
    '37_132': 3.14138,
    '37_144': 3.50571,
    '37_156': 3.88271,
    '37_168': 4.27168,
    '37_180': 4.67201,
    '38_12': 0.25590,
    '38_24': 0.50297,
    '38_36': 0.76177,
    '38_48': 1.03349,
    '38_60': 1.31889,
    '38_72': 1.61844,
    '38_84': 1.93253,
    '38_96': 2.26143,
    '38_108': 2.60516,
    '38_120': 2.96335,
    '38_132': 3.33539,
    '38_144': 3.72058,
    '38_156': 4.11817,
    '38_168': 4.52757,
    '38_180': 4.94836,
    '39_12': 0.27047,
    '39_24': 0.53229,
    '39_36': 0.80774,
    '39_48': 1.09750,
    '39_60': 1.40200,
    '39_72': 1.72162,
    '39_84': 2.05662,
    '39_96': 2.40699,
    '39_108': 2.77234,
    '39_120': 3.15202,
    '39_132': 3.54530,
    '39_144': 3.95144,
    '39_156': 4.36983,
    '39_168': 4.80006,
    '39_180': 5.24178,
    '40_12': 0.28728,
    '40_24': 0.56656,
    '40_36': 0.86073,
    '40_48': 1.17017,
    '40_60': 1.49527,
    '40_72': 1.83631,
    '40_84': 2.19325,
    '40_96': 2.56567,
    '40_108': 2.95289,
    '40_120': 3.35414,
    '40_132': 3.76868,
    '40_144': 4.19592,
    '40_156': 4.63548,
    '40_168': 5.08701,
    '40_180': 5.55021,
    '41_12': 0.30757,
    '41_24': 0.60609,
    '41_36': 0.92037,
    '41_48': 1.25083,
    '41_60': 1.59778,
    '41_72': 1.96116,
    '41_84': 2.34050,
    '41_96': 2.73507,
    '41_108': 3.14412,
    '41_120': 3.56687,
    '41_132': 4.00278,
    '41_144': 4.45149,
    '41_156': 4.91267,
    '41_168': 5.38606,
    '41_180': 5.87139,
    '42_12': 0.32843,
    '42_24': 0.64737,
    '42_36': 0.98306,
    '42_48': 1.33576,
    '42_60': 1.70541,
    '42_72': 2.09148,
    '42_84': 2.49320,
    '42_96': 2.90981,
    '42_108': 3.34055,
    '42_120': 3.78490,
    '42_132': 4.24253,
    '42_144': 4.71317,
    '42_156': 5.19658,
    '42_168': 5.69252,
    '42_180': 6.20063,
    '43_12': 0.35118,
    '43_24': 0.69191,
    '43_36': 1.05020,
    '43_48': 1.42592,
    '43_60': 1.81848,
    '43_72': 2.22708,
    '43_84': 2.65096,
    '43_96': 3.08939,
    '43_108': 3.54188,
    '43_120': 4.00818,
    '43_132': 4.48803,
    '43_144': 4.98125,
    '43_156': 5.48761,
    '43_168': 6.00678,
    '43_180': 6.53916,
    '44_12': 0.37504,
    '44_24': 0.73870,
    '44_36': 1.12023,
    '44_48': 1.51897,
    '44_60': 1.93411,
    '44_72': 2.36490,
    '44_84': 2.81066,
    '44_96': 3.27095,
    '44_108': 3.74558,
    '44_120': 4.23436,
    '44_132': 4.73713,
    '44_144': 5.25370,
    '44_156': 5.78375,
    '44_168': 6.32775,
    '44_180': 6.88691,
    '45_12': 0.40021,
    '45_24': 0.78720,
    '45_36': 1.19172,
    '45_48': 1.61295,
    '45_60': 2.05022,
    '45_72': 2.50287,
    '45_84': 2.97055,
    '45_96': 3.45314,
    '45_108': 3.95051,
    '45_120': 4.46255,
    '45_132': 4.98908,
    '45_144': 5.52981,
    '45_156': 6.08527,
    '45_168': 6.65679,
    '45_180': 7.24629,
    '46_12': 0.42514,
    '46_24': 0.83490,
    '46_36': 1.26170,
    '46_48': 1.70492,
    '46_60': 2.16398,
    '46_72': 2.63860,
    '46_84': 3.12876,
    '46_96': 3.63437,
    '46_108': 4.15536,
    '46_120': 4.69160,
    '46_132': 5.24280,
    '46_144': 5.80956,
    '46_156': 6.39334,
    '46_168': 6.99619,
    '46_180': 7.62005,
    '47_12': 0.44914,
    '47_24': 0.88095,
    '47_36': 1.32959,
    '47_48': 1.79454,
    '47_60': 2.27565,
    '47_72': 2.77296,
    '47_84': 3.28646,
    '47_96': 3.81611,
    '47_108': 4.36179,
    '47_120': 4.92322,
    '47_132': 5.50112,
    '47_144': 6.09705,
    '47_156': 6.71324,
    '47_168': 7.35171,
    '47_180': 8.01441,
    '48_12': 0.47252,
    '48_24': 0.92605,
    '48_36': 1.39640,
    '48_48': 1.88354,
    '48_60': 2.38762,
    '48_72': 2.90865,
    '48_84': 3.44664,
    '48_96': 4.00150,
    '48_108': 4.57295,
    '48_120': 5.16179,
    '48_132': 5.76978,
    '48_144': 6.39927,
    '48_156': 7.05242,
    '48_168': 7.73127,
    '48_180': 8.43757,
    '49_12': 0.49583,
    '49_24': 0.97107,
    '49_36': 1.46381,
    '49_48': 1.97428,
    '49_60': 2.50253,
    '49_72': 3.04857,
    '49_84': 3.61234,
    '49_96': 4.19356,
    '49_108': 4.79316,
    '49_120': 5.41308,
    '49_132': 6.05585,
    '49_144': 6.72376,
    '49_156': 7.41891,
    '49_168': 8.14314,
    '49_180': 8.89732,
    '50_12': 0.51916,
    '50_24': 1.01715,
    '50_36': 1.53371,
    '50_48': 2.06887,
    '50_60': 2.62269,
    '50_72': 3.19511,
    '50_84': 3.78586,
    '50_96': 4.39603,
    '50_108': 5.02776,
    '50_120': 5.68380,
    '50_132': 6.36654,
    '50_144': 7.07819,
    '50_156': 7.82063,
    '50_168': 8.59471,
    '50_180': 9.40135,
    '51_12': 0.54454,
    '51_24': 1.06692,
    '51_36': 1.60870,
    '51_48': 2.17001,
    '51_60': 2.75080,
    '51_72': 3.35080,
    '51_84': 3.97132,
    '51_96': 4.61473,
    '51_108': 5.28402,
    '51_120': 5.98171,
    '51_132': 6.71006,
    '51_144': 7.47101,
    '51_156': 8.26539,
    '51_168': 9.09410,
    '51_180': 9.95788,
    '52_12': 0.57148,
    '52_24': 1.11954,
    '52_36': 1.68801,
    '52_48': 2.27687,
    '52_60': 2.88582,
    '52_72': 3.51646,
    '52_84': 4.17145,
    '52_96': 4.85403,
    '52_108': 5.56680,
    '52_120': 6.31212,
    '52_132': 7.09196,
    '52_144': 7.90708,
    '52_156': 8.75839,
    '52_168': 9.64662,
    '52_180': 10.57176,
    '53_12': 0.59968,
    '53_24': 1.17502,
    '53_36': 1.77163,
    '53_48': 2.38920,
    '53_60': 3.02975,
    '53_72': 3.69626,
    '53_84': 4.39222,
    '53_96': 5.12033,
    '53_108': 5.88297,
    '53_120': 6.68213,
    '53_132': 7.51853,
    '53_144': 8.39303,
    '53_156': 9.30636,
    '53_168': 10.25847,
    '53_180': 11.24792,
    '54_12': 0.63002,
    '54_24': 1.23403,
    '54_36': 1.85985,
    '54_48': 2.51012,
    '54_60': 3.18818,
    '54_72': 3.89774,
    '54_84': 4.64154,
    '54_96': 5.42197,
    '54_108': 6.24101,
    '54_120': 7.09927,
    '54_132': 7.99762,
    '54_144': 8.93676,
    '54_156': 9.91659,
    '54_168': 10.93556,
    '54_180': 11.99131,
    '55_12': 0.66135,
    '55_24': 1.29499,
    '55_36': 1.95494,
    '55_48': 2.64479,
    '55_60': 3.36839,
    '55_72': 4.12843,
    '55_84': 4.92728,
    '55_96': 5.76689,
    '55_108': 6.64774,
    '55_120': 7.57067,
    '55_132': 8.53639,
    '55_144': 9.54476,
    '55_156': 10.59407,
    '55_168': 11.68184,
    '55_180': 12.80588,
    '56_12': 0.69380,
    '56_24': 1.36396,
    '56_36': 2.06624,
    '56_48': 2.80467,
    '56_60': 3.58175,
    '56_72': 4.39982,
    '56_84': 5.26080,
    '56_96': 6.16503,
    '56_108': 7.11333,
    '56_120': 8.10643,
    '56_132': 9.14414,
    '56_144': 10.22463,
    '56_156': 11.34525,
    '56_168': 12.50373,
    '56_180': 13.69801,
    '57_12': 0.73899,
    '57_24': 1.45455,
    '57_36': 2.20870,
    '57_48': 3.00367,
    '57_60': 3.84177,
    '57_72': 4.72492,
    '57_84': 5.65326,
    '57_96': 6.62765,
    '57_108': 7.64886,
    '57_120': 8.71666,
    '57_132': 9.82907,
    '57_144': 10.98329,
    '57_156': 12.17696,
    '57_168': 13.40801,
    '57_180': 14.67444,
    '58_12': 0.79118,
    '58_24': 1.56216,
    '58_36': 2.37593,
    '58_48': 3.23491,
    '58_60': 4.14106,
    '58_72': 5.09430,
    '58_84': 6.09556,
    '58_96': 7.14568,
    '58_108': 8.24439,
    '58_120': 9.38956,
    '58_132': 10.57822,
    '58_144': 11.80794,
    '58_156': 13.07663,
    '58_168': 14.38231,
    '58_180': 15.72282,
    '59_12': 0.85747,
    '59_24': 1.69067,
    '59_36': 2.57124,
    '59_48': 3.50113,
    '59_60': 4.47997,
    '59_72': 5.50881,
    '59_84': 6.58859,
    '59_96': 7.71902,
    '59_108': 8.89777,
    '59_120': 10.12169,
    '59_132': 11.38831,
    '59_144': 12.69554,
    '59_156': 14.04141,
    '59_168': 15.42377,
    '59_180': 16.84017,
    '60_12': 0.92555,
    '60_24': 1.82863,
    '60_36': 2.78320,
    '60_48': 3.78843,
    '60_60': 4.84566,
    '60_72': 5.95601,
    '60_84': 7.11912,
    '60_96': 8.33243,
    '60_108': 9.59260,
    '60_120': 10.89714,
    '60_132': 12.24398,
    '60_144': 13.63118,
    '60_156': 15.05662,
    '60_168': 16.51781,
    '60_180': 18.01207,
    '61_12': 1.00755,
    '61_24': 1.98764,
    '61_36': 3.01984,
    '61_48': 4.10614,
    '61_60': 5.24785,
    '61_72': 6.44453,
    '61_84': 7.69331,
    '61_96': 8.99062,
    '61_108': 10.33400,
    '61_120': 11.72143,
    '61_132': 13.15104,
    '61_144': 14.62072,
    '61_156': 16.12800,
    '61_168': 17.67013,
    '61_180': 19.24434,
    '62_12': 1.09226,
    '62_24': 2.15166,
    '62_36': 3.26777,
    '62_48': 4.44183,
    '62_60': 5.67318,
    '62_72': 6.95850,
    '62_84': 8.29404,
    '62_96': 9.67735,
    '62_108': 11.10654,
    '62_120': 12.57983,
    '62_132': 14.09517,
    '62_144': 15.65008,
    '62_156': 17.24178,
    '62_168': 18.86746,
    '62_180': 20.52430,
    '63_12': 1.17951,
    '63_24': 2.32677,
    '63_36': 3.53456,
    '63_48': 4.80188,
    '63_60': 6.12493,
    '63_72': 7.49975,
    '63_84': 8.92407,
    '63_96': 10.39617,
    '63_108': 11.91443,
    '63_120': 13.47685,
    '63_132': 15.08094,
    '63_144': 16.72394,
    '63_156': 18.40297,
    '63_168': 20.11519,
    '63_180': 21.85760,
    '64_12': 1.28199,
    '64_24': 2.52481,
    '64_36': 3.82925,
    '64_48': 5.19092,
    '64_60': 6.60582,
    '64_72': 8.07201,
    '64_84': 9.58802,
    '64_96': 11.15241,
    '64_108': 12.76326,
    '64_120': 14.41809,
    '64_132': 16.11410,
    '64_144': 17.84839,
    '64_156': 19.61808,
    '64_168': 21.42010,
    '64_180': 23.25123,
    '65_12': 1.38741,
    '65_24': 2.72999,
    '65_36': 4.13104,
    '65_48': 5.58674,
    '65_60': 7.09570,
    '65_72': 8.65679,
    '65_84': 10.26874,
    '65_96': 11.92970,
    '65_108': 13.63718,
    '65_120': 15.38833,
    '65_132': 17.18022,
    '65_144': 19.00992,
    '65_156': 20.87431,
    '65_168': 22.77008,
    '65_180': 24.69420,
  };
  final Map<String, double> tarifsPretDecouvert = {
    '18_1': 0.27220,
    '18_2': 0.55181,
    '18_3': 0.83122,
    '18_4': 1.10640,
    '18_5': 1.37498,
    '18_6': 1.63648,
    '18_7': 1.89164,
    '18_8': 2.14070,
    '18_9': 2.38491,
    '18_10': 2.62450,
    '18_11': 2.85933,
    '18_12': 3.08984,
    '18_13': 3.31567,
    '18_14': 3.53649,
    '18_15': 3.75433,
    '19_1': 0.28978,
    '19_2': 0.57936,
    '19_3': 0.86455,
    '19_4': 1.14290,
    '19_5': 1.41391,
    '19_6': 1.67837,
    '19_7': 1.93648,
    '19_8': 2.18958,
    '19_9': 2.43789,
    '19_10': 2.68127,
    '19_11': 2.92016,
    '19_12': 3.15421,
    '19_13': 3.38306,
    '19_14': 3.60883,
    '19_15': 3.83334,
    '20_1': 0.30015,
    '20_2': 0.59577,
    '20_3': 0.88429,
    '20_4': 1.16521,
    '20_5': 1.43932,
    '20_6': 1.70687,
    '20_7': 1.96922,
    '20_8': 2.22661,
    '20_9': 2.47887,
    '20_10': 2.72650,
    '20_11': 2.96910,
    '20_12': 3.20631,
    '20_13': 3.44033,
    '20_14': 3.67305,
    '20_15': 3.90689,
    '21_1': 0.30645,
    '21_2': 0.60554,
    '21_3': 0.89675,
    '21_4': 1.18091,
    '21_5': 1.45825,
    '21_6': 1.73022,
    '21_7': 1.99703,
    '21_8': 2.25854,
    '21_9': 2.51524,
    '21_10': 2.76672,
    '21_11': 3.01263,
    '21_12': 3.25522,
    '21_13': 3.49646,
    '21_14': 3.73888,
    '21_15': 3.98195,
    '22_1': 0.31006,
    '22_2': 0.61196,
    '22_3': 0.90654,
    '22_4': 1.19407,
    '22_5': 1.47601,
    '22_6': 1.75261,
    '22_7': 2.02372,
    '22_8': 2.28984,
    '22_9': 2.55055,
    '22_10': 2.80548,
    '22_11': 3.05697,
    '22_12': 3.30706,
    '22_13': 3.55837,
    '22_14': 3.81036,
    '22_15': 4.06444,
    '23_1': 0.31298,
    '23_2': 0.61839,
    '23_3': 0.91647,
    '23_4': 1.20877,
    '23_5': 1.49553,
    '23_6': 1.77659,
    '23_7': 2.05248,
    '23_8': 2.32277,
    '23_9': 2.58706,
    '23_10': 2.84779,
    '23_11': 3.10707,
    '23_12': 3.36760,
    '23_13': 3.62885,
    '23_14': 3.89226,
    '23_15': 4.15789,
    '24_1': 0.31663,
    '24_2': 0.62567,
    '24_3': 0.92871,
    '24_4': 1.22601,
    '24_5': 1.51739,
    '24_6': 1.80343,
    '24_7': 2.08365,
    '24_8': 2.35765,
    '24_9': 2.62796,
    '24_10': 2.89677,
    '24_11': 3.16688,
    '24_12': 3.43773,
    '24_13': 3.71082,
    '24_14': 3.98621,
    '24_15': 4.26511,
    '25_1': 0.32041,
    '25_2': 0.63459,
    '25_3': 0.94283,
    '25_4': 1.24494,
    '25_5': 1.54149,
    '25_6': 1.83202,
    '25_7': 2.11610,
    '25_8': 2.39636,
    '25_9': 2.67505,
    '25_10': 2.95510,
    '25_11': 3.23591,
    '25_12': 3.51904,
    '25_13': 3.80457,
    '25_14': 4.09372,
    '25_15': 4.38813,
    '26_1': 0.32575,
    '26_2': 0.64534,
    '26_3': 0.95857,
    '26_4': 1.26604,
    '26_5': 1.56726,
    '26_6': 1.86181,
    '26_7': 2.15238,
    '26_8': 2.44134,
    '26_9': 2.73169,
    '26_10': 3.02284,
    '26_11': 3.31640,
    '26_12': 3.61244,
    '26_13': 3.91224,
    '26_14': 4.21748,
    '26_15': 4.52971,
    '27_1': 0.33136,
    '27_2': 0.65614,
    '27_3': 0.97495,
    '27_4': 1.28728,
    '27_5': 1.59268,
    '27_6': 1.89397,
    '27_7': 2.19358,
    '27_8': 2.49464,
    '27_9': 2.79652,
    '27_10': 3.10090,
    '27_11': 3.40785,
    '27_12': 3.71871,
    '27_13': 4.03520,
    '27_14': 4.35894,
    '27_15': 4.69266,
    '28_1': 0.33677,
    '28_2': 0.66735,
    '28_3': 0.99120,
    '28_4': 1.30788,
    '28_5': 1.62029,
    '28_6': 1.93096,
    '28_7': 2.24313,
    '28_8': 2.55616,
    '28_9': 2.87178,
    '28_10': 3.19006,
    '28_11': 3.51239,
    '28_12': 3.84057,
    '28_13': 4.17626,
    '28_14': 4.52230,
    '28_15': 4.87795,
    '29_1': 0.34280,
    '29_2': 0.67863,
    '29_3': 1.00701,
    '29_4': 1.33097,
    '29_5': 1.65312,
    '29_6': 1.97683,
    '29_7': 2.30143,
    '29_8': 2.62872,
    '29_9': 2.95876,
    '29_10': 3.29301,
    '29_11': 3.63332,
    '29_12': 3.98142,
    '29_13': 4.34025,
    '29_14': 4.70904,
    '29_15': 5.08847,
    '30_1': 0.34826,
    '30_2': 0.68880,
    '30_3': 1.02475,
    '30_4': 1.35883,
    '30_5': 1.69453,
    '30_6': 2.03114,
    '30_7': 2.37054,
    '30_8': 2.71280,
    '30_9': 3.05943,
    '30_10': 3.41233,
    '30_11': 3.77332,
    '30_12': 4.14544,
    '30_13': 4.52788,
    '30_14': 4.92135,
    '30_15': 5.32552,
    '31_1': 0.35316,
    '31_2': 0.70156,
    '31_3': 1.04803,
    '31_4': 1.39617,
    '31_5': 1.74526,
    '31_6': 2.09724,
    '31_7': 2.45219,
    '31_8': 2.81166,
    '31_9': 3.17765,
    '31_10': 3.55202,
    '31_11': 3.93793,
    '31_12': 4.33455,
    '31_13': 4.74260,
    '31_14': 5.16176,
    '31_15': 5.59181,
    '32_1': 0.36133,
    '32_2': 0.72065,
    '32_3': 1.08172,
    '32_4': 1.44376,
    '32_5': 1.80881,
    '32_6': 2.17693,
    '32_7': 2.54974,
    '32_8': 2.92931,
    '32_9': 3.31758,
    '32_10': 3.71780,
    '32_11': 4.12915,
    '32_12': 4.55235,
    '32_13': 4.98705,
    '32_14': 5.43306,
    '32_15': 5.88842,
    '33_1': 0.37268,
    '33_2': 0.74717,
    '33_3': 1.12268,
    '33_4': 1.50130,
    '33_5': 1.88311,
    '33_6': 2.26979,
    '33_7': 2.66347,
    '33_8': 3.06617,
    '33_9': 3.48129,
    '33_10': 3.90792,
    '33_11': 4.34686,
    '33_12': 4.79773,
    '33_13': 5.26033,
    '33_14': 5.73261,
    '33_15': 6.21197,
    '34_1': 0.38845,
    '34_2': 0.77796,
    '34_3': 1.17070,
    '34_4': 1.56675,
    '34_5': 1.96784,
    '34_6': 2.37621,
    '34_7': 2.79392,
    '34_8': 3.22451,
    '34_9': 3.66706,
    '34_10': 4.12236,
    '34_11': 4.59005,
    '34_12': 5.06989,
    '34_13': 5.55979,
    '34_14': 6.05702,
    '34_15': 6.55938,
    '35_1': 0.40409,
    '35_2': 0.81153,
    '35_3': 1.22240,
    '35_4': 1.63850,
    '35_5': 2.06216,
    '35_6': 2.49551,
    '35_7': 2.94221,
    '35_8': 3.40133,
    '35_9': 3.87367,
    '35_10': 4.35886,
    '35_11': 4.85666,
    '35_12': 5.36490,
    '35_13': 5.88073,
    '35_14': 6.40190,
    '35_15': 6.92689,
    '36_1': 0.42275,
    '36_2': 0.84906,
    '36_3': 1.28079,
    '36_4': 1.72036,
    '36_5': 2.16999,
    '36_6': 2.63348,
    '36_7': 3.10984,
    '36_8': 3.59993,
    '36_9': 4.10335,
    '36_10': 4.61986,
    '36_11': 5.14719,
    '36_12': 5.68240,
    '36_13': 6.22315,
    '36_14': 6.76787,
    '36_15': 7.31520,
    '37_1': 0.44240,
    '37_2': 0.89043,
    '37_3': 1.34659,
    '37_4': 1.81319,
    '37_5': 2.29417,
    '37_6': 2.78850,
    '37_7': 3.29709,
    '37_8': 3.81951,
    '37_9': 4.35550,
    '37_10': 4.90273,
    '37_11': 5.45815,
    '37_12': 6.01930,
    '37_13': 6.58457,
    '37_14': 7.15256,
    '37_15': 7.72406,
    '38_1': 0.46502,
    '38_2': 0.93847,
    '38_3': 1.42276,
    '38_4': 1.92198,
    '38_5': 2.43506,
    '38_6': 2.96292,
    '38_7': 3.50515,
    '38_8': 4.06147,
    '38_9': 4.62944,
    '38_10': 5.20592,
    '38_11': 5.78835,
    '38_12': 6.37505,
    '38_13': 6.96457,
    '38_14': 7.55774,
    '38_15': 8.15467,
    '39_1': 0.49150,
    '39_2': 0.99425,
    '39_3': 1.51250,
    '39_4': 2.04514,
    '39_5': 2.59312,
    '39_6': 3.15602,
    '39_7': 3.73354,
    '39_8': 4.32317,
    '39_9': 4.92162,
    '39_10': 5.52625,
    '39_11': 6.13532,
    '39_12': 6.74731,
    '39_13': 7.36309,
    '39_14': 7.98277,
    '39_15': 8.60604,
    '40_1': 0.52204,
    '40_2': 1.06016,
    '40_3': 1.61323,
    '40_4': 2.18224,
    '40_5': 2.76672,
    '40_6': 3.36640,
    '40_7': 3.97864,
    '40_8': 4.60004,
    '40_9': 5.22786,
    '40_10': 5.86030,
    '40_11': 6.49576,
    '40_12': 7.13516,
    '40_13': 7.77861,
    '40_14': 8.42579,
    '40_15': 9.07719,
    '41_1': 0.55891,
    '41_2': 1.13335,
    '41_3': 1.72434,
    '41_4': 2.33140,
    '41_5': 2.95425,
    '41_6': 3.59014,
    '41_7': 4.23555,
    '41_8': 4.88762,
    '41_9': 5.54449,
    '41_10': 6.20451,
    '41_11': 6.86861,
    '41_12': 7.53691,
    '41_13': 8.20909,
    '41_14': 8.88565,
    '41_15': 9.56575,
    '42_1': 0.59682,
    '42_2': 1.21083,
    '42_3': 1.84155,
    '42_4': 2.48867,
    '42_5': 3.14934,
    '42_6': 3.81990,
    '42_7': 4.49738,
    '42_8': 5.17983,
    '42_9': 5.86557,
    '42_10': 6.55555,
    '42_11': 7.24989,
    '42_12': 7.94826,
    '42_13': 8.65119,
    '42_14': 9.35778,
    '42_15': 10.06726,
    '43_1': 0.63815,
    '43_2': 1.29366,
    '43_3': 1.96621,
    '43_4': 2.65285,
    '43_5': 3.34977,
    '43_6': 4.05388,
    '43_7': 4.76316,
    '43_8': 5.47585,
    '43_9': 6.19295,
    '43_10': 6.91459,
    '43_11': 7.64040,
    '43_12': 8.37096,
    '43_13': 9.10533,
    '43_14': 9.84270,
    '43_15': 10.59404,
    '44_1': 0.68152,
    '44_2': 1.38076,
    '44_3': 2.09464,
    '44_4': 2.81921,
    '44_5': 3.55126,
    '44_6': 4.28869,
    '44_7': 5.02965,
    '44_8': 5.77521,
    '44_9': 6.52548,
    '44_10': 7.28010,
    '44_11': 8.03964,
    '44_12': 8.80315,
    '44_13': 9.56978,
    '44_14': 10.35093,
    '44_15': 11.15041,
    '45_1': 0.72726,
    '45_2': 1.46975,
    '45_3': 2.22335,
    '45_4': 2.98473,
    '45_5': 3.75171,
    '45_6': 4.52237,
    '45_7': 5.29780,
    '45_8': 6.07813,
    '45_9': 6.86299,
    '45_10': 7.65297,
    '45_11': 8.44707,
    '45_12': 9.24442,
    '45_13': 10.05688,
    '45_14': 10.88839,
    '45_15': 11.74916,
    '46_1': 0.77255,
    '46_2': 1.55666,
    '46_3': 2.34887,
    '46_4': 3.14690,
    '46_5': 3.94876,
    '46_6': 4.75558,
    '46_7': 5.56751,
    '46_8': 6.38414,
    '46_9': 7.20611,
    '46_10': 8.03236,
    '46_11': 8.86198,
    '46_12': 9.70733,
    '46_13': 10.57251,
    '46_14': 11.46812,
    '46_15': 12.39053,
    '47_1': 0.81618,
    '47_2': 1.64078,
    '47_3': 2.47145,
    '47_4': 3.30610,
    '47_5': 4.14591,
    '47_6': 4.99105,
    '47_7': 5.84108,
    '47_8': 6.69665,
    '47_9': 7.55669,
    '47_10': 8.42025,
    '47_11': 9.30017,
    '47_12': 10.20072,
    '47_13': 11.13297,
    '47_14': 12.09309,
    '47_15': 13.08927,
    '48_1': 0.85865,
    '48_2': 1.72362,
    '48_3': 2.59273,
    '48_4': 3.46722,
    '48_5': 4.34725,
    '48_6': 5.23237,
    '48_7': 6.12328,
    '48_8': 7.01883,
    '48_9': 7.91804,
    '48_10': 8.83429,
    '48_11': 9.77203,
    '48_12': 10.74277,
    '48_13': 11.74253,
    '48_14': 12.77985,
    '48_15': 13.85026,
    '49_1': 0.90101,
    '49_2': 1.80634,
    '49_3': 2.71728,
    '49_4': 3.63398,
    '49_5': 4.55600,
    '49_6': 5.48403,
    '49_7': 6.41690,
    '49_8': 7.35359,
    '49_9': 8.30802,
    '49_10': 9.28484,
    '49_11': 10.29603,
    '49_12': 11.33747,
    '49_13': 12.41801,
    '49_14': 13.53303,
    '49_15': 14.67760,
    '50_1': 0.94341,
    '50_2': 1.89266,
    '50_3': 2.84792,
    '50_4': 3.80871,
    '50_5': 4.77578,
    '50_6': 5.74789,
    '50_7': 6.72397,
    '50_8': 7.71854,
    '50_9': 8.73645,
    '50_10': 9.79017,
    '50_11': 10.87540,
    '50_12': 12.00140,
    '50_13': 13.16331,
    '50_14': 14.35602,
    '50_15': 15.58659,
    '51_1': 0.98954,
    '51_2': 1.98534,
    '51_3': 2.98691,
    '51_4': 3.99503,
    '51_5': 5.00839,
    '51_6': 6.02591,
    '51_7': 7.06270,
    '51_8': 8.12381,
    '51_9': 9.22225,
    '51_10': 10.35354,
    '51_11': 11.52733,
    '51_12': 12.73855,
    '51_13': 13.98189,
    '51_14': 15.26469,
    '51_15': 16.58036,
    '52_1': 1.03849,
    '52_2': 2.08299,
    '52_3': 3.13431,
    '52_4': 4.19112,
    '52_5': 5.25224,
    '52_6': 6.33347,
    '52_7': 7.44006,
    '52_8': 8.58559,
    '52_9': 9.76537,
    '52_10': 10.98947,
    '52_11': 12.25261,
    '52_12': 13.54924,
    '52_13': 14.88702,
    '52_14': 16.25909,
    '52_15': 17.66175,
    '53_1': 1.08974,
    '53_2': 2.18659,
    '53_3': 3.28916,
    '53_4': 4.39624,
    '53_5': 5.52430,
    '53_6': 6.67881,
    '53_7': 7.87395,
    '53_8': 9.10483,
    '53_9': 10.38194,
    '53_10': 11.69978,
    '53_11': 13.05257,
    '53_12': 14.44828,
    '53_13': 15.87977,
    '53_14': 17.34318,
    '53_15': 18.82044,
    '54_1': 1.14487,
    '54_2': 2.29570,
    '54_3': 3.45124,
    '54_4': 4.62868,
    '54_5': 5.83373,
    '54_6': 7.08118,
    '54_7': 8.36594,
    '54_8': 9.69896,
    '54_9': 11.07449,
    '54_10': 12.48649,
    '54_11': 13.94331,
    '54_12': 15.43745,
    '54_13': 16.96493,
    '54_14': 18.50685,
    '54_15': 20.06160,
    '55_1': 1.20179,
    '55_2': 2.40849,
    '55_3': 3.63806,
    '55_4': 4.89647,
    '55_5': 6.19915,
    '55_6': 7.54080,
    '55_7': 8.93283,
    '55_8': 10.36927,
    '55_9': 11.84379,
    '55_10': 13.36510,
    '55_11': 14.92541,
    '55_12': 16.52051,
    '55_13': 18.13071,
    '55_14': 19.75429,
    '55_15': 21.38878,
    '56_1': 1.26076,
    '56_2': 2.54540,
    '56_3': 3.86018,
    '56_4': 5.22122,
    '56_5': 6.62297,
    '56_6': 8.07736,
    '56_7': 9.57814,
    '56_8': 11.11871,
    '56_9': 12.70817,
    '56_10': 14.33837,
    '56_11': 16.00492,
    '56_12': 17.68725,
    '56_13': 19.38356,
    '56_14': 21.09127,
    '56_15': 22.80859,
    '57_1': 1.34288,
    '57_2': 2.71727,
    '57_3': 4.14000,
    '57_4': 5.60529,
    '57_5': 7.12561,
    '57_6': 8.69443,
    '57_7': 10.30484,
    '57_8': 11.96636,
    '57_9': 13.67046,
    '57_10': 15.41256,
    '57_11': 17.17116,
    '57_12': 18.94437,
    '57_13': 20.72949,
    '57_14': 22.52466,
    '57_15': 24.32701,
    '58_1': 1.43772,
    '58_2': 2.92602,
    '58_3': 4.45884,
    '58_4': 6.04922,
    '58_5': 7.69033,
    '58_6': 9.37496,
    '58_7': 11.11304,
    '58_8': 12.89567,
    '58_9': 14.71806,
    '58_10': 16.55770,
    '58_11': 18.41262,
    '58_12': 20.28001,
    '58_13': 22.15790,
    '58_14': 24.04331,
    '58_15': 25.93102,
    '59_1': 1.55818,
    '59_2': 3.16296,
    '59_3': 4.82802,
    '59_4': 6.54618,
    '59_5': 8.30990,
    '59_6': 10.12959,
    '59_7': 11.99592,
    '59_8': 13.90387,
    '59_9': 15.82988,
    '59_10': 17.77190,
    '59_11': 19.72695,
    '59_12': 21.69302,
    '59_13': 23.66695,
    '59_14': 25.64329,
    '59_15': 27.61668,
    '60_1': 1.68190,
    '60_2': 3.42697,
    '60_3': 5.22771,
    '60_4': 7.07618,
    '60_5': 8.98332,
    '60_6': 10.93933,
    '60_7': 12.93897,
    '60_8': 14.95753,
    '60_9': 16.99288,
    '60_10': 19.04189,
    '60_11': 21.10244,
    '60_12': 23.17122,
    '60_13': 25.24253,
    '60_14': 27.31076,
    '60_15': 29.37140,
    '61_1': 1.83091,
    '61_2': 3.72023,
    '61_3': 5.65963,
    '61_4': 7.66059,
    '61_5': 9.71282,
    '61_6': 11.81083,
    '61_7': 13.92869,
    '61_8': 16.06416,
    '61_9': 18.21396,
    '61_10': 20.37587,
    '61_11': 22.54643,
    '61_12': 24.71963,
    '61_13': 26.88960,
    '61_14': 29.05161,
    '61_15': 31.20249,
    '62_1': 1.98485,
    '62_2': 4.02232,
    '62_3': 6.12445,
    '62_4': 8.28045,
    '62_5': 10.48454,
    '62_6': 12.70949,
    '62_7': 14.95294,
    '62_8': 17.21145,
    '62_9': 19.48268,
    '62_10': 21.76299,
    '62_11': 24.04607,
    '62_12': 26.32577,
    '62_13': 28.59710,
    '62_14': 30.85674,
    '62_15': 33.10174,
    '63_1': 2.14339,
    '63_2': 4.35480,
    '63_3': 6.62289,
    '63_4': 8.94156,
    '63_5': 11.28218,
    '63_6': 13.64225,
    '63_7': 16.01817,
    '63_8': 18.40747,
    '63_9': 20.80632,
    '63_10': 23.20810,
    '63_11': 25.60631,
    '63_12': 27.99571,
    '63_13': 30.37283,
    '63_14': 32.73453,
    '63_15': 35.07561,
    '64_1': 2.32962,
    '64_2': 4.71895,
    '64_3': 7.16156,
    '64_4': 9.62729,
    '64_5': 12.11352,
    '64_6': 14.61644,
    '64_7': 17.13346,
    '64_8': 19.66054,
    '64_9': 22.19070,
    '64_10': 24.71710,
    '64_11': 27.23423,
    '64_12': 29.73841,
    '64_13': 32.22636,
    '64_14': 34.69258,
    '64_15': 37.13367,
    '65_1': 2.52118,
    '65_2': 5.09858,
    '65_3': 7.70038,
    '65_4': 10.32381,
    '65_5': 12.96485,
    '65_6': 15.62077,
    '65_7': 18.28730,
    '65_8': 20.95709,
    '65_9': 23.62290,
    '65_10': 26.27894,
    '65_11': 28.92130,
    '65_12': 31.54655,
    '65_13': 34.14886,
    '65_14': 36.72466,
    '65_15': 39.27507,
  };
  final Map<String, double> tarifsPerteEmploi = {
    '1': 19.20,
    '2': 38.40,
    '3': 57.60,
    '4': 76.80,
    '5': 96.00,
    '6': 115.20,
  };

  @override
  void dispose() {
    _capitalController.dispose();
    _dureeController.dispose();
    _dateNaissanceController.dispose();
    _capitalPrevoyanceController.dispose();
    _capitalPerteEmploiController.dispose();
    super.dispose();
  }

  String _formatNumber(double number) {
    return number.toStringAsFixed(0).replaceAllMapped(
          RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
          (Match m) => '${m[1]} ',
        );
  }

  double _parseDouble(String text) {
    final cleaned = text.replaceAll(' ', '').replaceAll(',', '.');
    return double.tryParse(cleaned) ?? 0.0;
  }

  int _parseInt(String text) {
    final cleaned = text.replaceAll(' ', '');
    return int.tryParse(cleaned) ?? 0;
  }

  int _calculateAge(String dateText) {
    if (dateText.isEmpty) return 0;
    try {
      DateTime dateNaissance = DateFormat('dd/MM/yyyy').parse(dateText);
      final now = DateTime.now();
      int age = now.year - dateNaissance.year;
      if (now.month < dateNaissance.month ||
          (now.month == dateNaissance.month && now.day < dateNaissance.day)) {
        age--;
      }
      return age;
    } catch (e) {
      return 0;
    }
  }

  void _showProfessionalDialog({
    required String title,
    required String message,
    required IconData icon,
    required Color iconColor,
    required Color backgroundColor,
  }) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          elevation: 16,
          child: Container(
            constraints: BoxConstraints(
              maxWidth: MediaQuery.of(context).size.width * 0.9,
            ),
            padding: const EdgeInsets.all(28),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              color: Colors.white,
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Color.alphaBlend(
                        backgroundColor.withAlpha(25), Colors.white),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    icon,
                    size: 48,
                    color: iconColor,
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF002B6B),
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),
                Text(
                  message,
                  style: const TextStyle(
                    fontSize: 14,
                    color: Colors.black87,
                    height: 1.5,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 28),
                SizedBox(
                  width: double.infinity,
                  height: 48,
                  child: ElevatedButton(
                    onPressed: () => Navigator.of(context).pop(),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF002B6B),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 4,
                    ),
                    child: const Text(
                      'Compris',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  bool _validateInputs() {
    if (_capitalController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            'Veuillez renseigner le montant du capital √† garantir pour continuer la simulation.',
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (_dureeController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            'Veuillez renseigner la dur√©e du contrat pour continuer la simulation.',
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (_dateNaissanceController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            "Veuillez renseigner la date de naissance de l'assur√© pour continuer la simulation.",
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    final age = _calculateAge(_dateNaissanceController.text);
    if (age < 18 || age > 65) {
      _showProfessionalDialog(
        title: '√Çge non admissible',
        message: "L'√¢ge doit √™tre compris entre 18 et 65 ans inclus.",
        icon: Icons.warning_amber_rounded,
        iconColor: Colors.red,
        backgroundColor: Colors.red,
      );
      return false;
    }

    if (garantiePrevoyance &&
        _capitalPrevoyanceController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message: 'Veuillez renseigner le capital pour la garantie Pr√©voyance.',
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (garantiePerteEmploi) {
      if (_capitalPerteEmploiController.text.trim().isEmpty) {
        _showProfessionalDialog(
          title: 'Champ obligatoire',
          message:
              "Veuillez renseigner le montant assur√© pour la garantie Perte d'emploi.",
          icon: Icons.edit_outlined,
          iconColor: Colors.orange,
          backgroundColor: Colors.orange,
        );
        return false;
      }
    }

    return true;
  }

  /// ==========================================
  /// R√âCUP√âRER UN TAUX DEPUIS LA BASE DE DONN√âES OU FALLBACK
  /// ==========================================
  /// R√©cup√®re le taux pour un type de pr√™t donn√© (amortissable ou d√©couvert)
  /// depuis la base de donn√©es. Si non disponible, utilise le fallback (donn√©es hardcod√©es).
  ///
  /// @param age: L'√¢ge de l'emprunteur
  /// @param dureeMois: La dur√©e du pr√™t en mois
  /// @param categorie: La cat√©gorie de pr√™t ('amortissable' ou 'decouvert')
  /// @param tableFallback: Les donn√©es hardcod√©es √† utiliser en cas d'√©chec
  ///
  /// @returns Le taux en pourcentage (ex: 0.150 = 0.15%)
  Future<double> _getRateFromDbOrFallback({
    required int age,
    required int dureeMois,
    required String categorie,
    required Map<String, double> tableFallback,
  }) async {
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë üîç [FLEX EMPRUNTEUR] Recherche taux                          ‚ïë');
    print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    print(
        '   üìä Param√®tres: age=$age, duree=$dureeMois mois, categorie=$categorie');

    // √âtape 1: Essayer de r√©cup√©rer depuis la base de donn√©es (serveur uniquement)
    print(
        '\n   üìç √âTAPE 1: Tentative r√©cup√©ration depuis BASE DE DONN√âES (serveur uniquement)...');
    try {
      final result = await _produitSyncService.getTarifWithSource(
        produitLibelle: 'CORIS FLEX EMPRUNTEUR',
        age: age,
        dureeContrat: dureeMois,
        periodicite: 'unique',
        categorie:
            categorie, // Filtrer par cat√©gorie (amortissable ou decouvert)
      );
      final tarifFromDB = result['tarif'] as TarifProduit?;

      // V√©rifier que le tarif correspond √† la cat√©gorie demand√©e (si sp√©cifi√©e)
      if (tarifFromDB != null && tarifFromDB.prime != null) {
        // V√©rifier que la cat√©gorie correspond
        if (tarifFromDB.categorie != categorie) {
          print(
              '   ‚ö†Ô∏è  Tarif trouv√© mais cat√©gorie diff√©rente (DB: ${tarifFromDB.categorie}, attendu: $categorie)');
          print('   üí° Passage au fallback (donn√©es hardcod√©es)');
        } else {
          print('   ‚úÖ Taux trouv√© depuis le SERVEUR: ${tarifFromDB.prime}%');
          if (tarifFromDB.categorie != null) {
            print('   üìã Cat√©gorie: ${tarifFromDB.categorie}');
          }
          print('   üí° Cache local IGNOR√â - Donn√©es du serveur uniquement');
          print(
              '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
          print(
              '‚ïë ‚úÖ [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis SERVEUR        ‚ïë');
          print(
              '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
          return tarifFromDB.prime!;
        }
      } else {
        print(
            '   ‚ö†Ô∏è  Taux non trouv√© dans la DB (serveur inaccessible ou donn√©es absentes)');
        print('   üí° Passage au fallback (donn√©es hardcod√©es)');
      }
    } catch (e) {
      print('   ‚ùå ERREUR lors de la r√©cup√©ration DB: $e');
      print('   üí° Passage au fallback (donn√©es hardcod√©es)');
    }

    // √âtape 2: Fallback - Utiliser les donn√©es cod√©es en dur
    print('\n   üìç √âTAPE 2: Utilisation FALLBACK (donn√©es hardcod√©es)...');
    final exactKey = '${age}_$dureeMois';
    if (tableFallback.containsKey(exactKey)) {
      final taux = tableFallback[exactKey]!;
      print('   ‚úÖ Taux depuis FALLBACK (donn√©es hardcod√©es): $taux%');
      print(
          '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
      print(
          '‚ïë ‚ö†Ô∏è  [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis FALLBACK       ‚ïë');
      print(
          '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
      return taux;
    }

    // Recherche approximative dans le fallback
    final possibleKeys =
        tableFallback.keys.where((key) => key.startsWith('${age}_')).toList();
    if (possibleKeys.isNotEmpty) {
      possibleKeys.sort((a, b) {
        final dureeA = int.tryParse(a.split('_')[1]) ?? 0;
        final dureeB = int.tryParse(b.split('_')[1]) ?? 0;
        return (dureeA - dureeMois).abs().compareTo((dureeB - dureeMois).abs());
      });
      final taux = tableFallback[possibleKeys.first]!;
      print('   ‚úÖ Taux depuis FALLBACK (approximatif): $taux%');
      print(
          '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
      print(
          '‚ïë ‚ö†Ô∏è  [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis FALLBACK       ‚ïë');
      print(
          '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
      return taux;
    }

    final allAges = tableFallback.keys
        .map((key) => int.tryParse(key.split('_')[0]) ?? 0)
        .toSet()
        .toList();
    allAges.sort((a, b) => (a - age).abs().compareTo((b - age).abs()));

    if (allAges.isNotEmpty) {
      final closestAge = allAges.first;
      final closestAgeKeys = tableFallback.keys
          .where((key) => key.startsWith('${closestAge}_'))
          .toList();
      if (closestAgeKeys.isNotEmpty) {
        closestAgeKeys.sort((a, b) {
          final dureeA = int.tryParse(a.split('_')[1]) ?? 0;
          final dureeB = int.tryParse(b.split('_')[1]) ?? 0;
          return (dureeA - dureeMois)
              .abs()
              .compareTo((dureeB - dureeMois).abs());
        });
        final taux = tableFallback[closestAgeKeys.first]!;
        print('   ‚úÖ Taux depuis FALLBACK (approximatif): $taux%');
        print(
            '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        print(
            '‚ïë ‚ö†Ô∏è  [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis FALLBACK       ‚ïë');
        print(
            '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
        return taux;
      }
    }

    print('   ‚ùå Aucun taux disponible (ni DB, ni fallback)');
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë ‚ùå [FLEX EMPRUNTEUR] ERREUR: Aucune donn√©e disponible        ‚ïë');
    print(
        '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    return 0.0;
  }

  /// ==========================================
  /// R√âCUP√âRER LE TAUX PERte D'EMPLOI DEPUIS LA BASE DE DONN√âES OU FALLBACK
  /// ==========================================
  /// R√©cup√®re le taux pour la garantie perte d'emploi depuis la base de donn√©es.
  /// Si non disponible, utilise le fallback (donn√©es hardcod√©es).
  ///
  /// @param dureeAnnees: La dur√©e du pr√™t en ann√©es (max 6 ans)
  /// @param tableFallback: Les donn√©es hardcod√©es √† utiliser en cas d'√©chec
  ///
  /// @returns Le montant fixe (ex: 19.20)
  Future<double> _getRatePerteEmploiFromDbOrFallback({
    required int dureeAnnees,
    required Map<String, double> tableFallback,
  }) async {
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë üîç [FLEX EMPRUNTEUR] Recherche taux Perte d\'Emploi           ‚ïë');
    print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    print('   üìä Param√®tres: duree=$dureeAnnees ann√©es');

    int dureeEffective = dureeAnnees > 6 ? 6 : dureeAnnees;

    // √âtape 1: Essayer de r√©cup√©rer depuis la base de donn√©es (serveur uniquement)
    print(
        '\n   üìç √âTAPE 1: Tentative r√©cup√©ration depuis BASE DE DONN√âES (serveur uniquement)...');
    try {
      final result = await _produitSyncService.getTarifWithSource(
        produitLibelle: 'CORIS FLEX EMPRUNTEUR',
        age: null, // Perte emploi n'utilise pas l'√¢ge
        dureeContrat: dureeEffective, // En ann√©es pour perte emploi
        periodicite: 'unique',
        categorie: 'perte_emploi', // Filtrer par cat√©gorie perte_emploi
      );
      final tarifFromDB = result['tarif'] as TarifProduit?;

      // V√©rifier que le tarif correspond √† la cat√©gorie perte_emploi
      if (tarifFromDB != null &&
          tarifFromDB.prime != null &&
          tarifFromDB.categorie == 'perte_emploi') {
        print('   ‚úÖ Taux trouv√© depuis le SERVEUR: ${tarifFromDB.prime}');
        print('   üí° Cache local IGNOR√â - Donn√©es du serveur uniquement');
        print(
            '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        print(
            '‚ïë ‚úÖ [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis SERVEUR        ‚ïë');
        print(
            '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
        return tarifFromDB.prime!;
      } else {
        print(
            '   ‚ö†Ô∏è  Taux non trouv√© dans la DB (serveur inaccessible ou donn√©es absentes)');
        print('   üí° Passage au fallback (donn√©es hardcod√©es)');
      }
    } catch (e) {
      print('   ‚ùå ERREUR lors de la r√©cup√©ration DB: $e');
      print('   üí° Passage au fallback (donn√©es hardcod√©es)');
    }

    // √âtape 2: Fallback - Utiliser les donn√©es cod√©es en dur
    print('\n   üìç √âTAPE 2: Utilisation FALLBACK (donn√©es hardcod√©es)...');
    String cle = dureeEffective.toString();
    if (tableFallback.containsKey(cle)) {
      final montant = tableFallback[cle]!;
      print('   ‚úÖ Taux depuis FALLBACK (donn√©es hardcod√©es): $montant');
      print(
          '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
      print(
          '‚ïë ‚ö†Ô∏è  [FLEX EMPRUNTEUR] Donn√©es utilis√©es depuis FALLBACK       ‚ïë');
      print(
          '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
      return montant;
    }

    print('   ‚ùå Aucun taux disponible (ni DB, ni fallback)');
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë ‚ùå [FLEX EMPRUNTEUR] ERREUR: Aucune donn√©e disponible        ‚ïë');
    print(
        '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    return 0.0;
  }

  void _simuler() async {
    if (!_validateInputs()) return;

    setState(() {
      isLoading = true;
      result = null;
    });

    await Future.delayed(const Duration(milliseconds: 500));

    try {
      double capital = _parseDouble(_capitalController.text);

      // V√©rification du montant maximum (30 000 000 FCFA)
      if (capital > 30000000) {
        _showProfessionalDialog(
          title: 'Limite de capital d√©pass√©e',
          message:
              'Le montant maximum du pr√™t √† couvrir pour FLEX EMPRUNTEUR est de 30 000 000 FCFA. Le montant a √©t√© ajust√© automatiquement.',
          icon: Icons.monetization_on_outlined,
          iconColor: Colors.orange,
          backgroundColor: Colors.orange,
        );
        capital = 30000000;
        _capitalController.text = _formatNumber(capital);
      }

      final age = _calculateAge(_dateNaissanceController.text);
      int duree = _parseInt(_dureeController.text);
      int dureeMois = dureeType == 'ann√©es' ? duree * 12 : duree;
      int dureeAnnees = dureeType == 'ann√©es' ? duree : (dureeMois / 12).ceil();

      // Taux de base selon type de pr√™t
      // Utiliser la base de donn√©es ou le fallback
      double rateBase;
      if (typePret == 'Pr√™t amortissable' || typePret == 'Pr√™t scolaire') {
        rateBase = await _getRateFromDbOrFallback(
          age: age,
          dureeMois: dureeMois,
          categorie: 'amortissable',
          tableFallback: tarifsPretAmortissable,
        );
      } else {
        // Pr√™t d√©couvert
        rateBase = await _getRateFromDbOrFallback(
          age: age,
          dureeMois: dureeMois,
          categorie: 'decouvert',
          tableFallback: tarifsPretDecouvert,
        );
      }

      final rateBaseDecimal = rateBase / 100;
      final primeBase = (capital * rateBaseDecimal).clamp(0, double.infinity);

      // Garanties optionnelles
      double primePrevoyance = 0.0;
      if (garantiePrevoyance && typePret != 'Pr√™t scolaire') {
        final capitalPrev = _parseDouble(_capitalPrevoyanceController.text);
        final ratePrev = await _getRateFromDbOrFallback(
          age: age,
          dureeMois: dureeMois,
          categorie: 'decouvert',
          tableFallback: tarifsPretDecouvert,
        );

        final ratePrevDecimal = ratePrev / 100;
        primePrevoyance =
            (capitalPrev * ratePrevDecimal).clamp(0, double.infinity);
      }

      double primePerteEmploi = 0.0;
      if (garantiePerteEmploi && typePret != 'Pr√™t scolaire') {
        final capitalPE = _parseDouble(_capitalPerteEmploiController.text);
        final ratePE = await _getRatePerteEmploiFromDbOrFallback(
          dureeAnnees: dureeAnnees,
          tableFallback: tarifsPerteEmploi,
        );

        final ratePEDecimal = ratePE / 100;
        primePerteEmploi =
            (capitalPE * ratePEDecimal).clamp(0, double.infinity);
      }

      final primeTotal = primeBase + primePrevoyance + primePerteEmploi;

      setState(() {
        result = {
          'primeBase': primeBase,
          'primePrevoyance': primePrevoyance,
          'primePerteEmploi': primePerteEmploi,
          'primeTotal': primeTotal,
          'rateBase': rateBase,
        };
      });

      // Sauvegarder la simulation en base de donn√©es
      if (result != null && result!['primeTotal'] > 0) {
        final age = _calculateAge(_dateNaissanceController.text);
        SimulationService.saveSimulation(
          produitNom: 'CORIS FLEX EMPRUNTEUR',
          typeSimulation: typePret,
          age: age,
          dateNaissance: _dateNaissanceController.text,
          capital: capital,
          prime: result!['primeTotal'],
          dureeMois: dureeMois,
          resultatPrime: result!['primeTotal'],
        );
      }
    } catch (e) {
      _showProfessionalDialog(
        title: 'Erreur de calcul',
        message:
            'Une erreur est survenue lors du calcul. Veuillez v√©rifier vos donn√©es.\nD√©tail: $e',
        icon: Icons.error_outline,
        iconColor: rougeCoris,
        backgroundColor: rougeCoris,
      );
    }

    setState(() => isLoading = false);
  }

  void _resetSimulation() {
    setState(() {
      _capitalController.clear();
      _dureeController.clear();
      _dateNaissanceController.clear();
      _capitalPrevoyanceController.clear();
      _capitalPerteEmploiController.clear();
      dureeType = 'mois';
      typePret = 'Pr√™t amortissable';
      garantiePrevoyance = false;
      garantiePerteEmploi = false;
      result = null;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: grisClairBg,
      body: Column(
        children: [
          _buildModernHeader(),
          Expanded(
            child: SingleChildScrollView(
              child: Padding(
                padding:
                    EdgeInsets.all(MediaQuery.of(context).size.width * 0.06),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const SizedBox(height: 32),
                    _buildSimulationCard(),
                    const SizedBox(height: 24),
                    if (result != null) _buildResultCard(),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildModernHeader() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [bleuCoris, Color.lerp(bleuCoris, Colors.black, 0.2)!],
        ),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 43, 107, 0.3),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: SafeArea(
        child: Padding(
          padding: EdgeInsets.fromLTRB(
            MediaQuery.of(context).size.width * 0.05,
            16,
            MediaQuery.of(context).size.width * 0.05,
            24,
          ),
          child: Row(
            children: [
              IconButton(
                icon:
                    const Icon(Icons.arrow_back, color: Colors.white, size: 24),
                onPressed: () => Navigator.pop(context),
              ),
              const SizedBox(width: 16),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: Color.fromRGBO(255, 255, 255, 0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Icon(
                  Icons.security,
                  color: Colors.white,
                  size: 24,
                ),
              ),
              const SizedBox(width: 16),
              const Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      "FLEX EMPRUNTEUR",
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                    Text(
                      "L'assurance qui couvre votre pr√™t",
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSimulationCard() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 20,
            offset: const Offset(0, 10),
          ),
        ],
      ),
      child: Padding(
        padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.07),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.calculate, color: bleuCoris, size: 24),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    "Param√®tres de simulation",
                    style: TextStyle(
                      fontSize: MediaQuery.of(context).size.width * 0.05,
                      fontWeight: FontWeight.bold,
                      color: bleuCoris,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 32),

            // Nouveau design pour le type de pr√™t
            _buildTypePretDropdown(),
            const SizedBox(height: 24),

            _buildModernTextField(
              controller: _capitalController,
              label: 'Montant du pr√™t √† couvrir',
              hint: 'Saisissez le montant',
              icon: Icons.monetization_on,
              suffix: 'FCFA',
              onChanged: (value) {
                // Formatage automatique du montant
                if (value.isNotEmpty) {
                  final numericValue = value.replaceAll(' ', '');
                  if (numericValue.isNotEmpty) {
                    final number = double.tryParse(numericValue);
                    if (number != null) {
                      // V√©rification du montant maximum (30 000 000 FCFA)
                      if (number > 30000000) {
                        _showProfessionalDialog(
                          title: 'Limite de capital d√©pass√©e',
                          message:
                              'Le montant maximum du pr√™t √† couvrir pour FLEX EMPRUNTEUR est de 30 000 000 FCFA.',
                          icon: Icons.monetization_on_outlined,
                          iconColor: Colors.orange,
                          backgroundColor: Colors.orange,
                        );
                        _capitalController.text = _formatNumber(30000000);
                        _capitalController.selection =
                            TextSelection.fromPosition(
                          TextPosition(offset: _capitalController.text.length),
                        );
                      } else {
                        _capitalController.text = _formatNumber(number);
                        _capitalController.selection =
                            TextSelection.fromPosition(
                          TextPosition(offset: _capitalController.text.length),
                        );
                      }
                    }
                  }
                }
              },
            ),
            const SizedBox(height: 24),

            Row(
              children: [
                Expanded(
                  flex: 2,
                  child: _buildModernTextField(
                    controller: _dureeController,
                    label: 'Dur√©e du contrat',
                    hint: 'Dur√©e',
                    icon: Icons.schedule,
                    onChanged: (value) {},
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: _buildModernDropdown(
                    label: 'Unit√©',
                    value: dureeType,
                    items: const {
                      'mois': 'mois',
                      'ann√©es': 'ann√©es',
                    },
                    icon: null,
                    onChanged: (val) => setState(() => dureeType = val!),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 24),

            // Champ date de naissance au lieu de l'√¢ge
            _buildDateNaissanceField(),
            const SizedBox(height: 32),

            _buildGarantiesSection(),
            const SizedBox(height: 32),

            SizedBox(
              width: double.infinity,
              height: 56,
              child: ElevatedButton(
                onPressed: isLoading ? null : _simuler,
                style: ElevatedButton.styleFrom(
                  backgroundColor: rougeCoris,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                  elevation: 8,
                  shadowColor: Color.fromRGBO(227, 6, 19, 0.4),
                ),
                child: isLoading
                    ? Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          const SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(
                              valueColor:
                                  AlwaysStoppedAnimation<Color>(Colors.white),
                              strokeWidth: 2,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Text(
                            "Calcul en cours...",
                            style: TextStyle(
                              fontSize:
                                  MediaQuery.of(context).size.width * 0.04,
                            ),
                          ),
                        ],
                      )
                    : Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          const Icon(Icons.play_circle_filled, size: 24),
                          const SizedBox(width: 12),
                          Text(
                            "Simuler",
                            style: TextStyle(
                              fontSize:
                                  MediaQuery.of(context).size.width * 0.04,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTypePretDropdown() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.1),
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        child: DropdownButtonFormField<String>(
          initialValue: typePret,
          decoration: const InputDecoration(
            border: InputBorder.none,
            prefixIcon: Icon(Icons.account_balance, color: Color(0xFF002B6B)),
            labelText: 'Type de pr√™t √† assurer',
          ),
          items: const [
            DropdownMenuItem(
              value: 'Pr√™t amortissable',
              child: Text('Pr√™t amortissable'),
            ),
            DropdownMenuItem(
              value: 'Pr√™t d√©couvert',
              child: Text('Pr√™t d√©couvert'),
            ),
            DropdownMenuItem(
              value: 'Pr√™t scolaire',
              child: Text('Pr√™t scolaire'),
            ),
          ],
          onChanged: (value) {
            setState(() {
              typePret = value!;
              if (typePret == 'Pr√™t scolaire') {
                garantiePrevoyance = false;
                garantiePerteEmploi = false;
              }
            });
          },
        ),
      ),
    );
  }

  Widget _buildDateNaissanceField() {
    final age = _calculateAge(_dateNaissanceController.text);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          "Date de naissance de l'assur√©",
          style: TextStyle(
            fontSize: MediaQuery.of(context).size.width * 0.035,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 8),
        TextField(
          controller: _dateNaissanceController,
          readOnly: true,
          onTap: () async {
            final DateTime? picked = await showDatePicker(
              context: context,
              initialDate:
                  DateTime.now().subtract(const Duration(days: 365 * 30)),
              firstDate: DateTime(1955),
              lastDate: DateTime.now().subtract(const Duration(days: 365 * 18)),
            );
            if (picked != null) {
              setState(() {
                _dateNaissanceController.text =
                    DateFormat('dd/MM/yyyy').format(picked);
              });
            }
          },
          decoration: InputDecoration(
            hintText: 'JJ/MM/AAAA',
            hintStyle: TextStyle(
              fontSize: MediaQuery.of(context).size.width * 0.035,
            ),
            prefixIcon: Icon(Icons.calendar_today,
                color: Color.fromRGBO(0, 43, 107, 0.7)),
            suffixText: age > 0 ? '($age ans)' : null,
            filled: true,
            fillColor: Color.fromRGBO(232, 244, 253, 0.3),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: const BorderSide(color: Color(0xFF002B6B), width: 2),
            ),
          ),
        ),
        if (age > 0 && (age < 18 || age > 65))
          Padding(
            padding: const EdgeInsets.only(top: 4),
            child: Text(
              'L\'√¢ge doit √™tre compris entre 18 et 65 ans',
              style: TextStyle(
                color: Colors.orange,
                fontSize: MediaQuery.of(context).size.width * 0.03,
              ),
            ),
          ),
      ],
    );
  }

  Widget _buildGarantiesSection() {
    final disabled = typePret == 'Pr√™t scolaire';

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          "Garanties optionnelles",
          style: TextStyle(
            fontSize: MediaQuery.of(context).size.width * 0.045,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 16),
        Opacity(
          opacity: disabled ? 0.5 : 1,
          child: IgnorePointer(
            ignoring: disabled,
            child: Column(
              children: [
                Container(
                  decoration: BoxDecoration(
                    color: Color.fromRGBO(232, 244, 253, 0.3),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: CheckboxListTile(
                    title: const Text(
                      'Pr√©voyance',
                      style: TextStyle(fontWeight: FontWeight.w600),
                    ),
                    subtitle: const Text('Garantie d√©c√®s'),
                    value: garantiePrevoyance,
                    activeColor: rougeCoris,
                    onChanged: (val) {
                      setState(() => garantiePrevoyance = val!);
                    },
                  ),
                ),
                if (garantiePrevoyance) ...[
                  const SizedBox(height: 16),
                  _buildModernTextField(
                    controller: _capitalPrevoyanceController,
                    label: 'Capital Pr√©voyance',
                    hint: 'Montant',
                    icon: Icons.security,
                    suffix: 'FCFA',
                    onChanged: (value) {
                      // Formatage automatique du montant
                      if (value.isNotEmpty) {
                        final numericValue = value.replaceAll(' ', '');
                        if (numericValue.isNotEmpty) {
                          final number = double.tryParse(numericValue);
                          if (number != null) {
                            _capitalPrevoyanceController.text =
                                _formatNumber(number);
                            _capitalPrevoyanceController.selection =
                                TextSelection.fromPosition(
                              TextPosition(
                                  offset:
                                      _capitalPrevoyanceController.text.length),
                            );
                          }
                        }
                      }
                    },
                  ),
                ],
                const SizedBox(height: 12),
                Container(
                  decoration: BoxDecoration(
                    color: Color.fromRGBO(232, 244, 253, 0.3),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: CheckboxListTile(
                    title: const Text(
                      "Perte d'emploi",
                      style: TextStyle(fontWeight: FontWeight.w600),
                    ),
                    subtitle: const Text('Garantie PE'),
                    value: garantiePerteEmploi,
                    activeColor: rougeCoris,
                    onChanged: (val) {
                      setState(() => garantiePerteEmploi = val!);
                    },
                  ),
                ),
                if (garantiePerteEmploi) ...[
                  const SizedBox(height: 16),
                  _buildModernTextField(
                    controller: _capitalPerteEmploiController,
                    label: "Montant de l'√©ch√©ance",
                    hint: 'Montant de la traite',
                    icon: Icons.savings,
                    suffix: 'FCFA',
                    onChanged: (value) {
                      // Formatage automatique du montant
                      if (value.isNotEmpty) {
                        final numericValue = value.replaceAll(' ', '');
                        if (numericValue.isNotEmpty) {
                          final number = double.tryParse(numericValue);
                          if (number != null) {
                            _capitalPerteEmploiController.text =
                                _formatNumber(number);
                            _capitalPerteEmploiController.selection =
                                TextSelection.fromPosition(
                              TextPosition(
                                  offset: _capitalPerteEmploiController
                                      .text.length),
                            );
                          }
                        }
                      }
                    },
                  ),
                ],
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildResultCard() {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Color.fromRGBO(0, 166, 80, 0.1),
            Colors.white,
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Color.fromRGBO(0, 166, 80, 0.2), width: 1),
      ),
      child: Padding(
        padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.05),
        child: Column(
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Color.fromRGBO(0, 166, 80, 0.1),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Icon(Icons.receipt_long, color: vertCoris, size: 22),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "R√©sultat de la simulation",
                        style: TextStyle(
                          fontSize: MediaQuery.of(context).size.width * 0.04,
                          fontWeight: FontWeight.bold,
                          color: bleuCoris,
                        ),
                      ),
                      Text(
                        "D√©tail de votre prime",
                        style: TextStyle(
                          fontSize: MediaQuery.of(context).size.width * 0.035,
                          color: Colors.black54,
                        ),
                      ),
                    ],
                  ),
                ),
                IconButton(
                  icon: Icon(Icons.refresh, color: bleuCoris),
                  onPressed: _resetSimulation,
                  tooltip: 'Nouvelle simulation',
                ),
              ],
            ),
            const SizedBox(height: 16),
            _buildPrimeRow("Prime de base", result!['primeBase']),
            if (garantiePrevoyance &&
                (result!['primePrevoyance'] as double) > 0)
              _buildPrimeRow("Prime Pr√©voyance", result!['primePrevoyance']),
            if (garantiePerteEmploi &&
                (result!['primePerteEmploi'] as double) > 0)
              _buildPrimeRow(
                  "Prime Perte d'emploi", result!['primePerteEmploi']),
            const SizedBox(height: 16),
            Container(height: 1, color: Color.fromRGBO(0, 166, 80, 0.3)),
            const SizedBox(height: 16),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Color.fromRGBO(0, 166, 80, 0.1)),
              ),
              child: Column(
                children: [
                  Text(
                    "PRIME TOTALE",
                    style: TextStyle(
                      fontSize: MediaQuery.of(context).size.width * 0.04,
                      fontWeight: FontWeight.bold,
                      color: bleuCoris,
                      letterSpacing: 1,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    '${_formatNumber(result!['primeTotal'])} FCFA',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: MediaQuery.of(context).size.width * 0.06,
                      fontWeight: FontWeight.bold,
                      color: vertCoris,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Taux de base appliqu√© : ${(result!['rateBase'] * 100).toStringAsFixed(2)} %',
                    style: TextStyle(
                      fontSize: MediaQuery.of(context).size.width * 0.032,
                      color: Colors.black54,
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            SizedBox(
              width: double.infinity,
              height: 48,
              child: ElevatedButton(
                onPressed: () async {
                  // Pr√©parer les donn√©es de simulation
                  final simulationData = {
                    'typePret': typePret,
                    'capital': _parseDouble(
                        _capitalController.text.replaceAll(' ', '')),
                    'duree':
                        _parseInt(_dureeController.text.replaceAll(' ', '')),
                    'dureeType': dureeType,
                    'garantiePrevoyance': garantiePrevoyance,
                    'capitalPrevoyance': garantiePrevoyance
                        ? _parseDouble(_capitalPrevoyanceController.text
                            .replaceAll(' ', ''))
                        : 0,
                    'garantiePerteEmploi': garantiePerteEmploi,
                    'capitalPerteEmploi': garantiePerteEmploi
                        ? _parseDouble(_capitalPerteEmploiController.text
                            .replaceAll(' ', ''))
                        : 0,
                  };

                  // V√©rifier le r√¥le et rediriger
                  final userRole = await AuthService.getUserRole();
                  if (userRole == 'commercial') {
                    // Pour les commerciaux, rediriger vers la s√©lection de client
                    Navigator.pushNamed(
                      context,
                      '/commercial/select_client',
                      arguments: {
                        'productType': 'emprunteur',
                        'simulationData': simulationData,
                      },
                    );
                  } else {
                    // Pour les clients, rediriger directement vers la souscription
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => SouscriptionFlexPage(
                          simulationData: simulationData,
                        ),
                      ),
                    );
                  }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: vertCoris,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 4,
                ),
                child: const Text(
                  "Souscrire",
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPrimeRow(String label, double amount) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(
            child: Text(
              label,
              style: TextStyle(
                fontSize: MediaQuery.of(context).size.width * 0.04,
                color: Colors.black87,
              ),
            ),
          ),
          Text(
            '${_formatNumber(amount)} FCFA',
            style: TextStyle(
              fontSize: MediaQuery.of(context).size.width * 0.04,
              fontWeight: FontWeight.w600,
              color: bleuCoris,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildModernTextField({
    required TextEditingController controller,
    required String label,
    required String hint,
    required IconData icon,
    String? suffix,
    required Function(String) onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: MediaQuery.of(context).size.width * 0.035,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 8),
        TextField(
          controller: controller,
          keyboardType: TextInputType.number,
          onChanged: onChanged,
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: TextStyle(
              fontSize: MediaQuery.of(context).size.width * 0.035,
            ),
            prefixIcon: Icon(icon, color: Color.fromRGBO(0, 43, 107, 0.7)),
            suffixText: suffix,
            suffixStyle: TextStyle(color: Color.fromRGBO(0, 43, 107, 0.7)),
            filled: true,
            fillColor: Color.fromRGBO(232, 244, 253, 0.3),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: const BorderSide(color: Color(0xFF002B6B), width: 2),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildModernDropdown({
    required String label,
    required String value,
    required Map<String, String> items,
    IconData? icon,
    required Function(String?) onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: MediaQuery.of(context).size.width * 0.035,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 8),
        DropdownButtonFormField<String>(
          initialValue: value,
          isExpanded: true,
          decoration: InputDecoration(
            prefixIcon: (icon != null)
                ? Icon(icon, color: Color.fromRGBO(0, 43, 107, 0.7))
                : null,
            filled: true,
            fillColor: Color.fromRGBO(232, 244, 253, 0.3),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: const BorderSide(color: Color(0xFF002B6B), width: 2),
            ),
          ),
          items: items.entries
              .map((e) => DropdownMenuItem(
                    value: e.key,
                    child: Text(
                      e.value,
                      style: TextStyle(
                        fontSize: MediaQuery.of(context).size.width * 0.035,
                      ),
                    ),
                  ))
              .toList(),
          onChanged: onChanged,
        ),
      ],
    );
  }
}
