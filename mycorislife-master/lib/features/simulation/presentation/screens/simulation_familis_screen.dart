import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:mycorislife/features/souscription/presentation/screens/souscription_familis.dart';
import 'package:mycorislife/services/produit_sync_service.dart';
import 'package:mycorislife/models/tarif_produit_model.dart';
import 'package:mycorislife/services/auth_service.dart';
import 'package:mycorislife/features/simulation/domain/simulation_service.dart';

class SimulationFamilisScreen extends StatefulWidget {
  const SimulationFamilisScreen({super.key});

  @override
  State<SimulationFamilisScreen> createState() =>
      _SimulationFamilisScreenState();
}

class _SimulationFamilisScreenState extends State<SimulationFamilisScreen> {
  final _capitalController = TextEditingController();
  final _dureeController = TextEditingController();
  final _dateNaissanceController = TextEditingController();

  String periodicite = 'annuel';
  bool isLoading = false;
  Map<String, dynamic>? result;
  int? age;

  // Service pour synchroniser avec la base de donn√©es
  final ProduitSyncService _produitSyncService = ProduitSyncService();

  static const Color bleuCoris = Color(0xFF002B6B);
  static const Color rougeCoris = Color(0xFFE30613);
  static const Color vertCoris = Color(0xFF00A650);
  static const Color bleuClair = Color(0xFFE8F4FD);
  static const Color grisClairBg = Color(0xFFF8FAFB);

  Map<int, Map<int, double>> tauxUnique = {
    18: {
      1: 0.27220,
      2: 0.55181,
      3: 0.83122,
      4: 1.10640,
      5: 1.37498,
      6: 1.63648,
      7: 1.89164,
      8: 2.14070,
      9: 2.38491,
      10: 2.62450,
      11: 2.85933,
      12: 3.08984,
      13: 3.31567,
      14: 3.53649,
      15: 3.75433,
      16: 3.97096,
      17: 4.18864,
      18: 4.40691,
      19: 4.62700,
      20: 4.84893
    },
    19: {
      1: 0.28978,
      2: 0.57936,
      3: 0.86455,
      4: 1.14290,
      5: 1.41391,
      6: 1.67837,
      7: 1.93648,
      8: 2.18958,
      9: 2.43789,
      10: 2.68127,
      11: 2.92016,
      12: 3.15421,
      13: 3.38306,
      14: 3.60883,
      15: 3.83334,
      16: 4.05894,
      17: 4.28516,
      18: 4.51325,
      19: 4.74326,
      20: 4.97620
    },
    20: {
      1: 0.30015,
      2: 0.59577,
      3: 0.88429,
      4: 1.16521,
      5: 1.43932,
      6: 1.70687,
      7: 1.96922,
      8: 2.22661,
      9: 2.47887,
      10: 2.72650,
      11: 2.96910,
      12: 3.20631,
      13: 3.44033,
      14: 3.67305,
      15: 3.90689,
      16: 4.14137,
      17: 4.37780,
      18: 4.61622,
      19: 4.85767,
      20: 5.10350
    },
    21: {
      1: 0.30645,
      2: 0.60554,
      3: 0.89675,
      4: 1.18091,
      5: 1.45825,
      6: 1.73022,
      7: 1.99703,
      8: 2.25854,
      9: 2.51524,
      10: 2.76672,
      11: 3.01263,
      12: 3.25522,
      13: 3.49646,
      14: 3.73888,
      15: 3.98195,
      16: 4.22703,
      17: 4.47419,
      18: 4.72448,
      19: 4.97932,
      20: 5.24000
    },
    22: {
      1: 0.31006,
      2: 0.61196,
      3: 0.90654,
      4: 1.19407,
      5: 1.47601,
      6: 1.75261,
      7: 2.02372,
      8: 2.28984,
      9: 2.55055,
      10: 2.80548,
      11: 3.05697,
      12: 3.30706,
      13: 3.55837,
      14: 3.81036,
      15: 4.06444,
      16: 4.32066,
      17: 4.58014,
      18: 4.84433,
      19: 5.11457,
      20: 5.39314
    },
    23: {
      1: 0.31298,
      2: 0.61839,
      3: 0.91647,
      4: 1.20877,
      5: 1.49553,
      6: 1.77659,
      7: 2.05248,
      8: 2.32277,
      9: 2.58706,
      10: 2.84779,
      11: 3.10707,
      12: 3.36760,
      13: 3.62885,
      14: 3.89226,
      15: 4.15789,
      16: 4.42690,
      17: 4.70079,
      18: 4.98096,
      19: 5.26975,
      20: 5.56657
    },
    24: {
      1: 0.31663,
      2: 0.62567,
      3: 0.92871,
      4: 1.22601,
      5: 1.51739,
      6: 1.80343,
      7: 2.08365,
      8: 2.35765,
      9: 2.62796,
      10: 2.89677,
      11: 3.16688,
      12: 3.43773,
      13: 3.71082,
      14: 3.98621,
      15: 4.26511,
      16: 4.54907,
      17: 4.83953,
      18: 5.13894,
      19: 5.44666,
      20: 5.76326
    },
    25: {
      1: 0.32041,
      2: 0.63459,
      3: 0.94283,
      4: 1.24494,
      5: 1.54149,
      6: 1.83202,
      7: 2.11610,
      8: 2.39636,
      9: 2.67505,
      10: 2.95510,
      11: 3.23591,
      12: 3.51904,
      13: 3.80457,
      14: 4.09372,
      15: 4.38813,
      16: 4.68927,
      17: 4.99969,
      18: 5.31874,
      19: 5.64698,
      20: 5.98415
    },
    26: {
      1: 0.32575,
      2: 0.64534,
      3: 0.95857,
      4: 1.26604,
      5: 1.56726,
      6: 1.86181,
      7: 2.15238,
      8: 2.44134,
      9: 2.73169,
      10: 3.02284,
      11: 3.31640,
      12: 3.61244,
      13: 3.91224,
      14: 4.21748,
      15: 4.52971,
      16: 4.85157,
      17: 5.18236,
      18: 5.52268,
      19: 5.87226,
      20: 6.23093
    },
    27: {
      1: 0.33136,
      2: 0.65614,
      3: 0.97495,
      4: 1.28728,
      5: 1.59268,
      6: 1.89397,
      7: 2.19358,
      8: 2.49464,
      9: 2.79652,
      10: 3.10090,
      11: 3.40785,
      12: 3.71871,
      13: 4.03520,
      14: 4.35894,
      15: 4.69266,
      16: 5.03565,
      17: 5.38852,
      18: 5.75099,
      19: 6.12288,
      20: 6.50256
    },
    28: {
      1: 0.33677,
      2: 0.66735,
      3: 0.99120,
      4: 1.30788,
      5: 1.62029,
      6: 1.93096,
      7: 2.24313,
      8: 2.55616,
      9: 2.87178,
      10: 3.19006,
      11: 3.51239,
      12: 3.84057,
      13: 4.17626,
      14: 4.52230,
      15: 4.87795,
      16: 5.24385,
      17: 5.61970,
      18: 6.00532,
      19: 6.39902,
      20: 6.79861
    },
    29: {
      1: 0.34280,
      2: 0.67863,
      3: 1.00701,
      4: 1.33097,
      5: 1.65312,
      6: 1.97683,
      7: 2.30143,
      8: 2.62872,
      9: 2.95876,
      10: 3.29301,
      11: 3.63332,
      12: 3.98142,
      13: 4.34025,
      14: 4.70904,
      15: 5.08847,
      16: 5.47821,
      17: 5.87809,
      18: 6.28634,
      19: 6.70070,
      20: 7.11934
    },
    30: {
      1: 0.34826,
      2: 0.68880,
      3: 1.02475,
      4: 1.35883,
      5: 1.69453,
      6: 2.03114,
      7: 2.37054,
      8: 2.71280,
      9: 3.05943,
      10: 3.41233,
      11: 3.77332,
      12: 4.14544,
      13: 4.52788,
      14: 4.92135,
      15: 5.32552,
      16: 5.74020,
      17: 6.16357,
      18: 6.59327,
      19: 7.02740,
      20: 7.46473
    },
    31: {
      1: 0.35316,
      2: 0.70156,
      3: 1.04803,
      4: 1.39617,
      5: 1.74526,
      6: 2.09724,
      7: 2.45219,
      8: 2.81166,
      9: 3.17765,
      10: 3.55202,
      11: 3.93793,
      12: 4.33455,
      13: 4.74260,
      14: 5.16176,
      15: 5.59181,
      16: 6.03086,
      17: 6.47649,
      18: 6.92672,
      19: 7.38026,
      20: 7.83598
    },
    32: {
      1: 0.36133,
      2: 0.72065,
      3: 1.08172,
      4: 1.44376,
      5: 1.80881,
      6: 2.17693,
      7: 2.54974,
      8: 2.92931,
      9: 3.31758,
      10: 3.71780,
      11: 4.12915,
      12: 4.55235,
      13: 4.98705,
      14: 5.43306,
      15: 5.88842,
      16: 6.35058,
      17: 6.81752,
      18: 7.28789,
      19: 7.76052,
      20: 8.23607
    },
    33: {
      1: 0.37268,
      2: 0.74717,
      3: 1.12268,
      4: 1.50130,
      5: 1.88311,
      6: 2.26979,
      7: 2.66347,
      8: 3.06617,
      9: 3.48129,
      10: 3.90792,
      11: 4.34686,
      12: 4.79773,
      13: 5.26033,
      14: 5.73261,
      15: 6.21197,
      16: 6.69627,
      17: 7.18413,
      18: 7.67433,
      19: 8.16757,
      20: 8.66393
    },
    34: {
      1: 0.38845,
      2: 0.77796,
      3: 1.17070,
      4: 1.56675,
      5: 1.96784,
      6: 2.37621,
      7: 2.79392,
      8: 3.22451,
      9: 3.66706,
      10: 4.12236,
      11: 4.59005,
      12: 5.06989,
      13: 5.55979,
      14: 6.05702,
      15: 6.55938,
      16: 7.06543,
      17: 7.57391,
      18: 8.08554,
      19: 8.60040,
      20: 9.11825
    },
    35: {
      1: 0.40409,
      2: 0.81153,
      3: 1.22240,
      4: 1.63850,
      5: 2.06216,
      6: 2.49551,
      7: 2.94221,
      8: 3.40133,
      9: 3.87367,
      10: 4.35886,
      11: 4.85666,
      12: 5.36490,
      13: 5.88073,
      14: 6.40190,
      15: 6.92689,
      16: 7.45440,
      17: 7.98518,
      18: 8.51932,
      19: 9.05655,
      20: 9.59729
    },
    36: {
      1: 0.42275,
      2: 0.84906,
      3: 1.28079,
      4: 1.72036,
      5: 2.16999,
      6: 2.63348,
      7: 3.10984,
      8: 3.59993,
      9: 4.10335,
      10: 4.61986,
      11: 5.14719,
      12: 5.68240,
      13: 6.22315,
      14: 6.76787,
      15: 7.31520,
      16: 7.86592,
      17: 8.42012,
      18: 8.97754,
      19: 9.53859,
      20: 10.10257
    },
    37: {
      1: 0.44240,
      2: 0.89043,
      3: 1.34659,
      4: 1.81319,
      5: 2.29417,
      6: 2.78850,
      7: 3.29709,
      8: 3.81951,
      9: 4.35550,
      10: 4.90273,
      11: 5.45815,
      12: 6.01930,
      13: 6.58457,
      14: 7.15256,
      15: 7.72406,
      16: 8.29918,
      17: 8.87763,
      18: 9.45986,
      19: 10.04512,
      20: 10.63278
    },
    38: {
      1: 0.46502,
      2: 0.93847,
      3: 1.42276,
      4: 1.92198,
      5: 2.43506,
      6: 2.96292,
      7: 3.50515,
      8: 4.06147,
      9: 4.62944,
      10: 5.20592,
      11: 5.78835,
      12: 6.37505,
      13: 6.96457,
      14: 7.55774,
      15: 8.15467,
      16: 8.75505,
      17: 9.35935,
      18: 9.96681,
      19: 10.57675,
      20: 11.19824
    },
    39: {
      1: 0.49150,
      2: 0.99425,
      3: 1.51250,
      4: 2.04514,
      5: 2.59312,
      6: 3.15602,
      7: 3.73354,
      8: 4.32317,
      9: 4.92162,
      10: 5.52625,
      11: 6.13532,
      12: 6.74731,
      13: 7.36309,
      14: 7.98277,
      15: 8.60604,
      16: 9.23338,
      17: 9.86398,
      18: 10.49717,
      19: 11.14236,
      20: 11.80268
    },
    40: {
      1: 0.52204,
      2: 1.06016,
      3: 1.61323,
      4: 2.18224,
      5: 2.76672,
      6: 3.36640,
      7: 3.97864,
      8: 4.60004,
      9: 5.22786,
      10: 5.86030,
      11: 6.49576,
      12: 7.13516,
      13: 7.77861,
      14: 8.42579,
      15: 9.07719,
      16: 9.73198,
      17: 10.38946,
      18: 11.05939,
      19: 11.74504,
      20: 12.45481
    },
    41: {
      1: 0.55891,
      2: 1.13335,
      3: 1.72434,
      4: 2.33140,
      5: 2.95425,
      6: 3.59014,
      7: 4.23555,
      8: 4.88762,
      9: 5.54449,
      10: 6.20451,
      11: 6.86861,
      12: 7.53691,
      13: 8.20909,
      14: 8.88565,
      15: 9.56575,
      16: 10.24862,
      17: 10.94443,
      18: 11.65657,
      19: 12.39376,
      20: 13.15299
    },
    42: {
      1: 0.59682,
      2: 1.21083,
      3: 1.84155,
      4: 2.48867,
      5: 3.14934,
      6: 3.81990,
      7: 4.49738,
      8: 5.17983,
      9: 5.86557,
      10: 6.55555,
      11: 7.24989,
      12: 7.94826,
      13: 8.65119,
      14: 9.35778,
      15: 10.06726,
      16: 10.79019,
      17: 11.53007,
      18: 12.29598,
      19: 13.08480,
      20: 13.90325
    },
    43: {
      1: 0.63815,
      2: 1.29366,
      3: 1.96621,
      4: 2.65285,
      5: 3.34977,
      6: 4.05388,
      7: 4.76316,
      8: 5.47585,
      9: 6.19295,
      10: 6.91459,
      11: 7.64040,
      12: 8.37096,
      13: 9.10533,
      14: 9.84270,
      15: 10.59404,
      16: 11.36300,
      17: 12.15902,
      18: 12.97885,
      19: 13.82946,
      20: 14.70721
    },
    44: {
      1: 0.68152,
      2: 1.38076,
      3: 2.09464,
      4: 2.81921,
      5: 3.55126,
      6: 4.28869,
      7: 5.02965,
      8: 5.77521,
      9: 6.52548,
      10: 7.28010,
      11: 8.03964,
      12: 8.80315,
      13: 9.56978,
      14: 10.35093,
      15: 11.15041,
      16: 11.97801,
      17: 12.83037,
      18: 13.71474,
      19: 14.62732,
      20: 15.56409
    },
    45: {
      1: 0.72726,
      2: 1.46975,
      3: 2.22335,
      4: 2.98473,
      5: 3.75171,
      6: 4.52237,
      7: 5.29780,
      8: 6.07813,
      9: 6.86299,
      10: 7.65297,
      11: 8.44707,
      12: 9.24442,
      13: 10.05688,
      14: 10.88839,
      15: 11.74916,
      16: 12.63567,
      17: 13.55548,
      18: 14.50462,
      19: 15.47893,
      20: 16.48416
    },
    46: {
      1: 0.77255,
      2: 1.55666,
      3: 2.34887,
      4: 3.14690,
      5: 3.94876,
      6: 4.75558,
      7: 5.56751,
      8: 6.38414,
      9: 7.20611,
      10: 8.03236,
      11: 8.86198,
      12: 9.70733,
      13: 10.57251,
      14: 11.46812,
      15: 12.39053,
      16: 13.34757,
      17: 14.33514,
      18: 15.34890,
      19: 16.39483,
      20: 17.46756
    },
    47: {
      1: 0.81618,
      2: 1.64078,
      3: 2.47145,
      4: 3.30610,
      5: 4.14591,
      6: 4.99105,
      7: 5.84108,
      8: 6.69665,
      9: 7.55669,
      10: 8.42025,
      11: 9.30017,
      12: 10.20072,
      13: 11.13297,
      14: 12.09309,
      15: 13.08927,
      16: 14.11723,
      17: 15.17245,
      18: 16.26115,
      19: 17.37775,
      20: 18.51926
    },
    48: {
      1: 0.85865,
      2: 1.72362,
      3: 2.59273,
      4: 3.46722,
      5: 4.34725,
      6: 5.23237,
      7: 6.12328,
      8: 7.01883,
      9: 7.91804,
      10: 8.83429,
      11: 9.77203,
      12: 10.74277,
      13: 11.74253,
      14: 12.77985,
      15: 13.85026,
      16: 14.94904,
      17: 16.08269,
      18: 17.24540,
      19: 18.43404,
      20: 19.63393
    },
    49: {
      1: 0.90101,
      2: 1.80634,
      3: 2.71728,
      4: 3.63398,
      5: 4.55600,
      6: 5.48403,
      7: 6.41690,
      8: 7.35359,
      9: 8.30802,
      10: 9.28484,
      11: 10.29603,
      12: 11.33747,
      13: 12.41801,
      14: 13.53303,
      15: 14.67760,
      16: 15.85850,
      17: 17.06966,
      18: 18.30784,
      19: 19.55773,
      20: 20.81801
    },
    50: {
      1: 0.94341,
      2: 1.89266,
      3: 2.84792,
      4: 3.80871,
      5: 4.77578,
      6: 5.74789,
      7: 6.72397,
      8: 7.71854,
      9: 8.73645,
      10: 9.79017,
      11: 10.87540,
      12: 12.00140,
      13: 13.16331,
      14: 14.35602,
      15: 15.58659,
      16: 16.84869,
      17: 18.13894,
      18: 19.44140,
      19: 20.75469,
      20: 22.07680
    },
    51: {
      1: 0.98954,
      2: 1.98534,
      3: 2.98691,
      4: 3.99503,
      5: 5.00839,
      6: 6.02591,
      7: 7.06270,
      8: 8.12381,
      9: 9.22225,
      10: 10.35354,
      11: 11.52733,
      12: 12.73855,
      13: 13.98189,
      14: 15.26469,
      15: 16.58036,
      16: 17.92537,
      17: 19.28312,
      18: 20.65215,
      19: 22.03037,
      20: 23.41636
    },
    52: {
      1: 1.03849,
      2: 2.08299,
      3: 3.13431,
      4: 4.19112,
      5: 5.25224,
      6: 6.33347,
      7: 7.44006,
      8: 8.58559,
      9: 9.76537,
      10: 10.98947,
      11: 12.25261,
      12: 13.54924,
      13: 14.88702,
      14: 16.25909,
      15: 17.66175,
      16: 19.07769,
      17: 20.50541,
      18: 21.94270,
      19: 23.38810,
      20: 24.83927
    },
    53: {
      1: 1.08974,
      2: 2.18659,
      3: 3.28916,
      4: 4.39624,
      5: 5.52430,
      6: 6.67881,
      7: 7.87395,
      8: 9.10483,
      9: 10.38194,
      10: 11.69978,
      11: 13.05257,
      12: 14.44828,
      13: 15.87977,
      14: 17.34318,
      15: 18.82044,
      16: 20.30999,
      17: 21.80953,
      18: 23.31752,
      19: 24.83154,
      20: 26.34740
    },
    54: {
      1: 1.14487,
      2: 2.29570,
      3: 3.45124,
      4: 4.62868,
      5: 5.83373,
      6: 7.08118,
      7: 8.36594,
      8: 9.69896,
      9: 11.07449,
      10: 12.48649,
      11: 13.94331,
      12: 15.43745,
      13: 16.96493,
      14: 18.50685,
      15: 20.06160,
      16: 21.62679,
      17: 23.20079,
      18: 24.78108,
      19: 26.36330,
      20: 27.94316
    },
    55: {
      1: 1.20179,
      2: 2.40849,
      3: 3.63806,
      4: 4.89647,
      5: 6.19915,
      6: 7.54080,
      7: 8.93283,
      8: 10.36927,
      9: 11.84379,
      10: 13.36510,
      11: 14.92541,
      12: 16.52051,
      13: 18.13071,
      14: 19.75429,
      15: 21.38878,
      16: 23.03247,
      17: 24.68273,
      18: 26.33500,
      19: 27.98482,
      20: 29.62858
    },
    56: {
      1: 1.26076,
      2: 2.54540,
      3: 3.86018,
      4: 5.22122,
      5: 6.62297,
      6: 8.07736,
      7: 9.57814,
      8: 11.11871,
      9: 12.70817,
      10: 14.33837,
      11: 16.00492,
      12: 17.68725,
      13: 19.38356,
      14: 21.09127,
      15: 22.80859,
      16: 24.53277,
      17: 26.25906,
      18: 27.98278,
      19: 29.70017,
      20: 31.40873
    },
    57: {
      1: 1.34288,
      2: 2.71727,
      3: 4.14000,
      4: 5.60529,
      5: 7.12561,
      6: 8.69443,
      7: 10.30484,
      8: 11.96636,
      9: 13.67046,
      10: 15.41256,
      11: 17.17116,
      12: 18.94437,
      13: 20.72949,
      14: 22.52466,
      15: 24.32701,
      16: 26.13155,
      17: 27.93341,
      18: 29.72866,
      19: 31.51468,
      20: 33.28912
    },
    58: {
      1: 1.43772,
      2: 2.92602,
      3: 4.45884,
      4: 6.04922,
      5: 7.69033,
      6: 9.37496,
      7: 11.11304,
      8: 12.89567,
      9: 14.71806,
      10: 16.55770,
      11: 18.41262,
      12: 20.28001,
      13: 22.15790,
      14: 24.04331,
      15: 25.93102,
      16: 27.81591,
      17: 29.69390,
      18: 31.56222,
      19: 33.41843,
      20: 35.25843
    },
    59: {
      1: 1.55818,
      2: 3.16296,
      3: 4.82802,
      4: 6.54618,
      5: 8.30990,
      6: 10.12959,
      7: 11.99592,
      8: 13.90387,
      9: 15.82988,
      10: 17.77190,
      11: 19.72695,
      12: 21.69302,
      13: 23.66695,
      14: 25.64329,
      15: 27.61668,
      16: 29.58284,
      17: 31.53888,
      18: 33.48224,
      19: 35.40863,
      20: 37.31539
    },
    60: {
      1: 1.68190,
      2: 3.42697,
      3: 5.22771,
      4: 7.07618,
      5: 8.98332,
      6: 10.93933,
      7: 12.93897,
      8: 14.95753,
      9: 16.99288,
      10: 19.04189,
      11: 21.10244,
      12: 23.17122,
      13: 25.24253,
      14: 27.31076,
      15: 29.37140,
      16: 31.42144,
      17: 33.45819,
      18: 35.47716,
      19: 37.47554,
      20: 39.45424
    },
    61: {
      1: 1.83091,
      2: 3.72023,
      3: 5.65963,
      4: 7.66059,
      5: 9.71282,
      6: 11.81083,
      7: 13.92869,
      8: 16.06416,
      9: 18.21396,
      10: 20.37587,
      11: 22.54643,
      12: 24.71963,
      13: 26.88960,
      14: 29.05161,
      15: 31.20249,
      16: 33.33944,
      17: 35.45772,
      18: 37.55441,
      19: 39.63044,
      20: 41.68678
    },
    62: {
      1: 1.98485,
      2: 4.02232,
      3: 6.12445,
      4: 8.28045,
      5: 10.48454,
      6: 12.70949,
      7: 14.95294,
      8: 17.21145,
      9: 19.48268,
      10: 21.76299,
      11: 24.04607,
      12: 26.32577,
      13: 28.59710,
      14: 30.85674,
      15: 33.10174,
      16: 35.32713,
      17: 37.52984,
      18: 39.71085,
      19: 41.87116,
      20: 44.00743
    },
    63: {
      1: 2.14339,
      2: 4.35480,
      3: 6.62289,
      4: 8.94156,
      5: 11.28218,
      6: 13.64225,
      7: 16.01817,
      8: 18.40747,
      9: 20.80632,
      10: 23.20810,
      11: 25.60631,
      12: 27.99571,
      13: 30.37283,
      14: 32.73453,
      15: 35.07561,
      16: 37.39283,
      17: 39.68722,
      18: 41.95984,
      19: 44.20717,
      20: 46.41784
    },
    64: {
      1: 2.32962,
      2: 4.71895,
      3: 7.16156,
      4: 9.62729,
      5: 12.11352,
      6: 14.61644,
      7: 17.13346,
      8: 19.66054,
      9: 22.19070,
      10: 24.71710,
      11: 27.23423,
      12: 29.73841,
      13: 32.22636,
      14: 34.69258,
      15: 37.13367,
      16: 39.55070,
      17: 41.94480,
      18: 44.31225,
      19: 46.64110,
      20: 48.91218
    },
    65: {
      1: 2.52118,
      2: 5.09858,
      3: 7.70038,
      4: 10.32381,
      5: 12.96485,
      6: 15.62077,
      7: 18.28730,
      8: 20.95709,
      9: 23.62290,
      10: 26.27894,
      11: 28.92130,
      12: 31.54655,
      13: 34.14886,
      14: 36.72466,
      15: 39.27507,
      16: 41.80128,
      17: 44.29938,
      18: 46.75674,
      19: 49.15315,
      20: 51.46516
    }
  };
  Map<int, Map<int, double>> tauxAnnuel = {
    18: {
      1: 0.27220,
      2: 0.28084,
      3: 0.28705,
      4: 0.29164,
      5: 0.29506,
      6: 0.29779,
      7: 0.30020,
      8: 0.30242,
      9: 0.30465,
      10: 0.30691,
      11: 0.30916,
      12: 0.31144,
      13: 0.31370,
      14: 0.31590,
      15: 0.31823,
      16: 0.32078,
      17: 0.32371,
      18: 0.32693,
      19: 0.33050,
      20: 0.33437
    },
    19: {
      1: 0.28978,
      2: 0.29488,
      3: 0.29860,
      4: 0.30131,
      5: 0.30348,
      6: 0.30548,
      7: 0.30739,
      8: 0.30940,
      9: 0.31151,
      10: 0.31364,
      11: 0.31584,
      12: 0.31804,
      13: 0.32019,
      14: 0.32249,
      15: 0.32505,
      16: 0.32803,
      17: 0.33132,
      18: 0.33498,
      19: 0.33897,
      20: 0.34333
    },
    20: {
      1: 0.30015,
      2: 0.30325,
      3: 0.30544,
      4: 0.30722,
      5: 0.30897,
      6: 0.31071,
      7: 0.31263,
      8: 0.31469,
      9: 0.31680,
      10: 0.31900,
      11: 0.32120,
      12: 0.32337,
      13: 0.32570,
      14: 0.32832,
      15: 0.33139,
      16: 0.33480,
      17: 0.33860,
      18: 0.34276,
      19: 0.34730,
      20: 0.35228
    },
    21: {
      1: 0.30645,
      2: 0.30822,
      3: 0.30975,
      4: 0.31138,
      5: 0.31306,
      6: 0.31499,
      7: 0.31708,
      8: 0.31924,
      9: 0.32150,
      10: 0.32376,
      11: 0.32597,
      12: 0.32837,
      13: 0.33108,
      14: 0.33429,
      15: 0.33785,
      16: 0.34183,
      17: 0.34618,
      18: 0.35093,
      19: 0.35614,
      20: 0.36186
    },
    22: {
      1: 0.31006,
      2: 0.31150,
      3: 0.31314,
      4: 0.31486,
      5: 0.31689,
      6: 0.31909,
      7: 0.32135,
      8: 0.32370,
      9: 0.32605,
      10: 0.32834,
      11: 0.33083,
      12: 0.33366,
      13: 0.33702,
      14: 0.34076,
      15: 0.34494,
      16: 0.34951,
      17: 0.35450,
      18: 0.35997,
      19: 0.36597,
      20: 0.37261
    },
    23: {
      1: 0.31298,
      2: 0.31477,
      3: 0.31658,
      4: 0.31875,
      5: 0.32110,
      6: 0.32348,
      7: 0.32595,
      8: 0.32840,
      9: 0.33077,
      10: 0.33335,
      11: 0.33631,
      12: 0.33984,
      13: 0.34377,
      14: 0.34818,
      15: 0.35298,
      16: 0.35822,
      17: 0.36397,
      18: 0.37028,
      19: 0.37726,
      20: 0.38481
    },
    24: {
      1: 0.31663,
      2: 0.31848,
      3: 0.32082,
      4: 0.32331,
      5: 0.32581,
      6: 0.32839,
      7: 0.33093,
      8: 0.33337,
      9: 0.33605,
      10: 0.33914,
      11: 0.34285,
      12: 0.34700,
      13: 0.35163,
      14: 0.35669,
      15: 0.36221,
      16: 0.36825,
      17: 0.37488,
      18: 0.38221,
      19: 0.39014,
      20: 0.39865
    },
    25: {
      1: 0.32041,
      2: 0.32303,
      3: 0.32571,
      4: 0.32833,
      5: 0.33101,
      6: 0.33363,
      7: 0.33613,
      8: 0.33889,
      9: 0.34213,
      10: 0.34604,
      11: 0.35041,
      12: 0.35530,
      13: 0.36063,
      14: 0.36644,
      15: 0.37280,
      16: 0.37977,
      17: 0.38748,
      18: 0.39581,
      19: 0.40475,
      20: 0.41422
    },
    26: {
      1: 0.32575,
      2: 0.32851,
      3: 0.33116,
      4: 0.33391,
      5: 0.33658,
      6: 0.33910,
      7: 0.34194,
      8: 0.34531,
      9: 0.34944,
      10: 0.35405,
      11: 0.35921,
      12: 0.36484,
      13: 0.37096,
      14: 0.37766,
      15: 0.38500,
      16: 0.39312,
      17: 0.40187,
      18: 0.41126,
      19: 0.42120,
      20: 0.43166
    },
    27: {
      1: 0.33136,
      2: 0.33402,
      3: 0.33684,
      4: 0.33954,
      5: 0.34207,
      6: 0.34500,
      7: 0.34853,
      8: 0.35291,
      9: 0.35780,
      10: 0.36328,
      11: 0.36923,
      12: 0.37570,
      13: 0.38277,
      14: 0.39051,
      15: 0.39906,
      16: 0.40827,
      17: 0.41814,
      18: 0.42858,
      19: 0.43954,
      20: 0.45089
    },
    28: {
      1: 0.33677,
      2: 0.33973,
      3: 0.34247,
      4: 0.34500,
      5: 0.34803,
      6: 0.35178,
      7: 0.35646,
      8: 0.36168,
      9: 0.36751,
      10: 0.37383,
      11: 0.38068,
      12: 0.38816,
      13: 0.39633,
      14: 0.40535,
      15: 0.41506,
      16: 0.42544,
      17: 0.43640,
      18: 0.44791,
      19: 0.45979,
      20: 0.47190
    },
    29: {
      1: 0.34280,
      2: 0.34548,
      3: 0.34795,
      4: 0.35111,
      5: 0.35512,
      6: 0.36018,
      7: 0.36579,
      8: 0.37203,
      9: 0.37875,
      10: 0.38602,
      11: 0.39393,
      12: 0.40257,
      13: 0.41210,
      14: 0.42234,
      15: 0.43326,
      16: 0.44479,
      17: 0.45686,
      18: 0.46932,
      19: 0.48198,
      20: 0.49475
    },
    30: {
      1: 0.34826,
      2: 0.35067,
      3: 0.35409,
      4: 0.35849,
      5: 0.36405,
      6: 0.37013,
      7: 0.37685,
      8: 0.38402,
      9: 0.39176,
      10: 0.40015,
      11: 0.40930,
      12: 0.41937,
      13: 0.43018,
      14: 0.44168,
      15: 0.45380,
      16: 0.46648,
      17: 0.47953,
      18: 0.49277,
      19: 0.50609,
      20: 0.51943
    },
    31: {
      1: 0.35316,
      2: 0.35717,
      3: 0.36215,
      4: 0.36837,
      5: 0.37500,
      6: 0.38225,
      7: 0.38992,
      8: 0.39814,
      9: 0.40705,
      10: 0.41672,
      11: 0.42738,
      12: 0.43878,
      13: 0.45090,
      14: 0.46364,
      15: 0.47693,
      16: 0.49060,
      17: 0.50444,
      18: 0.51834,
      19: 0.53223,
      20: 0.54608
    },
    32: {
      1: 0.36133,
      2: 0.36690,
      3: 0.37383,
      4: 0.38098,
      5: 0.38873,
      6: 0.39687,
      7: 0.40556,
      8: 0.41496,
      9: 0.42517,
      10: 0.43641,
      11: 0.44842,
      12: 0.46116,
      13: 0.47454,
      14: 0.48847,
      15: 0.50277,
      16: 0.51722,
      17: 0.53170,
      18: 0.54615,
      19: 0.56053,
      20: 0.57492
    },
    33: {
      1: 0.37268,
      2: 0.38042,
      3: 0.38802,
      4: 0.39623,
      5: 0.40480,
      6: 0.41393,
      7: 0.42382,
      8: 0.43455,
      9: 0.44640,
      10: 0.45903,
      11: 0.47242,
      12: 0.48644,
      13: 0.50103,
      14: 0.51597,
      15: 0.53105,
      16: 0.54612,
      17: 0.56112,
      18: 0.57603,
      19: 0.59095,
      20: 0.60591
    },
    34: {
      1: 0.38845,
      2: 0.39613,
      3: 0.40467,
      4: 0.41359,
      5: 0.42313,
      6: 0.43349,
      7: 0.44477,
      8: 0.45724,
      9: 0.47052,
      10: 0.48458,
      11: 0.49928,
      12: 0.51455,
      13: 0.53015,
      14: 0.54585,
      15: 0.56152,
      16: 0.57709,
      17: 0.59254,
      18: 0.60797,
      19: 0.62344,
      20: 0.63897
    },
    35: {
      1: 0.40409,
      2: 0.41324,
      3: 0.42261,
      4: 0.43263,
      5: 0.44354,
      6: 0.45543,
      7: 0.46861,
      8: 0.48260,
      9: 0.49738,
      10: 0.51281,
      11: 0.52879,
      12: 0.54508,
      13: 0.56144,
      14: 0.57772,
      15: 0.59387,
      16: 0.60986,
      17: 0.62582,
      18: 0.64181,
      19: 0.65785,
      20: 0.67400
    },
    36: {
      1: 0.42275,
      2: 0.43239,
      3: 0.44286,
      4: 0.45435,
      5: 0.46689,
      6: 0.48083,
      7: 0.49558,
      8: 0.51113,
      9: 0.52730,
      10: 0.54402,
      11: 0.56103,
      12: 0.57805,
      13: 0.59494,
      14: 0.61166,
      15: 0.62819,
      16: 0.64467,
      17: 0.66118,
      18: 0.67773,
      19: 0.69439,
      20: 0.71115
    },
    37: {
      1: 0.44240,
      2: 0.45350,
      3: 0.46569,
      4: 0.47900,
      5: 0.49380,
      6: 0.50939,
      7: 0.52575,
      8: 0.54272,
      9: 0.56021,
      10: 0.57794,
      11: 0.59563,
      12: 0.61314,
      13: 0.63043,
      14: 0.64749,
      15: 0.66449,
      16: 0.68149,
      17: 0.69855,
      18: 0.71572,
      19: 0.73299,
      20: 0.75035
    },
    38: {
      1: 0.46502,
      2: 0.47801,
      3: 0.49214,
      4: 0.50790,
      5: 0.52436,
      6: 0.54156,
      7: 0.55933,
      8: 0.57760,
      9: 0.59605,
      10: 0.61440,
      11: 0.63251,
      12: 0.65034,
      13: 0.66791,
      14: 0.68539,
      15: 0.70288,
      16: 0.72042,
      17: 0.73809,
      18: 0.75587,
      19: 0.77373,
      20: 0.79237
    },
    39: {
      1: 0.49150,
      2: 0.50648,
      3: 0.52330,
      4: 0.54065,
      5: 0.55869,
      6: 0.57724,
      7: 0.59627,
      8: 0.61542,
      9: 0.63439,
      10: 0.65306,
      11: 0.67140,
      12: 0.68943,
      13: 0.70737,
      14: 0.72532,
      15: 0.74332,
      16: 0.76147,
      17: 0.77973,
      18: 0.79810,
      19: 0.81730,
      20: 0.83752
    },
    40: {
      1: 0.52204,
      2: 0.54013,
      3: 0.55831,
      4: 0.57714,
      5: 0.59643,
      6: 0.61618,
      7: 0.63599,
      8: 0.65554,
      9: 0.67471,
      10: 0.69350,
      11: 0.71195,
      12: 0.73031,
      13: 0.74869,
      14: 0.76713,
      15: 0.78573,
      16: 0.80447,
      17: 0.82333,
      18: 0.84309,
      19: 0.86395,
      20: 0.88646
    },
    41: {
      1: 0.55891,
      2: 0.57750,
      3: 0.59695,
      4: 0.61688,
      5: 0.63727,
      6: 0.65767,
      7: 0.67773,
      8: 0.69733,
      9: 0.71652,
      10: 0.73533,
      11: 0.75406,
      12: 0.77283,
      13: 0.79168,
      14: 0.81072,
      15: 0.82992,
      16: 0.84926,
      17: 0.86958,
      18: 0.89110,
      19: 0.91438,
      20: 0.93912
    },
    42: {
      1: 0.59682,
      2: 0.61709,
      3: 0.63774,
      4: 0.65882,
      5: 0.67982,
      6: 0.70036,
      7: 0.72036,
      8: 0.73991,
      9: 0.75905,
      10: 0.77813,
      11: 0.79727,
      12: 0.81652,
      13: 0.83601,
      14: 0.85567,
      15: 0.87550,
      16: 0.89640,
      17: 0.91859,
      18: 0.94270,
      19: 0.96835,
      20: 0.99597
    },
    43: {
      1: 0.63815,
      2: 0.65941,
      3: 0.68115,
      4: 0.70267,
      5: 0.72360,
      6: 0.74393,
      7: 0.76375,
      8: 0.78317,
      9: 0.80255,
      10: 0.82204,
      11: 0.84168,
      12: 0.86159,
      13: 0.88172,
      14: 0.90204,
      15: 0.92354,
      16: 0.94645,
      17: 0.97141,
      18: 0.99805,
      19: 1.02677,
      20: 1.05723
    },
    44: {
      1: 0.68152,
      2: 0.70394,
      3: 0.72591,
      4: 0.74715,
      5: 0.76770,
      6: 0.78774,
      7: 0.80737,
      8: 0.82702,
      9: 0.84685,
      10: 0.86688,
      11: 0.88723,
      12: 0.90784,
      13: 0.92866,
      14: 0.95080,
      15: 0.97446,
      16: 1.00035,
      17: 1.02803,
      18: 1.05794,
      19: 1.08969,
      20: 1.12292
    },
    45: {
      1: 0.72726,
      2: 0.74945,
      3: 0.77081,
      4: 0.79147,
      5: 0.81164,
      6: 0.83143,
      7: 0.85134,
      8: 0.87150,
      9: 0.89193,
      10: 0.91275,
      11: 0.93386,
      12: 0.95522,
      13: 0.97803,
      14: 1.00251,
      15: 1.02941,
      16: 1.05821,
      17: 1.08941,
      18: 1.12254,
      19: 1.15724,
      20: 1.19388
    },
    46: {
      1: 0.77255,
      2: 0.79393,
      3: 0.81464,
      4: 0.83494,
      5: 0.85490,
      6: 0.87510,
      7: 0.89565,
      8: 0.91653,
      9: 0.93787,
      10: 0.95954,
      11: 0.98149,
      12: 1.00505,
      13: 1.03042,
      14: 1.05842,
      15: 1.08846,
      16: 1.12105,
      17: 1.15570,
      18: 1.19198,
      19: 1.23031,
      20: 1.27025
    },
    47: {
      1: 0.81618,
      2: 0.83699,
      3: 0.85746,
      4: 0.87765,
      5: 0.89822,
      6: 0.91925,
      7: 0.94066,
      8: 0.96260,
      9: 0.98491,
      10: 1.00752,
      11: 1.03190,
      12: 1.05827,
      13: 1.08749,
      14: 1.11888,
      15: 1.15301,
      16: 1.18930,
      17: 1.22730,
      18: 1.26745,
      19: 1.30928,
      20: 1.35259
    },
    48: {
      1: 0.85865,
      2: 0.87940,
      3: 0.89987,
      4: 0.92091,
      5: 0.94252,
      6: 0.96456,
      7: 0.98718,
      8: 1.01020,
      9: 1.03352,
      10: 1.05882,
      11: 1.08629,
      12: 1.11686,
      13: 1.14974,
      14: 1.18554,
      15: 1.22363,
      16: 1.26348,
      17: 1.30560,
      18: 1.34946,
      19: 1.39485,
      20: 1.44072
    },
    49: {
      1: 0.90101,
      2: 0.92177,
      3: 0.94343,
      4: 0.96573,
      5: 0.98849,
      6: 1.01188,
      7: 1.03568,
      8: 1.05978,
      9: 1.08608,
      10: 1.11476,
      11: 1.14682,
      12: 1.18134,
      13: 1.21897,
      14: 1.25900,
      15: 1.30085,
      16: 1.34508,
      17: 1.39113,
      18: 1.43874,
      19: 1.48682,
      20: 1.53539
    },
    50: {
      1: 0.94341,
      2: 0.96600,
      3: 0.98916,
      4: 1.01274,
      5: 1.03697,
      6: 1.06159,
      7: 1.08651,
      8: 1.11391,
      9: 1.14393,
      10: 1.17763,
      11: 1.21395,
      12: 1.25358,
      13: 1.29572,
      14: 1.33974,
      15: 1.38624,
      16: 1.43462,
      17: 1.48461,
      18: 1.53501,
      19: 1.58590,
      20: 1.63727
    },
    51: {
      1: 0.98954,
      2: 1.01350,
      3: 1.03785,
      4: 1.06292,
      5: 1.08837,
      6: 1.11409,
      7: 1.14267,
      8: 1.17414,
      9: 1.20965,
      10: 1.24794,
      11: 1.28976,
      12: 1.33418,
      13: 1.38053,
      14: 1.42947,
      15: 1.48033,
      16: 1.53285,
      17: 1.58573,
      18: 1.63905,
      19: 1.69285,
      20: 1.74717
    },
    52: {
      1: 1.03849,
      2: 1.06357,
      3: 1.08952,
      4: 1.11580,
      5: 1.14234,
      6: 1.17222,
      7: 1.20533,
      8: 1.24288,
      9: 1.28335,
      10: 1.32758,
      11: 1.37450,
      12: 1.42336,
      13: 1.47492,
      14: 1.52845,
      15: 1.58366,
      16: 1.63915,
      17: 1.69505,
      18: 1.75139,
      19: 1.80826,
      20: 1.86566
    },
    53: {
      1: 1.08974,
      2: 1.11671,
      3: 1.14386,
      4: 1.17120,
      5: 1.20260,
      6: 1.23758,
      7: 1.27748,
      8: 1.32040,
      9: 1.36730,
      10: 1.41696,
      11: 1.46854,
      12: 1.52292,
      13: 1.57929,
      14: 1.63735,
      15: 1.69561,
      16: 1.75421,
      17: 1.81323,
      18: 1.87276,
      19: 1.93283,
      20: 1.99330
    },
    54: {
      1: 1.14487,
      2: 1.17271,
      3: 1.20079,
      4: 1.23400,
      5: 1.27121,
      6: 1.31384,
      7: 1.35953,
      8: 1.40940,
      9: 1.46205,
      10: 1.51656,
      11: 1.57396,
      12: 1.63335,
      13: 1.69444,
      14: 1.75560,
      15: 1.81703,
      16: 1.87883,
      17: 1.94114,
      18: 2.00399,
      19: 2.06726,
      20: 2.13082
    },
    55: {
      1: 1.20179,
      2: 1.23063,
      3: 1.26641,
      4: 1.30641,
      5: 1.35233,
      6: 1.40118,
      7: 1.45437,
      8: 1.51029,
      9: 1.56795,
      10: 1.62856,
      11: 1.69115,
      12: 1.75543,
      13: 1.81961,
      14: 1.88397,
      15: 1.94866,
      16: 2.01385,
      17: 2.07958,
      18: 2.14574,
      19: 2.21221,
      20: 2.27895
    },
    56: {
      1: 1.26076,
      2: 1.30091,
      3: 1.34449,
      4: 1.39433,
      5: 1.44668,
      6: 1.50350,
      7: 1.56288,
      8: 1.62382,
      9: 1.68778,
      10: 1.75368,
      11: 1.82125,
      12: 1.88853,
      13: 1.95589,
      14: 2.02353,
      15: 2.09165,
      16: 2.16034,
      17: 2.22947,
      18: 2.29894,
      19: 2.36870,
      20: 2.43880
    },
    57: {
      1: 1.34288,
      2: 1.38923,
      3: 1.44300,
      4: 1.49865,
      5: 1.55901,
      6: 1.62180,
      7: 1.68591,
      8: 1.75317,
      9: 1.82237,
      10: 1.89322,
      11: 1.96357,
      12: 2.03390,
      13: 2.10448,
      14: 2.17554,
      15: 2.24721,
      16: 2.31935,
      17: 2.39187,
      18: 2.46472,
      19: 2.53798,
      20: 2.61168
    },
    58: {
      1: 1.43772,
      2: 1.49657,
      3: 1.55549,
      4: 1.61954,
      5: 1.68575,
      6: 1.75301,
      7: 1.82360,
      8: 1.89612,
      9: 1.97028,
      10: 2.04371,
      11: 2.11702,
      12: 2.19053,
      13: 2.26457,
      14: 2.33925,
      15: 2.41446,
      16: 2.49010,
      17: 2.56614,
      18: 2.64265,
      19: 2.71970,
      20: 2.79720
    },
    59: {
      1: 1.55818,
      2: 1.61859,
      3: 1.68602,
      4: 1.75538,
      5: 1.82552,
      6: 1.89935,
      7: 1.97515,
      8: 2.05260,
      9: 2.12904,
      10: 2.20527,
      11: 2.28169,
      12: 2.35869,
      13: 2.43641,
      14: 2.51475,
      15: 2.59358,
      16: 2.67289,
      17: 2.75276,
      18: 2.83327,
      19: 2.91435,
      20: 2.99602
    },
    60: {
      1: 1.68190,
      2: 1.75462,
      3: 1.82764,
      4: 1.90079,
      5: 1.97809,
      6: 2.05733,
      7: 2.13823,
      8: 2.21775,
      9: 2.29694,
      10: 2.37632,
      11: 2.45635,
      12: 2.53720,
      13: 2.61875,
      14: 2.70089,
      15: 2.78361,
      16: 2.86699,
      17: 2.95115,
      18: 3.03598,
      19: 3.12154,
      20: 3.20814
    },
    61: {
      1: 1.83091,
      2: 1.90598,
      3: 1.98118,
      4: 2.06173,
      5: 2.14429,
      6: 2.22857,
      7: 2.31103,
      8: 2.39307,
      9: 2.47534,
      10: 2.55837,
      11: 2.64237,
      12: 2.72720,
      13: 2.81272,
      14: 2.89895,
      15: 2.98598,
      16: 3.07393,
      17: 3.16270,
      18: 3.25235,
      19: 3.34322,
      20: 3.43564
    },
    62: {
      1: 1.98485,
      2: 2.06211,
      3: 2.14672,
      4: 2.23308,
      5: 2.32105,
      6: 2.40653,
      7: 2.49147,
      8: 2.57669,
      9: 2.66282,
      10: 2.75009,
      11: 2.83834,
      12: 2.92742,
      13: 3.01734,
      14: 3.10821,
      15: 3.20018,
      16: 3.29313,
      17: 3.38712,
      18: 3.48256,
      19: 3.57977,
      20: 3.67871
    },
    63: {
      1: 2.14339,
      2: 2.23408,
      3: 2.32474,
      4: 2.41664,
      5: 2.50503,
      6: 2.59276,
      7: 2.68090,
      8: 2.77016,
      9: 2.86078,
      10: 2.95257,
      11: 3.04535,
      12: 3.13913,
      13: 3.23405,
      14: 3.33025,
      15: 3.42762,
      16: 3.52624,
      17: 3.62653,
      18: 3.72887,
      19: 3.83322,
      20: 3.93885
    },
    64: {
      1: 2.32962,
      2: 2.42283,
      3: 2.51784,
      4: 2.60824,
      5: 2.69821,
      6: 2.78894,
      7: 2.88119,
      8: 2.97515,
      9: 3.07052,
      10: 3.16710,
      11: 3.26488,
      12: 3.36402,
      13: 3.46467,
      14: 3.56671,
      15: 3.67022,
      16: 3.77568,
      17: 3.88352,
      18: 3.99366,
      19: 4.10533,
      20: 4.21715
    },
    65: {
      1: 2.52118,
      2: 2.61990,
      3: 2.71178,
      4: 2.80383,
      5: 2.89725,
      6: 2.99269,
      7: 3.09025,
      8: 3.18950,
      9: 3.29018,
      10: 3.39227,
      11: 3.49595,
      12: 3.60140,
      13: 3.70846,
      14: 3.81725,
      15: 3.92830,
      16: 4.04206,
      17: 4.15849,
      18: 4.27671,
      19: 4.39524,
      20: 4.51235
    }
  };
  @override
  void dispose() {
    _capitalController.dispose();
    _dureeController.dispose();
    _dateNaissanceController.dispose();
    super.dispose();
  }

  String _formatNumber(double number) {
    return number.toStringAsFixed(0).replaceAllMapped(
          RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
          (Match m) => '${m[1]} ',
        );
  }

  void _formatMontantInput() {
    final text = _capitalController.text.replaceAll(' ', '');
    if (text.isNotEmpty) {
      final value = double.tryParse(text);
      if (value != null) {
        _capitalController.text = _formatNumber(value);
        _capitalController.selection = TextSelection.fromPosition(
          TextPosition(offset: _capitalController.text.length),
        );
      }
    }
  }

  double _parseDouble(String text) {
    final cleaned = text.replaceAll(' ', '').replaceAll(',', '.');
    return double.tryParse(cleaned) ?? 0.0;
  }

  int _parseInt(String text) {
    final cleaned = text.replaceAll(' ', '');
    return int.tryParse(cleaned) ?? 0;
  }

  void _resetSimulation() {
    setState(() {
      _capitalController.clear();
      _dureeController.clear();
      _dateNaissanceController.clear();
      periodicite = 'annuel';
      result = null;
      age = null;
    });
  }

  void _calculateAge() {
    if (_dateNaissanceController.text.isEmpty) {
      setState(() => age = null);
      return;
    }

    try {
      DateTime dateNaissance =
          DateFormat('dd/MM/yyyy').parse(_dateNaissanceController.text);
      DateTime currentDate = DateTime.now();
      int calculatedAge = currentDate.year - dateNaissance.year;
      if (currentDate.month < dateNaissance.month ||
          (currentDate.month == dateNaissance.month &&
              currentDate.day < dateNaissance.day)) {
        calculatedAge--;
      }

      setState(() => age = calculatedAge);
    } catch (e) {
      setState(() => age = null);
    }
  }

  void _showProfessionalDialog({
    required String title,
    required String message,
    required IconData icon,
    required Color iconColor,
    required Color backgroundColor,
  }) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          elevation: 16,
          child: Container(
            constraints: BoxConstraints(
              maxWidth: MediaQuery.of(context).size.width * 0.9,
            ),
            padding: const EdgeInsets.all(28),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              color: Colors.white,
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Color.alphaBlend(
                      backgroundColor.withAlpha(25),
                      Colors.transparent,
                    ),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    icon,
                    size: 48,
                    color: iconColor,
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF002B6B),
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),
                Text(
                  message,
                  style: const TextStyle(
                    fontSize: 14,
                    color: Colors.black87,
                    height: 1.5,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 28),
                SizedBox(
                  width: double.infinity,
                  height: 48,
                  child: ElevatedButton(
                    onPressed: () => Navigator.of(context).pop(),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF002B6B),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 4,
                    ),
                    child: const Text(
                      'Compris',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  bool _validateInputs() {
    if (_capitalController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            'Veuillez renseigner le montant du capital √† garantir pour continuer la simulation.',
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (_dureeController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            'Veuillez renseigner la dur√©e du contrat pour continuer la simulation.',
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (_dateNaissanceController.text.trim().isEmpty) {
      _showProfessionalDialog(
        title: 'Champ obligatoire',
        message:
            "Veuillez renseigner la date de naissance de l'assur√© pour continuer la simulation.",
        icon: Icons.edit_outlined,
        iconColor: Colors.orange,
        backgroundColor: Colors.orange,
      );
      return false;
    }

    if (age == null || age! < 18 || age! > 65) {
      _showProfessionalDialog(
        title: '√Çge non admissible',
        message: "L'√¢ge doit √™tre compris entre 18 et 65 ans inclus.",
        icon: Icons.warning_amber_rounded,
        iconColor: Colors.red,
        backgroundColor: Colors.red,
      );
      return false;
    }

    return true;
  }

  Future<double> _findRateInTable({
    required int age,
    required int dureeAnnees,
  }) async {
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë üîç [FAMILIS] Recherche tarif                                ‚ïë');
    print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    print(
        '   üìä Param√®tres: age=$age, duree=$dureeAnnees ans, periodicite=$periodicite');

    // √âtape 1: Essayer de r√©cup√©rer depuis la base de donn√©es (serveur uniquement)
    print(
        '\n   üìç √âTAPE 1: Tentative r√©cup√©ration depuis BASE DE DONN√âES (serveur uniquement)...');
    try {
      final result = await _produitSyncService.getTarifWithSource(
        produitLibelle: 'CORIS FAMILIS',
        age: age,
        dureeContrat: dureeAnnees,
        periodicite: periodicite,
      );
      final tarifFromDB = result['tarif'] as TarifProduit?;

      if (tarifFromDB != null && tarifFromDB.prime != null) {
        print('   ‚úÖ Tarif trouv√© depuis le SERVEUR: ${tarifFromDB.prime}');
        print(
            '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        print(
            '‚ïë ‚úÖ [FAMILIS] Donn√©es utilis√©es depuis SERVEUR                 ‚ïë');
        print(
            '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
        return tarifFromDB.prime!;
      } else {
        print('   ‚ö†Ô∏è  Tarif non trouv√© dans la DB, utilisation du fallback');
      }
    } catch (e) {
      print(
          '   ‚ùå ERREUR lors de la r√©cup√©ration DB: $e, utilisation du fallback');
    }

    // √âtape 2: Fallback - Utiliser les donn√©es cod√©es en dur
    print('\n   üìç √âTAPE 2: Utilisation FALLBACK (donn√©es hardcod√©es)...');

    // √âtape 2: Fallback - Utiliser les donn√©es cod√©es en dur
    final Map<int, Map<int, double>> selectedTable =
        periodicite == 'unique' ? tauxUnique : tauxAnnuel;

    if (!selectedTable.containsKey(age)) {
      final ages = selectedTable.keys.toList()..sort();
      int closestAge = ages.first;
      for (int a in ages) {
        if (a >= age) {
          closestAge = a;
          break;
        }
      }
      if (closestAge > ages.last) closestAge = ages.last;
      age = closestAge;
    }

    if (!selectedTable[age]!.containsKey(dureeAnnees)) {
      final durees = selectedTable[age]!.keys.toList()..sort();
      int closestDuree = durees.first;
      for (int d in durees) {
        if (d >= dureeAnnees) {
          closestDuree = d;
          break;
        }
      }
      if (closestDuree > durees.last) closestDuree = durees.last;
      dureeAnnees = closestDuree;
    }

    final rate = selectedTable[age]![dureeAnnees]!;
    print('   ‚úÖ Tarif depuis FALLBACK (donn√©es hardcod√©es): $rate');
    print(
        '\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë ‚ö†Ô∏è  [FAMILIS] Donn√©es utilis√©es depuis FALLBACK               ‚ïë');
    print(
        '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    return rate;
  }

  void _simuler() async {
    if (!_validateInputs()) return;

    setState(() {
      isLoading = true;
      result = null;
    });

    await Future.delayed(const Duration(milliseconds: 500));

    try {
      final capital = _parseDouble(_capitalController.text);
      int dureeAnnees = _parseInt(_dureeController.text);

      final taux = await _findRateInTable(age: age!, dureeAnnees: dureeAnnees);
      final primeTotal = (capital * (taux / 100)).clamp(0, double.infinity);

      setState(() {
        result = {
          'primeTotal': primeTotal,
          'taux': taux,
        };
      });
    } catch (e) {
      _showProfessionalDialog(
        title: 'Erreur de calcul',
        message:
            'Une erreur est survenue lors du calcul. Veuillez v√©rifier vos donn√©es.\nD√©tail: $e',
        icon: Icons.error_outline,
        iconColor: rougeCoris,
        backgroundColor: rougeCoris,
      );
    }

    setState(() => isLoading = false);

    // Sauvegarder la simulation en base de donn√©es
    if (result != null && result!['primeTotal'] != null && result!['primeTotal'] > 0) {
      final capital = _parseDouble(_capitalController.text);
      int dureeAnnees = _parseInt(_dureeController.text);
      
      SimulationService.saveSimulation(
        produitNom: 'CORIS FAMILIS',
        typeSimulation: 'Par Capital',
        age: age,
        capital: capital,
        dureeMois: dureeAnnees * 12,
        periodicite: periodicite,
        resultatPrime: result!['primeTotal'],
      );
    }
  }

  Widget _buildModernHeader() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            bleuCoris,
            Color.alphaBlend(
              bleuCoris.withAlpha(204),
              Colors.transparent,
            ),
          ],
        ),
        boxShadow: [
          BoxShadow(
            color: bleuCoris.withAlpha(76),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
          child: Row(
            children: [
              IconButton(
                icon:
                    const Icon(Icons.arrow_back, color: Colors.white, size: 24),
                onPressed: () => Navigator.pop(context),
              ),
              const SizedBox(width: 12),
              const Icon(Icons.family_restroom, color: Colors.white, size: 32),
              const SizedBox(width: 12),
              const Expanded(
                child: Text(
                  "CORIS FAMILIS",
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: grisClairBg,
      body: Column(
        children: [
          _buildModernHeader(),
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Column(
                children: [
                  Container(
                    width: double.infinity,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withAlpha(25),
                          blurRadius: 12,
                          offset: const Offset(0, 6),
                        ),
                      ],
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(8),
                                decoration: BoxDecoration(
                                  color: bleuCoris.withAlpha(25),
                                  borderRadius: BorderRadius.circular(10),
                                ),
                                child: Icon(Icons.settings,
                                    color: bleuCoris, size: 22),
                              ),
                              const SizedBox(width: 12),
                              const Text(
                                "Param√®tres de simulation",
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  color: Color(0xFF002B6B),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 20),
                          _buildCapitalField(),
                          const SizedBox(height: 16),
                          _buildPeriodiciteDropdown(),
                          const SizedBox(height: 16),
                          _buildDureeField(),
                          const SizedBox(height: 16),
                          _buildDateNaissanceField(),
                          const SizedBox(height: 20),
                          SizedBox(
                            width: double.infinity,
                            height: 50,
                            child: ElevatedButton(
                              onPressed: isLoading ? null : _simuler,
                              style: ElevatedButton.styleFrom(
                                backgroundColor: rougeCoris,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                elevation: 4,
                              ),
                              child: isLoading
                                  ? const SizedBox(
                                      width: 20,
                                      height: 20,
                                      child: CircularProgressIndicator(
                                        valueColor:
                                            AlwaysStoppedAnimation<Color>(
                                                Colors.white),
                                        strokeWidth: 2,
                                      ),
                                    )
                                  : const Row(
                                      mainAxisAlignment:
                                          MainAxisAlignment.center,
                                      children: [
                                        Icon(Icons.play_circle_filled,
                                            size: 22),
                                        SizedBox(width: 8),
                                        Text(
                                          "Simuler",
                                          style: TextStyle(
                                            fontSize: 16,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                      ],
                                    ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  if (result != null) _buildResultCard(),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPeriodiciteDropdown() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withAlpha(25),
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        child: DropdownButtonFormField<String>(
          value: periodicite,
          decoration: const InputDecoration(
            border: InputBorder.none,
            prefixIcon: Icon(Icons.calendar_today, color: Color(0xFF002B6B)),
            labelText: 'P√©riodicit√©',
          ),
          items: const [
            DropdownMenuItem(
              value: 'annuel',
              child: Text('Paiement annuel'),
            ),
            DropdownMenuItem(
              value: 'unique',
              child: Text('Paiement unique'),
            ),
          ],
          onChanged: (String? newValue) {
            setState(() => periodicite = newValue!);
          },
        ),
      ),
    );
  }

  Widget _buildCapitalField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Capital √† garantir',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 6),
        TextField(
          controller: _capitalController,
          keyboardType: TextInputType.number,
          onChanged: (value) => _formatMontantInput(),
          decoration: InputDecoration(
            isDense: true,
            contentPadding:
                const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
            hintText: 'Ex: 5 000 000',
            hintStyle: const TextStyle(fontSize: 14),
            prefixIcon: Icon(Icons.monetization_on,
                size: 20, color: bleuCoris.withAlpha(178)),
            suffixText: 'FCFA',
            filled: true,
            fillColor: bleuClair.withAlpha(76),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: bleuCoris, width: 1.5),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDureeField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Dur√©e du contrat',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 6),
        TextField(
          controller: _dureeController,
          keyboardType: TextInputType.number,
          decoration: InputDecoration(
            isDense: true,
            contentPadding:
                const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
            hintText: 'Dur√©e en ann√©es',
            hintStyle: const TextStyle(fontSize: 14),
            prefixIcon: Icon(Icons.calendar_month,
                size: 20, color: bleuCoris.withAlpha(178)),
            suffixText: 'ans',
            filled: true,
            fillColor: bleuClair.withAlpha(76),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: bleuCoris, width: 1.5),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDateNaissanceField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Date de naissance',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        const SizedBox(height: 6),
        TextField(
          controller: _dateNaissanceController,
          readOnly: true,
          onTap: () async {
            final DateTime? picked = await showDatePicker(
              context: context,
              initialDate:
                  DateTime.now().subtract(const Duration(days: 365 * 30)),
              firstDate: DateTime(1950),
              lastDate: DateTime.now().subtract(const Duration(days: 365 * 18)),
            );
            if (picked != null) {
              setState(() {
                _dateNaissanceController.text =
                    "${picked.day}/${picked.month}/${picked.year}";
                _calculateAge();
              });
            }
          },
          decoration: InputDecoration(
            isDense: true,
            contentPadding:
                const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
            hintText: 'JJ/MM/AAAA',
            hintStyle: const TextStyle(fontSize: 14),
            prefixIcon: Icon(Icons.calendar_today,
                size: 20, color: bleuCoris.withAlpha(178)),
            suffixText: age != null ? '($age ans)' : null,
            filled: true,
            fillColor: bleuClair.withAlpha(76),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: bleuCoris, width: 1.5),
            ),
          ),
        ),
        if (age != null && (age! < 18 || age! > 65))
          Padding(
            padding: const EdgeInsets.only(top: 4),
            child: Text(
              'L\'√¢ge doit √™tre compris entre 18 et 65 ans',
              style: TextStyle(
                color: Colors.orange,
                fontSize: 12,
              ),
            ),
          ),
      ],
    );
  }

  Widget _buildResultCard() {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            vertCoris.withAlpha(25),
            Colors.white,
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: vertCoris.withAlpha(51), width: 1),
      ),
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: vertCoris.withAlpha(25),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child:
                      Icon(Icons.monetization_on, color: vertCoris, size: 22),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "R√©sultat de la simulation",
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: bleuCoris,
                        ),
                      ),
                      Text(
                        periodicite == 'unique'
                            ? 'Prime unique'
                            : 'Prime annuelle',
                        style: TextStyle(
                          fontSize: 14,
                          color: Colors.black54,
                        ),
                      ),
                    ],
                  ),
                ),
                IconButton(
                  icon: Icon(Icons.refresh, color: bleuCoris),
                  onPressed: _resetSimulation,
                  tooltip: 'Nouvelle simulation',
                ),
              ],
            ),
            const SizedBox(height: 16),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: vertCoris.withAlpha(25)),
              ),
              child: Text(
                '${_formatNumber(result!['primeTotal'])} FCFA',
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: vertCoris,
                ),
              ),
            ),
            const SizedBox(height: 16),
            SizedBox(
              width: double.infinity,
              height: 48,
              child: ElevatedButton(
                onPressed: () async {
                  // Pr√©parer les donn√©es de simulation
                  final simulationData = {
                    'capital': double.parse(
                        _capitalController.text.replaceAll(' ', '')),
                    'duree': int.parse(_dureeController.text),
                    'periodicite': periodicite,
                  };

                  // V√©rifier le r√¥le et rediriger
                  final userRole = await AuthService.getUserRole();
                  if (userRole == 'commercial') {
                    // Pour les commerciaux, rediriger vers la s√©lection de client
                    Navigator.pushNamed(
                      context,
                      '/commercial/select_client',
                      arguments: {
                        'productType': 'familis',
                        'simulationData': simulationData,
                      },
                    );
                  } else {
                    // Pour les clients, rediriger directement vers la souscription
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => SouscriptionFamilisPage(
                          simulationData: simulationData,
                        ),
                      ),
                    );
                  }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: vertCoris,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 4,
                ),
                child: const Text(
                  "Souscrire",
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
