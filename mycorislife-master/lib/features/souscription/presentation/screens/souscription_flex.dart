import 'package:flutter/material.dart';
import 'package:file_picker/file_picker.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:mycorislife/config/app_config.dart';
import 'package:http/http.dart' as http;
import 'package:mycorislife/core/widgets/corismoney_payment_modal.dart';
import 'dart:convert';
import 'dart:io';
import 'package:mycorislife/services/subscription_service.dart';
import 'package:mycorislife/features/client/presentation/screens/document_viewer_page.dart';
import 'package:mycorislife/core/widgets/subscription_recap_widgets.dart';
import '../widgets/signature_dialog_syncfusion.dart' as SignatureDialogFile;
import 'dart:typed_data';

/// ===============================================
/// ❌❌❌ PRODUIT DÉSACTIVÉ - NE PAS UTILISER ❌❌❌
/// ===============================================
/// PAGE DE SOUSCRIPTION - FLEX EMPRUNTEUR
/// ===============================================
/// ⚠️ CE PRODUIT A ÉTÉ TEMPORAIREMENT DÉSACTIVÉ ⚠️
/// Cette page permet de souscrire à une assurance emprunteur (FLEX EMPRUNTEUR)
/// avec garanties prévoyance et perte d'emploi.
///
/// FONCTIONNALITÉS :
/// - Formulaire multi-étapes (simulation → informations → récapitulatif)
/// - Calcul automatique de la prime selon l'âge et la durée
/// - Support pour deux workflows :
///   * Client direct : utilise les données du profil connecté
///   * Commercial : saisit les informations du client
/// - Validation de l'âge (18-65 ans)
/// - Upload de pièce d'identité
/// - Options de paiement (Wave, Orange Money)
///
/// WORKFLOW :
/// 1. Étape 1 : Paramètres de simulation (capital, durée, type de prêt, garanties)
/// 2. Étape 2 : Informations complémentaires (bénéficiaire, contact d'urgence)
/// 3. Étape 3 : Récapitulatif et paiement
///
/// Pour les commerciaux, une étape supplémentaire (étape 0) permet de saisir
/// les informations du client avant les paramètres de simulation.
///
/// [simulationData] : Données de simulation pré-remplies (optionnel)
/// [clientId] : ID du client si souscription par commercial (DEPRECATED)
/// [clientData] : Données du client si souscription par commercial (pour pré-remplissage)
class SouscriptionFlexPage extends StatefulWidget {
  final Map<String, dynamic>?
      simulationData; // Données de simulation (capital, durée, etc.)
  final String?
      clientId; // ID du client si souscription par commercial (DEPRECATED)
  final Map<String, dynamic>?
      clientData; // Données du client si souscription par commercial (nom, prénom, téléphone, etc.)
  final int? subscriptionId; // ID pour modification
  final Map<String, dynamic>?
      existingData; // Données existantes pour modification

  const SouscriptionFlexPage({
    super.key,
    this.simulationData,
    this.clientId,
    this.clientData,
    this.subscriptionId,
    this.existingData,
  });

  @override
  SouscriptionFlexPageState createState() => SouscriptionFlexPageState();
}

/// ===============================================
/// ÉTAT DE LA PAGE DE SOUSCRIPTION
/// ===============================================
///
/// Gère l'état de la page de souscription, incluant :
/// - Navigation entre les étapes (PageView)
/// - Animations (fade, slide)
/// - Données utilisateur et client
/// - Validation des formulaires
/// - Calcul de la prime
class SouscriptionFlexPageState extends State<SouscriptionFlexPage>
    with TickerProviderStateMixin {
  // ============================================
  // CHARTE GRAPHIQUE CORIS
  // ============================================
  // Couleurs officielles de la marque CORIS
  static const Color bleuCoris = Color(0xFF002B6B); // Bleu principal CORIS
  static const Color rougeCoris = Color(0xFFE30613); // Rouge principal CORIS
  static const Color bleuSecondaire = Color(0xFF1E4A8C); // Bleu secondaire
  static const Color blanc = Colors.white; // Blanc
  static const Color fondCarte =
      Color(0xFFF8FAFC); // Fond gris clair pour les cartes
  static const Color grisTexte =
      Color(0xFF64748B); // Gris pour les textes secondaires
  static const Color grisLeger =
      Color(0xFFF1F5F9); // Gris très clair pour les fonds
  static const Color vertSucces =
      Color(0xFF10B981); // Vert pour les messages de succès
  static const Color orangeWarning =
      Color(0xFFF59E0B); // Orange pour les avertissements

  // ============================================
  // CONTRÔLEURS DE NAVIGATION ET ANIMATION
  // ============================================
  final PageController _pageController =
      PageController(); // Contrôleur pour la navigation entre les pages (étapes)
  late AnimationController
      _animationController; // Contrôleur pour les animations de transition
  late AnimationController
      _progressController; // Contrôleur pour l'animation de la barre de progression
  late Animation<double> _fadeAnimation; // Animation de fondu (opacité)
  late Animation<double>
      _slideAnimation; // Animation de glissement (translation verticale)

  // ============================================
  // ÉTAT DE NAVIGATION
  // ============================================
  int _currentStep =
      0; // Étape actuelle (0 = première étape, 1 = deuxième, etc.)

  // ============================================
  // DONNÉES UTILISATEUR (pour les clients)
  // ============================================
  Map<String, dynamic> _userData =
      {}; // Données complètes du profil utilisateur (nom, prénom, email, etc.)
  DateTime?
      _dateNaissance; // Date de naissance de l'utilisateur (pour calcul de l'âge)
  int _age =
      0; // Âge calculé de l'utilisateur (utilisé pour le calcul de la prime)

  // ============================================
  // VARIABLES POUR COMMERCIAL (souscription pour un client)
  // ============================================
  bool _isCommercial =
      false; // Indique si l'utilisateur connecté est un commercial
  DateTime?
      _clientDateNaissance; // Date de naissance du client (si souscription par commercial)
  int _clientAge =
      0; // Âge calculé du client (utilisé pour le calcul de la prime)

  // ============================================
  // CONTRÔLEURS POUR LES INFORMATIONS CLIENT (si commercial)
  // ============================================
  // Ces contrôleurs sont utilisés uniquement lorsque _isCommercial = true
  // Ils permettent au commercial de saisir les informations du client
  final TextEditingController _clientNomController =
      TextEditingController(); // Nom du client
  final TextEditingController _clientPrenomController =
      TextEditingController(); // Prénom du client
  final TextEditingController _clientDateNaissanceController =
      TextEditingController(); // Date de naissance (format DD/MM/YYYY)
  final TextEditingController _clientLieuNaissanceController =
      TextEditingController(); // Lieu de naissance
  final TextEditingController _clientTelephoneController =
      TextEditingController(); // Numéro de téléphone (sans indicatif)
  final TextEditingController _clientEmailController =
      TextEditingController(); // Email du client
  final TextEditingController _clientAdresseController =
      TextEditingController(); // Adresse complète
  final TextEditingController _clientNumeroPieceController =
      TextEditingController(); // Numéro de pièce d'identité
  String _selectedClientCivilite =
      'Monsieur'; // Civilité sélectionnée (Monsieur, Madame, Mademoiselle)
  String _selectedClientIndicatif =
      '+225'; // Indicatif téléphonique sélectionné

  // ============================================
  // CONTRÔLEURS POUR LA SIMULATION
  // ============================================
  // Ces champs permettent de configurer les paramètres de l'assurance
  final TextEditingController _capitalController =
      TextEditingController(); // Capital à garantir (montant du prêt)
  final TextEditingController _dureeController =
      TextEditingController(); // Durée du prêt (en mois ou années)
  final TextEditingController _capitalPrevoyanceController =
      TextEditingController(); // Capital pour la garantie prévoyance (optionnel)
  final TextEditingController _capitalPerteEmploiController =
      TextEditingController(); // Capital pour la garantie perte d'emploi (optionnel)
  final TextEditingController _dateEffetController =
      TextEditingController(); // Contrôleur pour la date d'effet

  // ============================================
  // VARIABLES POUR LA SIMULATION
  // ============================================
  String _selectedDureeType =
      'mois'; // Type de durée sélectionné ('mois' ou 'années')
  String _selectedTypePret = 'Prêt amortissable'; // Type de prêt sélectionné
  bool _garantiePrevoyance =
      false; // Indique si la garantie prévoyance est activée
  bool _garantiePerteEmploi =
      false; // Indique si la garantie perte d'emploi est activée
  DateTime? _dateEffetContrat; // Date de début du contrat
  DateTime? _dateEcheanceContrat; // Date de fin du contrat
  double _calculatedPrime = 0.0; // Prime totale calculée (en FCFA)
  double _calculatedCapital =
      0.0; // Capital total calculé (somme des garanties)
  double _primePrevoyance = 0.0; // Prime pour garantie prévoyance
  double _primePerteEmploi = 0.0; // Prime pour garantie perte d'emploi

  // ============================================
  // CONTRÔLEURS POUR LA SOUSCRIPTION
  // ============================================
  // Informations complémentaires nécessaires pour finaliser la souscription
  // Utiliser des clés séparées pour chaque étape afin d'éviter
  // la réutilisation d'un même GlobalKey dans plusieurs Form widgets.
  final _formKeyClientInfo = GlobalKey<FormState>();
  final _formKeyStep2 =
      GlobalKey<FormState>(); // Clé pour valider le formulaire
  final _beneficiaireNomController =
      TextEditingController(); // Nom du bénéficiaire en cas de décès
  final _beneficiaireContactController =
      TextEditingController(); // Contact du bénéficiaire
  String _selectedLienParente =
      'Enfant'; // Lien de parenté avec le bénéficiaire
  final _personneContactNomController =
      TextEditingController(); // Nom de la personne à contacter en urgence
  final _personneContactTelController =
      TextEditingController(); // Téléphone de la personne à contacter
  String _selectedLienParenteUrgence =
      'Parent'; // Lien de parenté avec la personne à contacter
  String _selectedBeneficiaireIndicatif =
      '+225'; // Indicatif téléphonique du bénéficiaire
  String _selectedContactIndicatif =
      '+225'; // Indicatif téléphonique du contact d'urgence

  File? _pieceIdentite; // Fichier de la pièce d'identité uploadée
  String? _pieceIdentiteLabel;

  // ============================================
  // SIGNATURE ET TRAITEMENT
  // ============================================
  Uint8List? _clientSignature; // Signature en bytes pour le PDF
  bool _isProcessing = false; // Indicateur de traitement en cours

  // ============================================
  // VARIABLES MODE DE PAIEMENT
  // ============================================
  String? _selectedModePaiement;
  String? _selectedBanque;
  final _banqueController = TextEditingController();
  final _ribUnifiedController = TextEditingController();
  final _numeroMobileMoneyController = TextEditingController();
  final _nomStructureController = TextEditingController();
  final _numeroMatriculeController = TextEditingController();
  final _corisMoneyPhoneController = TextEditingController();
  final List<String> _modePaiementOptions = [
    'Virement',
    'Wave',
    'Orange Money',
    'Prélèvement à la source',
    'CORIS Money'
  ];
  final List<String> _banques = [
    'CORIS BANK',
    'SGCI',
    'BICICI',
    'Ecobank',
    'BOA',
    'UBA',
    'Société Générale',
    'BNI',
    'Banque Atlantique',
    'Autre',
  ];

  // ============================================
  // OPTIONS ET LISTES DE SÉLECTION
  // ============================================
  final List<String> _lienParenteOptions = [
    // Options pour le lien de parenté avec le bénéficiaire
    'Enfant',
    'Conjoint',
    'Parent',
    'Frère/Sœur',
    'Ami',
    'Autre'
  ];
  final List<String> _typePretOptions = [
    // Types de prêts disponibles pour le calcul de la prime
    'Prêt amortissable', // Prêt classique avec remboursement mensuel
    'Prêt découvert', // Autorisation de découvert
    'Prêt scolaire' // Prêt pour les études
  ];
  final List<String> _dureeOptions = [
    'mois',
    'années'
  ]; // Options pour le type de durée
  final List<String> _indicatifs = [
    // Indicatifs téléphoniques disponibles (pays d'Afrique de l'Ouest)
    '+225', // Côte d'Ivoire
    '+226', // Burkina Faso
    '+237', // Cameroun
    '+228', // Togo
    '+229', // Bénin
    '+234' // Nigeria
  ];
  final storage =
      const FlutterSecureStorage(); // Stockage sécurisé pour le token JWT

  // ============================================
  // TABLEAUX DE TARIFS
  // ============================================
  // Ces tableaux contiennent les taux de prime selon l'âge et la durée
  // Format de la clé : 'AGE_DUREE' (ex: '18_12' = 18 ans, 12 mois)
  // Valeur : taux de prime (pourcentage du capital)

  /// Tarifs pour les prêts amortissables
  /// Clé : 'AGE_DUREE' (ex: '18_12' = 18 ans, 12 mois)
  /// Valeur : taux de prime en pourcentage (ex: 0.150 = 0.15% du capital)
  final Map<String, double> tarifsPretAmortissable = {
    '18_12': 0.14979,
    '18_24': 0.29513,
    '18_36': 0.44644,
    '18_48': 0.60215,
    '18_60': 0.76109,
    '18_72': 0.92246,
    '18_84': 1.08582,
    '18_96': 1.25088,
    '18_108': 1.41752,
    '18_120': 1.58568,
    '18_132': 1.75523,
    '18_144': 1.92604,
    '18_156': 2.09796,
    '18_168': 2.27076,
    '18_180': 2.44436,
    '19_12': 0.15947,
    '19_24': 0.31185,
    '19_36': 0.46833,
    '19_48': 0.62787,
    '19_60': 0.78976,
    '19_72': 0.95367,
    '19_84': 1.11938,
    '19_96': 1.28681,
    '19_108': 1.45592,
    '19_120': 1.62663,
    '19_132': 1.79880,
    '19_144': 1.97227,
    '19_156': 2.14683,
    '19_168': 2.32238,
    '19_180': 2.49903,
    '20_12': 0.16518,
    '20_24': 0.32176,
    '20_36': 0.48131,
    '20_48': 0.64322,
    '20_60': 0.80723,
    '20_72': 0.97319,
    '20_84': 1.14106,
    '20_96': 1.31084,
    '20_108': 1.48242,
    '20_120': 1.65570,
    '20_132': 1.83051,
    '20_144': 2.00662,
    '20_156': 2.18393,
    '20_168': 2.36257,
    '20_180': 2.54288,
    '21_12': 0.16864,
    '21_24': 0.32772,
    '21_36': 0.48922,
    '21_48': 0.65297,
    '21_60': 0.81886,
    '21_72': 0.98689,
    '21_84': 1.15707,
    '21_96': 1.32931,
    '21_108': 1.50349,
    '21_120': 1.67943,
    '21_132': 1.85690,
    '21_144': 2.03579,
    '21_156': 2.21627,
    '21_168': 2.39867,
    '21_180': 2.58334,
    '22_12': 0.17063,
    '22_24': 0.33138,
    '22_36': 0.49458,
    '22_48': 0.66015,
    '22_60': 0.82812,
    '22_72': 0.99850,
    '22_84': 1.17120,
    '22_96': 1.34608,
    '22_108': 1.52298,
    '22_120': 1.70163,
    '22_132': 1.88195,
    '22_144': 2.06409,
    '22_156': 2.24845,
    '22_168': 2.43537,
    '22_180': 2.62515,
    '23_12': 0.17223,
    '23_24': 0.33469,
    '23_36': 0.49975,
    '23_48': 0.66747,
    '23_60': 0.83788,
    '23_72': 1.01086,
    '23_84': 1.18629,
    '23_96': 1.36396,
    '23_108': 1.54363,
    '23_120': 1.72520,
    '23_132': 1.90886,
    '23_144': 2.09502,
    '23_156': 2.28406,
    '23_168': 2.47629,
    '23_180': 2.67200,
    '24_12': 0.17424,
    '24_24': 0.33861,
    '24_36': 0.50592,
    '24_48': 0.67620,
    '24_60': 0.84930,
    '24_72': 1.02509,
    '24_84': 1.20338,
    '24_96': 1.38388,
    '24_108': 1.56652,
    '24_120': 1.75152,
    '24_132': 1.93934,
    '24_144': 2.13036,
    '24_156': 2.32491,
    '24_168': 2.52329,
    '24_180': 2.72580,
    '25_12': 0.17632,
    '25_24': 0.34308,
    '25_36': 0.51308,
    '25_48': 0.68615,
    '25_60': 0.86214,
    '25_72': 1.04085,
    '25_84': 1.22200,
    '25_96': 1.40552,
    '25_108': 1.59169,
    '25_120': 1.78099,
    '25_132': 1.97385,
    '25_144': 2.17060,
    '25_156': 2.37154,
    '25_168': 2.57699,
    '25_180': 2.78731,
    '26_12': 0.17926,
    '26_24': 0.34884,
    '26_36': 0.52170,
    '26_48': 0.69769,
    '26_60': 0.87664,
    '26_72': 1.05822,
    '26_84': 1.24243,
    '26_96': 1.42956,
    '26_108': 1.62018,
    '26_120': 1.81472,
    '26_132': 2.01354,
    '26_144': 2.21693,
    '26_156': 2.42521,
    '26_168': 2.63876,
    '26_180': 2.85808,
    '27_12': 0.18235,
    '27_24': 0.35476,
    '27_36': 0.53055,
    '27_48': 0.70951,
    '27_60': 0.89131,
    '27_72': 1.07597,
    '27_84': 1.26388,
    '27_96': 1.45564,
    '27_108': 1.65172,
    '27_120': 1.85247,
    '27_132': 2.05820,
    '27_144': 2.26922,
    '27_156': 2.48593,
    '27_168': 2.70883,
    '27_180': 2.93857,
    '28_12': 0.18532,
    '28_24': 0.36069,
    '28_36': 0.53945,
    '28_48': 0.72123,
    '28_60': 0.90614,
    '28_72': 1.09463,
    '28_84': 1.28736,
    '28_96': 1.48484,
    '28_108': 1.68741,
    '28_120': 1.89538,
    '28_132': 2.10905,
    '28_144': 2.32885,
    '28_156': 2.55527,
    '28_168': 2.78901,
    '28_180': 3.03068,
    '29_12': 0.18864,
    '29_24': 0.36696,
    '29_36': 0.54848,
    '29_48': 0.73340,
    '29_60': 0.92227,
    '29_72': 1.11584,
    '29_84': 1.31460,
    '29_96': 1.51889,
    '29_108': 1.72901,
    '29_120': 1.94527,
    '29_132': 2.16808,
    '29_144': 2.39799,
    '29_156': 2.63568,
    '29_168': 2.88182,
    '29_180': 3.13690,
    '30_12': 0.19165,
    '30_24': 0.37262,
    '30_36': 0.55734,
    '30_48': 0.74645,
    '30_60': 0.94076,
    '30_72': 1.14072,
    '30_84': 1.34666,
    '30_96': 1.55888,
    '30_108': 1.77766,
    '30_120': 2.00345,
    '30_132': 2.23679,
    '30_144': 2.47842,
    '30_156': 2.72900,
    '30_168': 2.98906,
    '30_180': 3.25901,
    '31_12': 0.19434,
    '31_24': 0.37875,
    '31_36': 0.56805,
    '31_48': 0.76306,
    '31_60': 0.96421,
    '31_72': 1.17178,
    '31_84': 1.38606,
    '31_96': 1.60733,
    '31_108': 1.83605,
    '31_120': 2.07280,
    '31_132': 2.31834,
    '31_144': 2.57336,
    '31_156': 2.83840,
    '31_168': 3.11387,
    '31_180': 3.40009,
    '32_12': 0.19884,
    '32_24': 0.38834,
    '32_36': 0.58410,
    '32_48': 0.78646,
    '32_60': 0.99565,
    '32_72': 1.21195,
    '32_84': 1.43566,
    '32_96': 1.66726,
    '32_108': 1.90737,
    '32_120': 2.15679,
    '32_132': 2.41623,
    '32_144': 2.68624,
    '32_156': 2.96723,
    '32_168': 3.25953,
    '32_180': 3.56323,
    '33_12': 0.20509,
    '33_24': 0.40167,
    '33_36': 0.60522,
    '33_48': 0.81599,
    '33_60': 1.03425,
    '33_72': 1.26033,
    '33_84': 1.49474,
    '33_96': 1.73814,
    '33_108': 1.99139,
    '33_120': 2.25522,
    '33_132': 2.53018,
    '33_144': 2.81669,
    '33_156': 3.11508,
    '33_168': 3.42543,
    '33_180': 3.74753,
    '34_12': 0.21377,
    '34_24': 0.41842,
    '34_36': 0.63065,
    '34_48': 0.85076,
    '34_60': 1.07909,
    '34_72': 1.31621,
    '34_84': 1.56281,
    '34_96': 1.81982,
    '34_108': 2.08799,
    '34_120': 2.36788,
    '34_132': 2.65990,
    '34_144': 2.96438,
    '34_156': 3.28138,
    '34_168': 3.61068,
    '34_180': 3.95180,
    '35_12': 0.22237,
    '35_24': 0.43592,
    '35_36': 0.65775,
    '35_48': 0.88820,
    '35_60': 1.12792,
    '35_72': 1.37765,
    '35_84': 1.63837,
    '35_96': 1.91085,
    '35_108': 2.19565,
    '35_120': 2.49319,
    '35_132': 2.80376,
    '35_144': 3.12744,
    '35_156': 3.46396,
    '35_168': 3.81281,
    '35_180': 4.17338,
    '36_12': 0.23264,
    '36_24': 0.45606,
    '36_36': 0.68853,
    '36_48': 0.93076,
    '36_60': 1.18354,
    '36_72': 1.44792,
    '36_84': 1.72470,
    '36_96': 2.01441,
    '36_108': 2.31745,
    '36_120': 2.63413,
    '36_132': 2.96449,
    '36_144': 3.30824,
    '36_156': 3.66483,
    '36_168': 4.03362,
    '36_180': 4.41391,
    '37_12': 0.24345,
    '37_24': 0.47781,
    '37_36': 0.72247,
    '37_48': 0.97827,
    '37_60': 1.24630,
    '37_72': 1.52738,
    '37_84': 1.82199,
    '37_96': 2.13056,
    '37_108': 2.45335,
    '37_120': 2.79040,
    '37_132': 3.14138,
    '37_144': 3.50571,
    '37_156': 3.88271,
    '37_168': 4.27168,
    '37_180': 4.67201,
    '38_12': 0.25590,
    '38_24': 0.50297,
    '38_36': 0.76177,
    '38_48': 1.03349,
    '38_60': 1.31889,
    '38_72': 1.61844,
    '38_84': 1.93253,
    '38_96': 2.26143,
    '38_108': 2.60516,
    '38_120': 2.96335,
    '38_132': 3.33539,
    '38_144': 3.72058,
    '38_156': 4.11817,
    '38_168': 4.52757,
    '38_180': 4.94836,
    '39_12': 0.27047,
    '39_24': 0.53229,
    '39_36': 0.80774,
    '39_48': 1.09750,
    '39_60': 1.40200,
    '39_72': 1.72162,
    '39_84': 2.05662,
    '39_96': 2.40699,
    '39_108': 2.77234,
    '39_120': 3.15202,
    '39_132': 3.54530,
    '39_144': 3.95144,
    '39_156': 4.36983,
    '39_168': 4.80006,
    '39_180': 5.24178,
    '40_12': 0.28728,
    '40_24': 0.56656,
    '40_36': 0.86073,
    '40_48': 1.17017,
    '40_60': 1.49527,
    '40_72': 1.83631,
    '40_84': 2.19325,
    '40_96': 2.56567,
    '40_108': 2.95289,
    '40_120': 3.35414,
    '40_132': 3.76868,
    '40_144': 4.19592,
    '40_156': 4.63548,
    '40_168': 5.08701,
    '40_180': 5.55021,
    '41_12': 0.30757,
    '41_24': 0.60609,
    '41_36': 0.92037,
    '41_48': 1.25083,
    '41_60': 1.59778,
    '41_72': 1.96116,
    '41_84': 2.34050,
    '41_96': 2.73507,
    '41_108': 3.14412,
    '41_120': 3.56687,
    '41_132': 4.00278,
    '41_144': 4.45149,
    '41_156': 4.91267,
    '41_168': 5.38606,
    '41_180': 5.87139,
    '42_12': 0.32843,
    '42_24': 0.64737,
    '42_36': 0.98306,
    '42_48': 1.33576,
    '42_60': 1.70541,
    '42_72': 2.09148,
    '42_84': 2.49320,
    '42_96': 2.90981,
    '42_108': 3.34055,
    '42_120': 3.78490,
    '42_132': 4.24253,
    '42_144': 4.71317,
    '42_156': 5.19658,
    '42_168': 5.69252,
    '42_180': 6.20063,
    '43_12': 0.35118,
    '43_24': 0.69191,
    '43_36': 1.05020,
    '43_48': 1.42592,
    '43_60': 1.81848,
    '43_72': 2.22708,
    '43_84': 2.65096,
    '43_96': 3.08939,
    '43_108': 3.54188,
    '43_120': 4.00818,
    '43_132': 4.48803,
    '43_144': 4.98125,
    '43_156': 5.48761,
    '43_168': 6.00678,
    '43_180': 6.53916,
    '44_12': 0.37504,
    '44_24': 0.73870,
    '44_36': 1.12023,
    '44_48': 1.51897,
    '44_60': 1.93411,
    '44_72': 2.36490,
    '44_84': 2.81066,
    '44_96': 3.27095,
    '44_108': 3.74558,
    '44_120': 4.23436,
    '44_132': 4.73713,
    '44_144': 5.25370,
    '44_156': 5.78375,
    '44_168': 6.32775,
    '44_180': 6.88691,
    '45_12': 0.40021,
    '45_24': 0.78720,
    '45_36': 1.19172,
    '45_48': 1.61295,
    '45_60': 2.05022,
    '45_72': 2.50287,
    '45_84': 2.97055,
    '45_96': 3.45314,
    '45_108': 3.95051,
    '45_120': 4.46255,
    '45_132': 4.98908,
    '45_144': 5.52981,
    '45_156': 6.08527,
    '45_168': 6.65679,
    '45_180': 7.24629,
    '46_12': 0.42514,
    '46_24': 0.83490,
    '46_36': 1.26170,
    '46_48': 1.70492,
    '46_60': 2.16398,
    '46_72': 2.63860,
    '46_84': 3.12876,
    '46_96': 3.63437,
    '46_108': 4.15536,
    '46_120': 4.69160,
    '46_132': 5.24280,
    '46_144': 5.80956,
    '46_156': 6.39334,
    '46_168': 6.99619,
    '46_180': 7.62005,
    '47_12': 0.44914,
    '47_24': 0.88095,
    '47_36': 1.32959,
    '47_48': 1.79454,
    '47_60': 2.27565,
    '47_72': 2.77296,
    '47_84': 3.28646,
    '47_96': 3.81611,
    '47_108': 4.36179,
    '47_120': 4.92322,
    '47_132': 5.50112,
    '47_144': 6.09705,
    '47_156': 6.71324,
    '47_168': 7.35171,
    '47_180': 8.01441,
    '48_12': 0.47252,
    '48_24': 0.92605,
    '48_36': 1.39640,
    '48_48': 1.88354,
    '48_60': 2.38762,
    '48_72': 2.90865,
    '48_84': 3.44664,
    '48_96': 4.00150,
    '48_108': 4.57295,
    '48_120': 5.16179,
    '48_132': 5.76978,
    '48_144': 6.39927,
    '48_156': 7.05242,
    '48_168': 7.73127,
    '48_180': 8.43757,
    '49_12': 0.49583,
    '49_24': 0.97107,
    '49_36': 1.46381,
    '49_48': 1.97428,
    '49_60': 2.50253,
    '49_72': 3.04857,
    '49_84': 3.61234,
    '49_96': 4.19356,
    '49_108': 4.79316,
    '49_120': 5.41308,
    '49_132': 6.05585,
    '49_144': 6.72376,
    '49_156': 7.41891,
    '49_168': 8.14314,
    '49_180': 8.89732,
    '50_12': 0.51916,
    '50_24': 1.01715,
    '50_36': 1.53371,
    '50_48': 2.06887,
    '50_60': 2.62269,
    '50_72': 3.19511,
    '50_84': 3.78586,
    '50_96': 4.39603,
    '50_108': 5.02776,
    '50_120': 5.68380,
    '50_132': 6.36654,
    '50_144': 7.07819,
    '50_156': 7.82063,
    '50_168': 8.59471,
    '50_180': 9.40135,
    '51_12': 0.54454,
    '51_24': 1.06692,
    '51_36': 1.60870,
    '51_48': 2.17001,
    '51_60': 2.75080,
    '51_72': 3.35080,
    '51_84': 3.97132,
    '51_96': 4.61473,
    '51_108': 5.28402,
    '51_120': 5.98171,
    '51_132': 6.71006,
    '51_144': 7.47101,
    '51_156': 8.26539,
    '51_168': 9.09410,
    '51_180': 9.95788,
    '52_12': 0.57148,
    '52_24': 1.11954,
    '52_36': 1.68801,
    '52_48': 2.27687,
    '52_60': 2.88582,
    '52_72': 3.51646,
    '52_84': 4.17145,
    '52_96': 4.85403,
    '52_108': 5.56680,
    '52_120': 6.31212,
    '52_132': 7.09196,
    '52_144': 7.90708,
    '52_156': 8.75839,
    '52_168': 9.64662,
    '52_180': 10.57176,
    '53_12': 0.59968,
    '53_24': 1.17502,
    '53_36': 1.77163,
    '53_48': 2.38920,
    '53_60': 3.02975,
    '53_72': 3.69626,
    '53_84': 4.39222,
    '53_96': 5.12033,
    '53_108': 5.88297,
    '53_120': 6.68213,
    '53_132': 7.51853,
    '53_144': 8.39303,
    '53_156': 9.30636,
    '53_168': 10.25847,
    '53_180': 11.24792,
    '54_12': 0.63002,
    '54_24': 1.23403,
    '54_36': 1.85985,
    '54_48': 2.51012,
    '54_60': 3.18818,
    '54_72': 3.89774,
    '54_84': 4.64154,
    '54_96': 5.42197,
    '54_108': 6.24101,
    '54_120': 7.09927,
    '54_132': 7.99762,
    '54_144': 8.93676,
    '54_156': 9.91659,
    '54_168': 10.93556,
    '54_180': 11.99131,
    '55_12': 0.66135,
    '55_24': 1.29499,
    '55_36': 1.95494,
    '55_48': 2.64479,
    '55_60': 3.36839,
    '55_72': 4.12843,
    '55_84': 4.92728,
    '55_96': 5.76689,
    '55_108': 6.64774,
    '55_120': 7.57067,
    '55_132': 8.53639,
    '55_144': 9.54476,
    '55_156': 10.59407,
    '55_168': 11.68184,
    '55_180': 12.80588,
    '56_12': 0.69380,
    '56_24': 1.36396,
    '56_36': 2.06624,
    '56_48': 2.80467,
    '56_60': 3.58175,
    '56_72': 4.39982,
    '56_84': 5.26080,
    '56_96': 6.16503,
    '56_108': 7.11333,
    '56_120': 8.10643,
    '56_132': 9.14414,
    '56_144': 10.22463,
    '56_156': 11.34525,
    '56_168': 12.50373,
    '56_180': 13.69801,
    '57_12': 0.73899,
    '57_24': 1.45455,
    '57_36': 2.20870,
    '57_48': 3.00367,
    '57_60': 3.84177,
    '57_72': 4.72492,
    '57_84': 5.65326,
    '57_96': 6.62765,
    '57_108': 7.64886,
    '57_120': 8.71666,
    '57_132': 9.82907,
    '57_144': 10.98329,
    '57_156': 12.17696,
    '57_168': 13.40801,
    '57_180': 14.67444,
    '58_12': 0.79118,
    '58_24': 1.56216,
    '58_36': 2.37593,
    '58_48': 3.23491,
    '58_60': 4.14106,
    '58_72': 5.09430,
    '58_84': 6.09556,
    '58_96': 7.14568,
    '58_108': 8.24439,
    '58_120': 9.38956,
    '58_132': 10.57822,
    '58_144': 11.80794,
    '58_156': 13.07663,
    '58_168': 14.38231,
    '58_180': 15.72282,
    '59_12': 0.85747,
    '59_24': 1.69067,
    '59_36': 2.57124,
    '59_48': 3.50113,
    '59_60': 4.47997,
    '59_72': 5.50881,
    '59_84': 6.58859,
    '59_96': 7.71902,
    '59_108': 8.89777,
    '59_120': 10.12169,
    '59_132': 11.38831,
    '59_144': 12.69554,
    '59_156': 14.04141,
    '59_168': 15.42377,
    '59_180': 16.84017,
    '60_12': 0.92555,
    '60_24': 1.82863,
    '60_36': 2.78320,
    '60_48': 3.78843,
    '60_60': 4.84566,
    '60_72': 5.95601,
    '60_84': 7.11912,
    '60_96': 8.33243,
    '60_108': 9.59260,
    '60_120': 10.89714,
    '60_132': 12.24398,
    '60_144': 13.63118,
    '60_156': 15.05662,
    '60_168': 16.51781,
    '60_180': 18.01207,
    '61_12': 1.00755,
    '61_24': 1.98764,
    '61_36': 3.01984,
    '61_48': 4.10614,
    '61_60': 5.24785,
    '61_72': 6.44453,
    '61_84': 7.69331,
    '61_96': 8.99062,
    '61_108': 10.33400,
    '61_120': 11.72143,
    '61_132': 13.15104,
    '61_144': 14.62072,
    '61_156': 16.12800,
    '61_168': 17.67013,
    '61_180': 19.24434,
    '62_12': 1.09226,
    '62_24': 2.15166,
    '62_36': 3.26777,
    '62_48': 4.44183,
    '62_60': 5.67318,
    '62_72': 6.95850,
    '62_84': 8.29404,
    '62_96': 9.67735,
    '62_108': 11.10654,
    '62_120': 12.57983,
    '62_132': 14.09517,
    '62_144': 15.65008,
    '62_156': 17.24178,
    '62_168': 18.86746,
    '62_180': 20.52430,
    '63_12': 1.17951,
    '63_24': 2.32677,
    '63_36': 3.53456,
    '63_48': 4.80188,
    '63_60': 6.12493,
    '63_72': 7.49975,
    '63_84': 8.92407,
    '63_96': 10.39617,
    '63_108': 11.91443,
    '63_120': 13.47685,
    '63_132': 15.08094,
    '63_144': 16.72394,
    '63_156': 18.40297,
    '63_168': 20.11519,
    '63_180': 21.85760,
    '64_12': 1.28199,
    '64_24': 2.52481,
    '64_36': 3.82925,
    '64_48': 5.19092,
    '64_60': 6.60582,
    '64_72': 8.07201,
    '64_84': 9.58802,
    '64_96': 11.15241,
    '64_108': 12.76326,
    '64_120': 14.41809,
    '64_132': 16.11410,
    '64_144': 17.84839,
    '64_156': 19.61808,
    '64_168': 21.42010,
    '64_180': 23.25123,
    '65_12': 1.38741,
    '65_24': 2.72999,
    '65_36': 4.13104,
    '65_48': 5.58674,
    '65_60': 7.09570,
    '65_72': 8.65679,
    '65_84': 10.26874,
    '65_96': 11.92970,
    '65_108': 13.63718,
    '65_120': 15.38833,
    '65_132': 17.18022,
    '65_144': 19.00992,
    '65_156': 20.87431,
    '65_168': 22.77008,
    '65_180': 24.69420,
  };
  final Map<String, double> tarifsPretDecouvert = {
    '18_1': 0.27220,
    '18_2': 0.55181,
    '18_3': 0.83122,
    '18_4': 1.10640,
    '18_5': 1.37498,
    '18_6': 1.63648,
    '18_7': 1.89164,
    '18_8': 2.14070,
    '18_9': 2.38491,
    '18_10': 2.62450,
    '18_11': 2.85933,
    '18_12': 3.08984,
    '18_13': 3.31567,
    '18_14': 3.53649,
    '18_15': 3.75433,
    '19_1': 0.28978,
    '19_2': 0.57936,
    '19_3': 0.86455,
    '19_4': 1.14290,
    '19_5': 1.41391,
    '19_6': 1.67837,
    '19_7': 1.93648,
    '19_8': 2.18958,
    '19_9': 2.43789,
    '19_10': 2.68127,
    '19_11': 2.92016,
    '19_12': 3.15421,
    '19_13': 3.38306,
    '19_14': 3.60883,
    '19_15': 3.83334,
    '20_1': 0.30015,
    '20_2': 0.59577,
    '20_3': 0.88429,
    '20_4': 1.16521,
    '20_5': 1.43932,
    '20_6': 1.70687,
    '20_7': 1.96922,
    '20_8': 2.22661,
    '20_9': 2.47887,
    '20_10': 2.72650,
    '20_11': 2.96910,
    '20_12': 3.20631,
    '20_13': 3.44033,
    '20_14': 3.67305,
    '20_15': 3.90689,
    '21_1': 0.30645,
    '21_2': 0.60554,
    '21_3': 0.89675,
    '21_4': 1.18091,
    '21_5': 1.45825,
    '21_6': 1.73022,
    '21_7': 1.99703,
    '21_8': 2.25854,
    '21_9': 2.51524,
    '21_10': 2.76672,
    '21_11': 3.01263,
    '21_12': 3.25522,
    '21_13': 3.49646,
    '21_14': 3.73888,
    '21_15': 3.98195,
    '22_1': 0.31006,
    '22_2': 0.61196,
    '22_3': 0.90654,
    '22_4': 1.19407,
    '22_5': 1.47601,
    '22_6': 1.75261,
    '22_7': 2.02372,
    '22_8': 2.28984,
    '22_9': 2.55055,
    '22_10': 2.80548,
    '22_11': 3.05697,
    '22_12': 3.30706,
    '22_13': 3.55837,
    '22_14': 3.81036,
    '22_15': 4.06444,
    '23_1': 0.31298,
    '23_2': 0.61839,
    '23_3': 0.91647,
    '23_4': 1.20877,
    '23_5': 1.49553,
    '23_6': 1.77659,
    '23_7': 2.05248,
    '23_8': 2.32277,
    '23_9': 2.58706,
    '23_10': 2.84779,
    '23_11': 3.10707,
    '23_12': 3.36760,
    '23_13': 3.62885,
    '23_14': 3.89226,
    '23_15': 4.15789,
    '24_1': 0.31663,
    '24_2': 0.62567,
    '24_3': 0.92871,
    '24_4': 1.22601,
    '24_5': 1.51739,
    '24_6': 1.80343,
    '24_7': 2.08365,
    '24_8': 2.35765,
    '24_9': 2.62796,
    '24_10': 2.89677,
    '24_11': 3.16688,
    '24_12': 3.43773,
    '24_13': 3.71082,
    '24_14': 3.98621,
    '24_15': 4.26511,
    '25_1': 0.32041,
    '25_2': 0.63459,
    '25_3': 0.94283,
    '25_4': 1.24494,
    '25_5': 1.54149,
    '25_6': 1.83202,
    '25_7': 2.11610,
    '25_8': 2.39636,
    '25_9': 2.67505,
    '25_10': 2.95510,
    '25_11': 3.23591,
    '25_12': 3.51904,
    '25_13': 3.80457,
    '25_14': 4.09372,
    '25_15': 4.38813,
    '26_1': 0.32575,
    '26_2': 0.64534,
    '26_3': 0.95857,
    '26_4': 1.26604,
    '26_5': 1.56726,
    '26_6': 1.86181,
    '26_7': 2.15238,
    '26_8': 2.44134,
    '26_9': 2.73169,
    '26_10': 3.02284,
    '26_11': 3.31640,
    '26_12': 3.61244,
    '26_13': 3.91224,
    '26_14': 4.21748,
    '26_15': 4.52971,
    '27_1': 0.33136,
    '27_2': 0.65614,
    '27_3': 0.97495,
    '27_4': 1.28728,
    '27_5': 1.59268,
    '27_6': 1.89397,
    '27_7': 2.19358,
    '27_8': 2.49464,
    '27_9': 2.79652,
    '27_10': 3.10090,
    '27_11': 3.40785,
    '27_12': 3.71871,
    '27_13': 4.03520,
    '27_14': 4.35894,
    '27_15': 4.69266,
    '28_1': 0.33677,
    '28_2': 0.66735,
    '28_3': 0.99120,
    '28_4': 1.30788,
    '28_5': 1.62029,
    '28_6': 1.93096,
    '28_7': 2.24313,
    '28_8': 2.55616,
    '28_9': 2.87178,
    '28_10': 3.19006,
    '28_11': 3.51239,
    '28_12': 3.84057,
    '28_13': 4.17626,
    '28_14': 4.52230,
    '28_15': 4.87795,
    '29_1': 0.34280,
    '29_2': 0.67863,
    '29_3': 1.00701,
    '29_4': 1.33097,
    '29_5': 1.65312,
    '29_6': 1.97683,
    '29_7': 2.30143,
    '29_8': 2.62872,
    '29_9': 2.95876,
    '29_10': 3.29301,
    '29_11': 3.63332,
    '29_12': 3.98142,
    '29_13': 4.34025,
    '29_14': 4.70904,
    '29_15': 5.08847,
    '30_1': 0.34826,
    '30_2': 0.68880,
    '30_3': 1.02475,
    '30_4': 1.35883,
    '30_5': 1.69453,
    '30_6': 2.03114,
    '30_7': 2.37054,
    '30_8': 2.71280,
    '30_9': 3.05943,
    '30_10': 3.41233,
    '30_11': 3.77332,
    '30_12': 4.14544,
    '30_13': 4.52788,
    '30_14': 4.92135,
    '30_15': 5.32552,
    '31_1': 0.35316,
    '31_2': 0.70156,
    '31_3': 1.04803,
    '31_4': 1.39617,
    '31_5': 1.74526,
    '31_6': 2.09724,
    '31_7': 2.45219,
    '31_8': 2.81166,
    '31_9': 3.17765,
    '31_10': 3.55202,
    '31_11': 3.93793,
    '31_12': 4.33455,
    '31_13': 4.74260,
    '31_14': 5.16176,
    '31_15': 5.59181,
    '32_1': 0.36133,
    '32_2': 0.72065,
    '32_3': 1.08172,
    '32_4': 1.44376,
    '32_5': 1.80881,
    '32_6': 2.17693,
    '32_7': 2.54974,
    '32_8': 2.92931,
    '32_9': 3.31758,
    '32_10': 3.71780,
    '32_11': 4.12915,
    '32_12': 4.55235,
    '32_13': 4.98705,
    '32_14': 5.43306,
    '32_15': 5.88842,
    '33_1': 0.37268,
    '33_2': 0.74717,
    '33_3': 1.12268,
    '33_4': 1.50130,
    '33_5': 1.88311,
    '33_6': 2.26979,
    '33_7': 2.66347,
    '33_8': 3.06617,
    '33_9': 3.48129,
    '33_10': 3.90792,
    '33_11': 4.34686,
    '33_12': 4.79773,
    '33_13': 5.26033,
    '33_14': 5.73261,
    '33_15': 6.21197,
    '34_1': 0.38845,
    '34_2': 0.77796,
    '34_3': 1.17070,
    '34_4': 1.56675,
    '34_5': 1.96784,
    '34_6': 2.37621,
    '34_7': 2.79392,
    '34_8': 3.22451,
    '34_9': 3.66706,
    '34_10': 4.12236,
    '34_11': 4.59005,
    '34_12': 5.06989,
    '34_13': 5.55979,
    '34_14': 6.05702,
    '34_15': 6.55938,
    '35_1': 0.40409,
    '35_2': 0.81153,
    '35_3': 1.22240,
    '35_4': 1.63850,
    '35_5': 2.06216,
    '35_6': 2.49551,
    '35_7': 2.94221,
    '35_8': 3.40133,
    '35_9': 3.87367,
    '35_10': 4.35886,
    '35_11': 4.85666,
    '35_12': 5.36490,
    '35_13': 5.88073,
    '35_14': 6.40190,
    '35_15': 6.92689,
    '36_1': 0.42275,
    '36_2': 0.84906,
    '36_3': 1.28079,
    '36_4': 1.72036,
    '36_5': 2.16999,
    '36_6': 2.63348,
    '36_7': 3.10984,
    '36_8': 3.59993,
    '36_9': 4.10335,
    '36_10': 4.61986,
    '36_11': 5.14719,
    '36_12': 5.68240,
    '36_13': 6.22315,
    '36_14': 6.76787,
    '36_15': 7.31520,
    '37_1': 0.44240,
    '37_2': 0.89043,
    '37_3': 1.34659,
    '37_4': 1.81319,
    '37_5': 2.29417,
    '37_6': 2.78850,
    '37_7': 3.29709,
    '37_8': 3.81951,
    '37_9': 4.35550,
    '37_10': 4.90273,
    '37_11': 5.45815,
    '37_12': 6.01930,
    '37_13': 6.58457,
    '37_14': 7.15256,
    '37_15': 7.72406,
    '38_1': 0.46502,
    '38_2': 0.93847,
    '38_3': 1.42276,
    '38_4': 1.92198,
    '38_5': 2.43506,
    '38_6': 2.96292,
    '38_7': 3.50515,
    '38_8': 4.06147,
    '38_9': 4.62944,
    '38_10': 5.20592,
    '38_11': 5.78835,
    '38_12': 6.37505,
    '38_13': 6.96457,
    '38_14': 7.55774,
    '38_15': 8.15467,
    '39_1': 0.49150,
    '39_2': 0.99425,
    '39_3': 1.51250,
    '39_4': 2.04514,
    '39_5': 2.59312,
    '39_6': 3.15602,
    '39_7': 3.73354,
    '39_8': 4.32317,
    '39_9': 4.92162,
    '39_10': 5.52625,
    '39_11': 6.13532,
    '39_12': 6.74731,
    '39_13': 7.36309,
    '39_14': 7.98277,
    '39_15': 8.60604,
    '40_1': 0.52204,
    '40_2': 1.06016,
    '40_3': 1.61323,
    '40_4': 2.18224,
    '40_5': 2.76672,
    '40_6': 3.36640,
    '40_7': 3.97864,
    '40_8': 4.60004,
    '40_9': 5.22786,
    '40_10': 5.86030,
    '40_11': 6.49576,
    '40_12': 7.13516,
    '40_13': 7.77861,
    '40_14': 8.42579,
    '40_15': 9.07719,
    '41_1': 0.55891,
    '41_2': 1.13335,
    '41_3': 1.72434,
    '41_4': 2.33140,
    '41_5': 2.95425,
    '41_6': 3.59014,
    '41_7': 4.23555,
    '41_8': 4.88762,
    '41_9': 5.54449,
    '41_10': 6.20451,
    '41_11': 6.86861,
    '41_12': 7.53691,
    '41_13': 8.20909,
    '41_14': 8.88565,
    '41_15': 9.56575,
    '42_1': 0.59682,
    '42_2': 1.21083,
    '42_3': 1.84155,
    '42_4': 2.48867,
    '42_5': 3.14934,
    '42_6': 3.81990,
    '42_7': 4.49738,
    '42_8': 5.17983,
    '42_9': 5.86557,
    '42_10': 6.55555,
    '42_11': 7.24989,
    '42_12': 7.94826,
    '42_13': 8.65119,
    '42_14': 9.35778,
    '42_15': 10.06726,
    '43_1': 0.63815,
    '43_2': 1.29366,
    '43_3': 1.96621,
    '43_4': 2.65285,
    '43_5': 3.34977,
    '43_6': 4.05388,
    '43_7': 4.76316,
    '43_8': 5.47585,
    '43_9': 6.19295,
    '43_10': 6.91459,
    '43_11': 7.64040,
    '43_12': 8.37096,
    '43_13': 9.10533,
    '43_14': 9.84270,
    '43_15': 10.59404,
    '44_1': 0.68152,
    '44_2': 1.38076,
    '44_3': 2.09464,
    '44_4': 2.81921,
    '44_5': 3.55126,
    '44_6': 4.28869,
    '44_7': 5.02965,
    '44_8': 5.77521,
    '44_9': 6.52548,
    '44_10': 7.28010,
    '44_11': 8.03964,
    '44_12': 8.80315,
    '44_13': 9.56978,
    '44_14': 10.35093,
    '44_15': 11.15041,
    '45_1': 0.72726,
    '45_2': 1.46975,
    '45_3': 2.22335,
    '45_4': 2.98473,
    '45_5': 3.75171,
    '45_6': 4.52237,
    '45_7': 5.29780,
    '45_8': 6.07813,
    '45_9': 6.86299,
    '45_10': 7.65297,
    '45_11': 8.44707,
    '45_12': 9.24442,
    '45_13': 10.05688,
    '45_14': 10.88839,
    '45_15': 11.74916,
    '46_1': 0.77255,
    '46_2': 1.55666,
    '46_3': 2.34887,
    '46_4': 3.14690,
    '46_5': 3.94876,
    '46_6': 4.75558,
    '46_7': 5.56751,
    '46_8': 6.38414,
    '46_9': 7.20611,
    '46_10': 8.03236,
    '46_11': 8.86198,
    '46_12': 9.70733,
    '46_13': 10.57251,
    '46_14': 11.46812,
    '46_15': 12.39053,
    '47_1': 0.81618,
    '47_2': 1.64078,
    '47_3': 2.47145,
    '47_4': 3.30610,
    '47_5': 4.14591,
    '47_6': 4.99105,
    '47_7': 5.84108,
    '47_8': 6.69665,
    '47_9': 7.55669,
    '47_10': 8.42025,
    '47_11': 9.30017,
    '47_12': 10.20072,
    '47_13': 11.13297,
    '47_14': 12.09309,
    '47_15': 13.08927,
    '48_1': 0.85865,
    '48_2': 1.72362,
    '48_3': 2.59273,
    '48_4': 3.46722,
    '48_5': 4.34725,
    '48_6': 5.23237,
    '48_7': 6.12328,
    '48_8': 7.01883,
    '48_9': 7.91804,
    '48_10': 8.83429,
    '48_11': 9.77203,
    '48_12': 10.74277,
    '48_13': 11.74253,
    '48_14': 12.77985,
    '48_15': 13.85026,
    '49_1': 0.90101,
    '49_2': 1.80634,
    '49_3': 2.71728,
    '49_4': 3.63398,
    '49_5': 4.55600,
    '49_6': 5.48403,
    '49_7': 6.41690,
    '49_8': 7.35359,
    '49_9': 8.30802,
    '49_10': 9.28484,
    '49_11': 10.29603,
    '49_12': 11.33747,
    '49_13': 12.41801,
    '49_14': 13.53303,
    '49_15': 14.67760,
    '50_1': 0.94341,
    '50_2': 1.89266,
    '50_3': 2.84792,
    '50_4': 3.80871,
    '50_5': 4.77578,
    '50_6': 5.74789,
    '50_7': 6.72397,
    '50_8': 7.71854,
    '50_9': 8.73645,
    '50_10': 9.79017,
    '50_11': 10.87540,
    '50_12': 12.00140,
    '50_13': 13.16331,
    '50_14': 14.35602,
    '50_15': 15.58659,
    '51_1': 0.98954,
    '51_2': 1.98534,
    '51_3': 2.98691,
    '51_4': 3.99503,
    '51_5': 5.00839,
    '51_6': 6.02591,
    '51_7': 7.06270,
    '51_8': 8.12381,
    '51_9': 9.22225,
    '51_10': 10.35354,
    '51_11': 11.52733,
    '51_12': 12.73855,
    '51_13': 13.98189,
    '51_14': 15.26469,
    '51_15': 16.58036,
    '52_1': 1.03849,
    '52_2': 2.08299,
    '52_3': 3.13431,
    '52_4': 4.19112,
    '52_5': 5.25224,
    '52_6': 6.33347,
    '52_7': 7.44006,
    '52_8': 8.58559,
    '52_9': 9.76537,
    '52_10': 10.98947,
    '52_11': 12.25261,
    '52_12': 13.54924,
    '52_13': 14.88702,
    '52_14': 16.25909,
    '52_15': 17.66175,
    '53_1': 1.08974,
    '53_2': 2.18659,
    '53_3': 3.28916,
    '53_4': 4.39624,
    '53_5': 5.52430,
    '53_6': 6.67881,
    '53_7': 7.87395,
    '53_8': 9.10483,
    '53_9': 10.38194,
    '53_10': 11.69978,
    '53_11': 13.05257,
    '53_12': 14.44828,
    '53_13': 15.87977,
    '53_14': 17.34318,
    '53_15': 18.82044,
    '54_1': 1.14487,
    '54_2': 2.29570,
    '54_3': 3.45124,
    '54_4': 4.62868,
    '54_5': 5.83373,
    '54_6': 7.08118,
    '54_7': 8.36594,
    '54_8': 9.69896,
    '54_9': 11.07449,
    '54_10': 12.48649,
    '54_11': 13.94331,
    '54_12': 15.43745,
    '54_13': 16.96493,
    '54_14': 18.50685,
    '54_15': 20.06160,
    '55_1': 1.20179,
    '55_2': 2.40849,
    '55_3': 3.63806,
    '55_4': 4.89647,
    '55_5': 6.19915,
    '55_6': 7.54080,
    '55_7': 8.93283,
    '55_8': 10.36927,
    '55_9': 11.84379,
    '55_10': 13.36510,
    '55_11': 14.92541,
    '55_12': 16.52051,
    '55_13': 18.13071,
    '55_14': 19.75429,
    '55_15': 21.38878,
    '56_1': 1.26076,
    '56_2': 2.54540,
    '56_3': 3.86018,
    '56_4': 5.22122,
    '56_5': 6.62297,
    '56_6': 8.07736,
    '56_7': 9.57814,
    '56_8': 11.11871,
    '56_9': 12.70817,
    '56_10': 14.33837,
    '56_11': 16.00492,
    '56_12': 17.68725,
    '56_13': 19.38356,
    '56_14': 21.09127,
    '56_15': 22.80859,
    '57_1': 1.34288,
    '57_2': 2.71727,
    '57_3': 4.14000,
    '57_4': 5.60529,
    '57_5': 7.12561,
    '57_6': 8.69443,
    '57_7': 10.30484,
    '57_8': 11.96636,
    '57_9': 13.67046,
    '57_10': 15.41256,
    '57_11': 17.17116,
    '57_12': 18.94437,
    '57_13': 20.72949,
    '57_14': 22.52466,
    '57_15': 24.32701,
    '58_1': 1.43772,
    '58_2': 2.92602,
    '58_3': 4.45884,
    '58_4': 6.04922,
    '58_5': 7.69033,
    '58_6': 9.37496,
    '58_7': 11.11304,
    '58_8': 12.89567,
    '58_9': 14.71806,
    '58_10': 16.55770,
    '58_11': 18.41262,
    '58_12': 20.28001,
    '58_13': 22.15790,
    '58_14': 24.04331,
    '58_15': 25.93102,
    '59_1': 1.55818,
    '59_2': 3.16296,
    '59_3': 4.82802,
    '59_4': 6.54618,
    '59_5': 8.30990,
    '59_6': 10.12959,
    '59_7': 11.99592,
    '59_8': 13.90387,
    '59_9': 15.82988,
    '59_10': 17.77190,
    '59_11': 19.72695,
    '59_12': 21.69302,
    '59_13': 23.66695,
    '59_14': 25.64329,
    '59_15': 27.61668,
    '60_1': 1.68190,
    '60_2': 3.42697,
    '60_3': 5.22771,
    '60_4': 7.07618,
    '60_5': 8.98332,
    '60_6': 10.93933,
    '60_7': 12.93897,
    '60_8': 14.95753,
    '60_9': 16.99288,
    '60_10': 19.04189,
    '60_11': 21.10244,
    '60_12': 23.17122,
    '60_13': 25.24253,
    '60_14': 27.31076,
    '60_15': 29.37140,
    '61_1': 1.83091,
    '61_2': 3.72023,
    '61_3': 5.65963,
    '61_4': 7.66059,
    '61_5': 9.71282,
    '61_6': 11.81083,
    '61_7': 13.92869,
    '61_8': 16.06416,
    '61_9': 18.21396,
    '61_10': 20.37587,
    '61_11': 22.54643,
    '61_12': 24.71963,
    '61_13': 26.88960,
    '61_14': 29.05161,
    '61_15': 31.20249,
    '62_1': 1.98485,
    '62_2': 4.02232,
    '62_3': 6.12445,
    '62_4': 8.28045,
    '62_5': 10.48454,
    '62_6': 12.70949,
    '62_7': 14.95294,
    '62_8': 17.21145,
    '62_9': 19.48268,
    '62_10': 21.76299,
    '62_11': 24.04607,
    '62_12': 26.32577,
    '62_13': 28.59710,
    '62_14': 30.85674,
    '62_15': 33.10174,
    '63_1': 2.14339,
    '63_2': 4.35480,
    '63_3': 6.62289,
    '63_4': 8.94156,
    '63_5': 11.28218,
    '63_6': 13.64225,
    '63_7': 16.01817,
    '63_8': 18.40747,
    '63_9': 20.80632,
    '63_10': 23.20810,
    '63_11': 25.60631,
    '63_12': 27.99571,
    '63_13': 30.37283,
    '63_14': 32.73453,
    '63_15': 35.07561,
    '64_1': 2.32962,
    '64_2': 4.71895,
    '64_3': 7.16156,
    '64_4': 9.62729,
    '64_5': 12.11352,
    '64_6': 14.61644,
    '64_7': 17.13346,
    '64_8': 19.66054,
    '64_9': 22.19070,
    '64_10': 24.71710,
    '64_11': 27.23423,
    '64_12': 29.73841,
    '64_13': 32.22636,
    '64_14': 34.69258,
    '64_15': 37.13367,
    '65_1': 2.52118,
    '65_2': 5.09858,
    '65_3': 7.70038,
    '65_4': 10.32381,
    '65_5': 12.96485,
    '65_6': 15.62077,
    '65_7': 18.28730,
    '65_8': 20.95709,
    '65_9': 23.62290,
    '65_10': 26.27894,
    '65_11': 28.92130,
    '65_12': 31.54655,
    '65_13': 34.14886,
    '65_14': 36.72466,
    '65_15': 39.27507,
  };
  final Map<String, double> tarifsPerteEmploi = {
    '1': 19.20,
    '2': 38.40,
    '3': 57.60,
    '4': 76.80,
    '5': 96.00,
    '6': 115.20,
  };

  @override
  void initState() {
    super.initState();

    _animationController = AnimationController(
      duration: Duration(milliseconds: 800),
      vsync: this,
    );
    _progressController = AnimationController(
      duration: Duration(milliseconds: 1000),
      vsync: this,
    );
    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );
    _slideAnimation = Tween<double>(begin: 50.0, end: 0.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeOutCubic),
    );
    _animationController.forward();

    if (widget.existingData != null) {
      _prefillFromExistingData();
    } else {
      _prefillSimulationData();
    }
  }

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    // Vérifier si c'est un commercial qui fait la souscription
    // On fait ça dans didChangeDependencies car on accède à ModalRoute
    final args =
        ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
    if (args != null && args['isCommercial'] == true) {
      if (!_isCommercial) {
        setState(() {
          _isCommercial = true;
        });
      }

      // Pré-remplir les champs avec les informations du client si disponibles
      if (args['clientInfo'] != null) {
        final clientInfo = args['clientInfo'] as Map<String, dynamic>;
        _clientNomController.text = clientInfo['nom'] ?? '';
        _clientPrenomController.text = clientInfo['prenom'] ?? '';
        _clientEmailController.text = clientInfo['email'] ?? '';
        _clientTelephoneController.text = clientInfo['telephone'] ?? '';
        _clientLieuNaissanceController.text =
            clientInfo['lieu_naissance'] ?? '';
        _clientAdresseController.text = clientInfo['adresse'] ?? '';
        _clientNumeroPieceController.text =
            clientInfo['numero_piece_identite'] ?? '';

        if (clientInfo['civilite'] != null) {
          _selectedClientCivilite = clientInfo['civilite'];
        }

        // Gérer la date de naissance
        if (clientInfo['date_naissance'] != null) {
          try {
            DateTime? dateNaissance;
            if (clientInfo['date_naissance'] is String) {
              dateNaissance = DateTime.parse(clientInfo['date_naissance']);
            } else if (clientInfo['date_naissance'] is DateTime) {
              dateNaissance = clientInfo['date_naissance'];
            }

            if (dateNaissance != null) {
              final finalDate = dateNaissance;
              setState(() {
                _clientDateNaissance = finalDate;
                _clientDateNaissanceController.text =
                    '${finalDate.day.toString().padLeft(2, '0')}/${finalDate.month.toString().padLeft(2, '0')}/${finalDate.year}';
                final now = DateTime.now();
                _clientAge = now.year - finalDate.year;
                if (now.month < finalDate.month ||
                    (now.month == finalDate.month && now.day < finalDate.day)) {
                  _clientAge--;
                }
                // Utiliser l'âge du client pour le calcul
                _age = _clientAge;
              });
            }
          } catch (e) {
            print('Erreur parsing date de naissance: $e');
          }
        }

        // Extraire l'indicatif du téléphone si présent
        final telephone = clientInfo['telephone'] ?? '';
        if (telephone.isNotEmpty && telephone.startsWith('+')) {
          final parts = telephone.split(' ');
          if (parts.isNotEmpty) {
            _selectedClientIndicatif = parts[0];
            if (parts.length > 1) {
              _clientTelephoneController.text = parts.sublist(1).join(' ');
            }
          }
        }
      }
    }

    if (!_isCommercial) {
      _loadUserData();
    }
  }

  void _prefillSimulationData() {
    if (widget.simulationData != null) {
      final data = widget.simulationData!;
      setState(() {
        _selectedTypePret = data['typePret'] ?? 'Prêt amortissable';
        _capitalController.text = data['capital'] != null
            ? _formatNumber(data['capital'].toDouble())
            : '';
        _dureeController.text = data['duree']?.toString() ?? '';
        _selectedDureeType = data['dureeType'] ?? 'mois';
        _garantiePrevoyance = data['garantiePrevoyance'] ?? false;
        _garantiePerteEmploi = data['garantiePerteEmploi'] ?? false;

        if (_garantiePrevoyance && data['capitalPrevoyance'] != null) {
          _capitalPrevoyanceController.text =
              _formatNumber(data['capitalPrevoyance'].toDouble());
        }

        if (_garantiePerteEmploi && data['capitalPerteEmploi'] != null) {
          _capitalPerteEmploiController.text =
              _formatNumber(data['capitalPerteEmploi'].toDouble());
        }
      });
    }
  }

  /// Méthode pour pré-remplir les champs depuis une proposition existante
  void _prefillFromExistingData() {
    if (widget.existingData == null) return;

    final data = widget.existingData!;
    debugPrint('🔄 Pré-remplissage FLEX depuis données existantes');

    // Détecter si c'est une souscription par commercial (présence de client_info)
    if (data['client_info'] != null) {
      _isCommercial = true;
      final clientInfo = data['client_info'] as Map<String, dynamic>;
      _clientNomController.text = clientInfo['nom'] ?? '';
      _clientPrenomController.text = clientInfo['prenom'] ?? '';
      _clientEmailController.text = clientInfo['email'] ?? '';
      _clientTelephoneController.text = clientInfo['telephone'] ?? '';
      _clientLieuNaissanceController.text = clientInfo['lieu_naissance'] ?? '';
      _clientAdresseController.text = clientInfo['adresse'] ?? '';
      _clientNumeroPieceController.text =
          clientInfo['numero_piece_identite'] ?? '';
      if (clientInfo['civilite'] != null)
        _selectedClientCivilite = clientInfo['civilite'];
      if (clientInfo['date_naissance'] != null) {
        try {
          DateTime? dateNaissance;
          if (clientInfo['date_naissance'] is String) {
            dateNaissance = DateTime.parse(clientInfo['date_naissance']);
          } else if (clientInfo['date_naissance'] is DateTime) {
            dateNaissance = clientInfo['date_naissance'];
          }
          if (dateNaissance != null) {
            _clientDateNaissance = dateNaissance;
            _clientDateNaissanceController.text =
                '${dateNaissance.day.toString().padLeft(2, '0')}/${dateNaissance.month.toString().padLeft(2, '0')}/${dateNaissance.year}';
            final maintenant = DateTime.now();
            _clientAge = maintenant.year - dateNaissance.year;
            if (maintenant.month < dateNaissance.month ||
                (maintenant.month == dateNaissance.month &&
                    maintenant.day < dateNaissance.day)) {
              _clientAge--;
            }
            _age = _clientAge;
          }
        } catch (e) {
          debugPrint('Erreur parsing date de naissance client: $e');
        }
      }
      final telephone = clientInfo['telephone'] ?? '';
      if (telephone.isNotEmpty && telephone.startsWith('+')) {
        final parts = telephone.split(' ');
        if (parts.isNotEmpty) {
          _selectedClientIndicatif = parts[0];
          if (parts.length > 1)
            _clientTelephoneController.text = parts.sublist(1).join(' ');
        }
      }
    }

    try {
      setState(() {
        // FLEX-specific fields
        if (data['type_pret'] != null) _selectedTypePret = data['type_pret'];
        if (data['capital'] != null) {
          _capitalController.text = _formatNumber(data['capital'] is double
              ? data['capital']
              : double.parse(data['capital'].toString()));
        }
        if (data['duree'] != null)
          _dureeController.text = data['duree'].toString();
        if (data['duree_type'] != null) _selectedDureeType = data['duree_type'];
        if (data['garantie_prevoyance'] != null)
          _garantiePrevoyance = data['garantie_prevoyance'] == true ||
              data['garantie_prevoyance'] == 1;
        if (data['garantie_perte_emploi'] != null)
          _garantiePerteEmploi = data['garantie_perte_emploi'] == true ||
              data['garantie_perte_emploi'] == 1;

        if (_garantiePrevoyance && data['capital_prevoyance'] != null) {
          _capitalPrevoyanceController.text = _formatNumber(
              data['capital_prevoyance'] is double
                  ? data['capital_prevoyance']
                  : double.parse(data['capital_prevoyance'].toString()));
        }
        if (_garantiePerteEmploi && data['capital_perte_emploi'] != null) {
          _capitalPerteEmploiController.text = _formatNumber(
              data['capital_perte_emploi'] is double
                  ? data['capital_perte_emploi']
                  : double.parse(data['capital_perte_emploi'].toString()));
        }

        if (data['prime_prevoyance'] != null)
          _primePrevoyance = data['prime_prevoyance'] is double
              ? data['prime_prevoyance']
              : double.parse(data['prime_prevoyance'].toString());
        if (data['prime_perte_emploi'] != null)
          _primePerteEmploi = data['prime_perte_emploi'] is double
              ? data['prime_perte_emploi']
              : double.parse(data['prime_perte_emploi'].toString());
        if (data['prime_annuelle'] != null)
          _calculatedPrime = data['prime_annuelle'] is double
              ? data['prime_annuelle']
              : double.parse(data['prime_annuelle'].toString());
        if (data['capital_garanti'] != null)
          _calculatedCapital = data['capital_garanti'] is double
              ? data['capital_garanti']
              : double.parse(data['capital_garanti'].toString());

        // Dates
        if (data['date_effet'] != null) {
          try {
            _dateEffetContrat = DateTime.parse(data['date_effet'].toString());
          } catch (e) {
            debugPrint('⚠️ Erreur parsing date_effet: $e');
          }
        }
        if (data['date_echeance'] != null) {
          try {
            _dateEcheanceContrat =
                DateTime.parse(data['date_echeance'].toString());
          } catch (e) {
            debugPrint('⚠️ Erreur parsing date_echeance: $e');
          }
        }
      });

      // Bénéficiaire
      if (data['beneficiaire'] != null && data['beneficiaire'] is Map) {
        final beneficiaire = data['beneficiaire'];
        if (beneficiaire['nom'] != null) {
          _beneficiaireNomController.text = beneficiaire['nom'].toString();
        }
        if (beneficiaire['contact'] != null) {
          final contact = beneficiaire['contact'].toString();
          final parts = contact.split(' ');
          if (parts.length >= 2) {
            _selectedBeneficiaireIndicatif = parts[0];
            _beneficiaireContactController.text = parts.sublist(1).join(' ');
          }
        }
        if (beneficiaire['lien_parente'] != null) {
          _selectedLienParente = beneficiaire['lien_parente'].toString();
        }
      }

      // Contact d'urgence
      if (data['contact_urgence'] != null && data['contact_urgence'] is Map) {
        final contactUrgence = data['contact_urgence'];
        if (contactUrgence['nom'] != null) {
          _personneContactNomController.text = contactUrgence['nom'].toString();
        }
        if (contactUrgence['contact'] != null) {
          final contact = contactUrgence['contact'].toString();
          final parts = contact.split(' ');
          if (parts.length >= 2) {
            _selectedContactIndicatif = parts[0];
            _personneContactTelController.text = parts.sublist(1).join(' ');
          }
        }
        if (contactUrgence['lien_parente'] != null) {
          _selectedLienParenteUrgence =
              contactUrgence['lien_parente'].toString();
        }
      }

      // Client info if commercial
      if (data['client_info'] != null && data['client_info'] is Map) {
        final clientInfo = data['client_info'];
        _isCommercial = true;

        if (clientInfo['nom'] != null)
          _clientNomController.text = clientInfo['nom'].toString();
        if (clientInfo['prenom'] != null)
          _clientPrenomController.text = clientInfo['prenom'].toString();
        if (clientInfo['email'] != null)
          _clientEmailController.text = clientInfo['email'].toString();
        if (clientInfo['lieu_naissance'] != null)
          _clientLieuNaissanceController.text =
              clientInfo['lieu_naissance'].toString();
        if (clientInfo['adresse'] != null)
          _clientAdresseController.text = clientInfo['adresse'].toString();
        if (clientInfo['civilite'] != null)
          _selectedClientCivilite = clientInfo['civilite'].toString();
        if (clientInfo['numero_piece_identite'] != null)
          _clientNumeroPieceController.text =
              clientInfo['numero_piece_identite'].toString();

        if (clientInfo['telephone'] != null) {
          final telephone = clientInfo['telephone'].toString();
          final parts = telephone.split(' ');
          if (parts.length >= 2) {
            _selectedClientIndicatif = parts[0];
            _clientTelephoneController.text = parts.sublist(1).join(' ');
          }
        }

        if (clientInfo['date_naissance'] != null) {
          try {
            _clientDateNaissance =
                DateTime.parse(clientInfo['date_naissance'].toString());
            _clientDateNaissanceController.text =
                "${_clientDateNaissance!.day.toString().padLeft(2, '0')}/${_clientDateNaissance!.month.toString().padLeft(2, '0')}/${_clientDateNaissance!.year}";
            final now = DateTime.now();
            _clientAge = now.year - _clientDateNaissance!.year;
            if (now.month < _clientDateNaissance!.month ||
                (now.month == _clientDateNaissance!.month &&
                    now.day < _clientDateNaissance!.day)) {
              _clientAge--;
            }
          } catch (e) {
            debugPrint('⚠️ Erreur parsing date_naissance client: $e');
          }
        }
      }

      debugPrint('✅ Pré-remplissage FLEX terminé');
    } catch (e) {
      debugPrint('❌ Erreur pré-remplissage FLEX: $e');
    }
  }

  Future<void> _loadUserData() async {
    try {
      final token = await storage.read(key: 'token');
      if (token == null) return;

      final response = await http.get(
        Uri.parse('${AppConfig.baseUrl}/users/profile'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        Map<String, dynamic>? userData;

        // 1) Cas standard: { success: true, user: { ... } }
        if (data['success'] == true &&
            data['user'] != null &&
            data['user'] is Map) {
          userData = Map<String, dynamic>.from(data['user']);
        }
        // 2) Cas nested: { success: true, data: { ... } }
        else if (data['success'] == true &&
            data['data'] != null &&
            data['data'] is Map) {
          userData = Map<String, dynamic>.from(data['data']);
        }
        // 3) Direct user object
        else if (data is Map && data.containsKey('id')) {
          userData = Map<String, dynamic>.from(data);
        }

        if (userData != null && userData.isNotEmpty) {
          if (mounted) {
            setState(() {
              _userData = userData!;
              if (_userData['date_naissance'] != null) {
                _dateNaissance = DateTime.parse(_userData['date_naissance']);
                final maintenant = DateTime.now();
                _age = maintenant.year - _dateNaissance!.year;
                if (maintenant.month < _dateNaissance!.month ||
                    (maintenant.month == _dateNaissance!.month &&
                        maintenant.day < _dateNaissance!.day)) {
                  _age--;
                }
              }
            });

            if (_age > 0) {
              _effectuerCalcul();
            }
          }
        }
      }
    } catch (e) {
      debugPrint('Erreur chargement données utilisateur: $e');
    }
  }

  String _formatNumber(double number) {
    return number.toStringAsFixed(0).replaceAllMapped(
          RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
          (Match m) => '${m[1]} ',
        );
  }

  double _parseDouble(String text) {
    final cleaned = text.replaceAll(' ', '').replaceAll(',', '.');
    return double.tryParse(cleaned) ?? 0.0;
  }

  int _parseInt(String text) {
    final cleaned = text.replaceAll(' ', '');
    return int.tryParse(cleaned) ?? 0;
  }

  void _formatTextField(TextEditingController controller) {
    String text = controller.text.replaceAll(' ', '');
    if (text.isNotEmpty) {
      double? value = double.tryParse(text);
      if (value != null) {
        String formatted = _formatNumber(value);
        if (formatted != controller.text) {
          controller.value = controller.value.copyWith(
            text: formatted,
            selection: TextSelection.collapsed(offset: formatted.length),
          );
        }
      }
    }
  }

  double _findRateInMap({
    required Map<String, double> table,
    required int age,
    required int dureeMois,
  }) {
    final exactKey = '${age}_$dureeMois';
    if (table.containsKey(exactKey)) {
      return table[exactKey]!;
    }

    final possibleKeys =
        table.keys.where((key) => key.startsWith('${age}_')).toList();
    if (possibleKeys.isNotEmpty) {
      possibleKeys.sort((a, b) {
        final dureeA = int.tryParse(a.split('_')[1]) ?? 0;
        final dureeB = int.tryParse(b.split('_')[1]) ?? 0;
        return (dureeA - dureeMois).abs().compareTo((dureeB - dureeMois).abs());
      });
      return table[possibleKeys.first]!;
    }

    final allAges = table.keys
        .map((key) => int.tryParse(key.split('_')[0]) ?? 0)
        .toSet()
        .toList();
    allAges.sort((a, b) => (a - age).abs().compareTo((b - age).abs()));

    if (allAges.isNotEmpty) {
      final closestAge = allAges.first;
      final closestAgeKeys =
          table.keys.where((key) => key.startsWith('${closestAge}_')).toList();
      if (closestAgeKeys.isNotEmpty) {
        closestAgeKeys.sort((a, b) {
          final dureeA = int.tryParse(a.split('_')[1]) ?? 0;
          final dureeB = int.tryParse(b.split('_')[1]) ?? 0;
          return (dureeA - dureeMois)
              .abs()
              .compareTo((dureeB - dureeMois).abs());
        });
        return table[closestAgeKeys.first]!;
      }
    }

    return 0.0;
  }

  double _findRatePerteEmploi(int dureeAnnees, Map<String, double> table) {
    if (dureeAnnees > 6) {
      dureeAnnees = 6;
    }

    String cle = dureeAnnees.toString();
    return table[cle] ?? 0.0;
  }

  void _effectuerCalcul() {
    // Ne pas calculer si l'âge n'est pas encore déterminé
    if (_age <= 0) {
      return;
    }

    double capital = _parseDouble(_capitalController.text);
    if (capital <= 0) return;

    // Vérification du montant maximum (30 000 000 FCFA)
    if (capital > 30000000) {
      _showProfessionalDialog(
        title: 'Limite de capital dépassée',
        message:
            'Le montant maximum du prêt à couvrir pour FLEX EMPRUNTEUR est de 30 000 000 FCFA. Le montant a été ajusté automatiquement.',
        icon: Icons.monetization_on_outlined,
        iconColor: orangeWarning,
        backgroundColor: orangeWarning,
      );
      capital = 30000000;
      _capitalController.text = _formatNumber(capital);
    }

    int duree = _parseInt(_dureeController.text);
    int dureeMois = _selectedDureeType == 'années' ? duree * 12 : duree;
    int dureeAnnees =
        _selectedDureeType == 'années' ? duree : (dureeMois / 12).ceil();

    final maintenant = DateTime.now();
    _dateEffetContrat = maintenant;

    if (_selectedDureeType == 'années') {
      _dateEcheanceContrat = DateTime(
        maintenant.year + duree,
        maintenant.month,
        maintenant.day,
      );
    } else {
      int newMonth = maintenant.month + duree;
      int newYear = maintenant.year;

      if (newMonth > 12) {
        newYear += newMonth ~/ 12;
        newMonth = newMonth % 12;
        if (newMonth == 0) {
          newMonth = 12;
          newYear -= 1;
        }
      }

      _dateEcheanceContrat = DateTime(
        newYear,
        newMonth,
        maintenant.day,
      );
    }

    double rateBase;
    if (_selectedTypePret == 'Prêt amortissable' ||
        _selectedTypePret == 'Prêt scolaire') {
      rateBase = _findRateInMap(
        table: tarifsPretAmortissable,
        age: _age,
        dureeMois: dureeMois,
      );
    } else {
      rateBase = _findRateInMap(
        table: tarifsPretDecouvert,
        age: _age,
        dureeMois: dureeMois,
      );
    }

    final rateBaseDecimal = rateBase / 100;
    final primeBase = (capital * rateBaseDecimal).clamp(0, double.infinity);

    double primePrevoyance = 0.0;
    if (_garantiePrevoyance && _selectedTypePret != 'Prêt scolaire') {
      final capitalPrev = _parseDouble(_capitalPrevoyanceController.text);
      final ratePrev = _findRateInMap(
        table: tarifsPretDecouvert,
        age: _age,
        dureeMois: dureeMois,
      );

      final ratePrevDecimal = ratePrev / 100;
      primePrevoyance =
          (capitalPrev * ratePrevDecimal).clamp(0, double.infinity);
    }

    double primePerteEmploi = 0.0;
    if (_garantiePerteEmploi && _selectedTypePret != 'Prêt scolaire') {
      final capitalPE = _parseDouble(_capitalPerteEmploiController.text);
      final ratePE = _findRatePerteEmploi(dureeAnnees, tarifsPerteEmploi);

      final ratePEDecimal = ratePE / 100;
      primePerteEmploi = (capitalPE * ratePEDecimal).clamp(0, double.infinity);
    }

    final primeTotal = primeBase + primePrevoyance + primePerteEmploi;

    setState(() {
      _calculatedPrime = primeTotal;
      _calculatedCapital = capital;
      _primePrevoyance = primePrevoyance;
      _primePerteEmploi = primePerteEmploi;
    });
  }

  String _formatMontant(double montant) {
    return "${montant.toStringAsFixed(0).replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]} ')} FCFA";
  }

  Future<void> _pickDocument() async {
    try {
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['pdf', 'jpg', 'jpeg', 'png'],
      );

      if (result != null) {
        if (mounted) {
          setState(() {
            _pieceIdentite = File(result.files.single.path!);
          });

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  Icon(Icons.check_circle, color: blanc),
                  SizedBox(width: 12),
                  Text('Document ajouté avec succès'),
                ],
              ),
              backgroundColor: vertSucces,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12)),
              margin: EdgeInsets.all(16),
            ),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        _showErrorSnackBar('Erreur lors de la sélection du fichier');
      }
    }
  }

  void _showErrorSnackBar(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(children: [
          Icon(Icons.error_outline, color: blanc),
          SizedBox(width: 12),
          Expanded(child: Text(message))
        ]),
        backgroundColor: rougeCoris,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        margin: EdgeInsets.all(16),
      ),
    );
  }

  void _showProfessionalDialog({
    required String title,
    required String message,
    required IconData icon,
    required Color iconColor,
    required Color backgroundColor,
  }) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          elevation: 16,
          child: Container(
            constraints: BoxConstraints(
              maxWidth: MediaQuery.of(context).size.width * 0.9,
            ),
            padding: const EdgeInsets.all(28),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              color: Colors.white,
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Color.alphaBlend(
                        backgroundColor.withAlpha(25), Colors.white),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    icon,
                    size: 48,
                    color: iconColor,
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: bleuCoris,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),
                Text(
                  message,
                  style: const TextStyle(
                    fontSize: 14,
                    color: Colors.black87,
                    height: 1.5,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 28),
                SizedBox(
                  width: double.infinity,
                  height: 48,
                  child: ElevatedButton(
                    onPressed: () => Navigator.of(context).pop(),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: bleuCoris,
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 4,
                    ),
                    child: const Text(
                      'Compris',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  void _nextStep() {
    final maxStep = _isCommercial ? 3 : 2;
    if (_currentStep < maxStep) {
      bool canProceed = false;

      if (_isCommercial) {
        // Pour les commerciaux: step 0 = infos client, step 1 = simulation, step 2 = bénéficiaire
        if (_currentStep == 0 && _validateStepClientInfo()) {
          canProceed = true;
        } else if (_currentStep == 1 && _validateStep1()) {
          canProceed = true;
        } else if (_currentStep == 2 && _validateStep2()) {
          canProceed = true;
        }
      } else {
        // Pour les clients: step 0 = simulation, step 1 = bénéficiaire
        if (_currentStep == 0 && _validateStep1()) {
          canProceed = true;
        } else if (_currentStep == 1 && _validateStep2()) {
          canProceed = true;
        }
      }

      if (canProceed) {
        // If we're about to show the recap, ensure the calculation runs
        if (_currentStep + 1 == maxStep) {
          try {
            _effectuerCalcul();
          } catch (e) {
            debugPrint('Erreur lors du calcul avant récapitulatif: $e');
          }
        }
        setState(() => _currentStep++);
        _progressController.forward();
        _animationController.reset();
        _animationController.forward();

        _pageController.nextPage(
          duration: Duration(milliseconds: 400),
          curve: Curves.easeInOutCubic,
        );
      }
    }
  }

  void _previousStep() {
    if (_currentStep > 0) {
      setState(() => _currentStep--);
      _progressController.reverse();
      _animationController.reset();
      _animationController.forward();

      _pageController.previousPage(
        duration: Duration(milliseconds: 400),
        curve: Curves.easeInOutCubic,
      );
    }
  }

  bool _validateStepClientInfo() {
    if (_clientNomController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez saisir le nom du client');
      return false;
    }
    if (_clientPrenomController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez saisir le prénom du client');
      return false;
    }
    if (_clientDateNaissance == null) {
      _showErrorSnackBar('Veuillez saisir la date de naissance du client');
      return false;
    }
    if (_clientAge < 18 || _clientAge > 65) {
      _showErrorSnackBar('L\'âge du client doit être entre 18 et 65 ans');
      return false;
    }
    // Email non obligatoire pour le commercial
    if (_clientTelephoneController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez saisir le téléphone du client');
      return false;
    }
    // Utiliser l'âge du client pour le calcul
    _age = _clientAge;
    // Recalculer avec le nouvel âge
    _effectuerCalcul();
    return true;
  }

  bool _validateStep1() {
    // Vérifier que la date d'effet est sélectionnée
    if (_dateEffetContrat == null) {
      _showErrorSnackBar('Veuillez sélectionner une date d\'effet pour le contrat');
      return false;
    }

    if (_capitalController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez saisir le montant du prêt à couvrir');
      return false;
    }

    if (_dureeController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez saisir la durée du contrat');
      return false;
    }

    // Pour les clients, valider l'âge depuis les données utilisateur
    if (!_isCommercial) {
      // Si c'est un client, valider son propre âge
      // À l'étape 1 (simulation), on ne valide pas l'âge car il sera calculé automatiquement
      // L'âge sera validé seulement si on essaie de passer à l'étape 2
      if (_currentStep == 0) {
        // À l'étape 1, on ne valide pas l'âge
        // L'âge sera calculé automatiquement lors du chargement des données utilisateur
        // et utilisé pour le calcul de la prime
      } else if (_currentStep == 1) {
        // À l'étape 2, on valide l'âge si disponible
        if (_dateNaissance != null) {
          // Recalculer l'âge si la date de naissance est disponible
          final maintenant = DateTime.now();
          _age = maintenant.year - _dateNaissance!.year;
          if (maintenant.month < _dateNaissance!.month ||
              (maintenant.month == _dateNaissance!.month &&
                  maintenant.day < _dateNaissance!.day)) {
            _age--;
          }

          // Valider l'âge seulement s'il est calculé
          if (_age > 0) {
            if (_age < 18 || _age > 65) {
              _showErrorSnackBar(
                  'Âge non valide (18-65 ans requis). Votre âge: $_age ans');
              return false;
            }
          }
        } else if (_age <= 0) {
          // Si l'âge n'est pas encore calculé, on ne bloque pas
          // Il sera calculé automatiquement
        }
      }
    }

    if (_garantiePrevoyance &&
        _capitalPrevoyanceController.text.trim().isEmpty) {
      _showErrorSnackBar(
          'Veuillez renseigner le capital pour la garantie Prévoyance');
      return false;
    }

    if (_garantiePerteEmploi &&
        _capitalPerteEmploiController.text.trim().isEmpty) {
      _showErrorSnackBar(
          'Veuillez renseigner le capital pour la garantie Perte d\'emploi');
      return false;
    }

    return true;
  }

  /// Parse le RIB unifié en ses composants
  Map<String, String> _parseRibUnified(String rib) {
    final cleaned = rib.replaceAll(RegExp(r'[^0-9]'), '');
    return {
      'code_guichet': cleaned.length >= 5 ? cleaned.substring(0, 5) : '',
      'numero_compte': cleaned.length >= 16 ? cleaned.substring(5, 16) : '',
      'cle_rib': cleaned.length >= 18 ? cleaned.substring(16, 18) : '',
    };
  }

  /// Valide le format du RIB unifié
  bool _validateRibUnified(String rib) {
    final cleaned = rib.replaceAll(RegExp(r'[^0-9]'), '');
    return cleaned.length == 18; // 5 + 11 + 2
  }

  /// Formate l'entrée RIB en temps réel
  void _formatRibInput() {
    String text = _ribUnifiedController.text;
    String cleaned = text.replaceAll(RegExp(r'[^0-9]'), '');

    if (cleaned.isEmpty) {
      _ribUnifiedController.value = TextEditingValue(
        text: '',
        selection: TextSelection.collapsed(offset: 0),
      );
      return;
    }

    String formatted = '';
    int cursorPosition = 0;

    // Code guichet (5 chiffres)
    if (cleaned.length > 0) {
      formatted += cleaned.substring(0, cleaned.length > 5 ? 5 : cleaned.length);
      if (cleaned.length > 5) formatted += ' / ';
    }

    // Numéro de compte (11 chiffres)
    if (cleaned.length > 5) {
      formatted +=
          cleaned.substring(5, cleaned.length > 16 ? 16 : cleaned.length);
      if (cleaned.length > 16) formatted += ' / ';
    }

    // Clé RIB (2 chiffres)
    if (cleaned.length > 16) {
      formatted +=
          cleaned.substring(16, cleaned.length > 18 ? 18 : cleaned.length);
    }

    cursorPosition = formatted.length;

    _ribUnifiedController.value = TextEditingValue(
      text: formatted,
      selection: TextSelection.collapsed(offset: cursorPosition),
    );
  }

  bool _validateStep2() {
    // Si c'est un commercial, valider aussi les infos client
    if (_isCommercial) {
      if (_clientNomController.text.trim().isEmpty ||
          _clientPrenomController.text.trim().isEmpty ||
          _clientDateNaissanceController.text.trim().isEmpty ||
          _clientLieuNaissanceController.text.trim().isEmpty ||
          _clientTelephoneController.text.trim().isEmpty ||
          // Email non obligatoire - supprimé de la validation
          _clientAdresseController.text.trim().isEmpty) {
        _showErrorSnackBar(
            'Veuillez remplir toutes les informations du client (sauf email qui est optionnel)');
        return false;
      }
    }

    if (_beneficiaireNomController.text.trim().isEmpty ||
        _beneficiaireContactController.text.trim().isEmpty ||
        _personneContactNomController.text.trim().isEmpty ||
        _personneContactTelController.text.trim().isEmpty) {
      _showErrorSnackBar('Veuillez remplir tous les champs obligatoires');
      return false;
    }
    // La pièce d'identité n'est obligatoire QUE pour une nouvelle souscription
    // En mode modification, elle est optionnelle
    if (_pieceIdentite == null && widget.subscriptionId == null) {
      _showErrorSnackBar(
          'Le téléchargement d\'une pièce d\'identité est obligatoire pour continuer.');
      return false;
    }
    return true;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: grisLeger,
      resizeToAvoidBottomInset: false,
      body: NestedScrollView(
        headerSliverBuilder: (BuildContext context, bool innerBoxIsScrolled) {
          return <Widget>[
            SliverAppBar(
              expandedHeight: 120,
              floating: false,
              pinned: true,
              elevation: 0,
              backgroundColor: bleuCoris,
              flexibleSpace: FlexibleSpaceBar(
                background: Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [bleuCoris, bleuSecondaire],
                    ),
                  ),
                  child: SafeArea(
                    child: Padding(
                      padding: EdgeInsets.symmetric(horizontal: 20),
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.end,
                        children: [
                          Row(
                            children: [
                              Icon(Icons.credit_card, color: blanc, size: 28),
                              SizedBox(width: 12),
                              Text(
                                'FLEX EMPRUNTEUR',
                                style: TextStyle(
                                  color: blanc,
                                  fontSize: 22,
                                  fontWeight: FontWeight.w700,
                                  letterSpacing: 0.5,
                                ),
                              ),
                            ],
                          ),
                          SizedBox(height: 8),
                          Text(
                            'Protégez votre prêt et votre famille',
                            style: TextStyle(
                              color: blanc.withValues(alpha: 0.9),
                              fontSize: 14,
                              fontWeight: FontWeight.w400,
                            ),
                          ),
                          SizedBox(height: 16),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
              leading: IconButton(
                icon: Icon(Icons.arrow_back_ios, color: blanc),
                onPressed: () => Navigator.pop(context),
              ),
            ),
            SliverToBoxAdapter(
              child: Container(
                margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 5),
                child: _buildModernProgressIndicator(),
              ),
            ),
          ];
        },
        body: SafeArea(
          child: Column(
            children: [
              Expanded(
                child: PageView(
                  controller: _pageController,
                  physics: NeverScrollableScrollPhysics(),
                  children: _isCommercial
                      ? [
                          _buildStepClientInfo(), // Page 0: Informations client (commercial uniquement)
                          _buildStep1(), // Page 1: Simulation
                          _buildStep2(), // Page 2: Bénéficiaire/Contact
                          _buildStep3(), // Page 3: Récapitulatif
                        ]
                      : [
                          _buildStep1(), // Page 0: Simulation
                          _buildStep2(), // Page 1: Bénéficiaire/Contact
                          _buildStep3(), // Page 2: Récapitulatif
                        ],
                ),
              ),
              _buildNavigationButtons(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildModernProgressIndicator() {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: blanc,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 20,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        children: [
          for (int i = 0; i < (_isCommercial ? 4 : 3); i++) ...[
            Expanded(
              child: Column(
                children: [
                  Container(
                    width: 36,
                    height: 36,
                    decoration: BoxDecoration(
                      color: i <= _currentStep ? bleuCoris : grisLeger,
                      shape: BoxShape.circle,
                      boxShadow: i <= _currentStep
                          ? [
                              BoxShadow(
                                color: Color.fromRGBO(0, 43, 107, 0.3),
                                blurRadius: 8,
                                offset: Offset(0, 2),
                              ),
                            ]
                          : null,
                    ),
                    child: Icon(
                      _isCommercial
                          ? (i == 0
                              ? Icons.person
                              : i == 1
                                  ? Icons.credit_card
                                  : i == 2
                                      ? Icons.person_add
                                      : Icons.check_circle)
                          : (i == 0
                              ? Icons.credit_card
                              : i == 1
                                  ? Icons.person_add
                                  : Icons.check_circle),
                      color: i <= _currentStep ? blanc : grisTexte,
                      size: 20,
                    ),
                  ),
                  SizedBox(height: 6),
                  Text(
                    _isCommercial
                        ? (i == 0
                            ? 'Client'
                            : i == 1
                                ? 'Prêt'
                                : i == 2
                                    ? 'Infos'
                                    : 'Récap')
                        : (i == 0
                            ? 'Prêt'
                            : i == 1
                                ? 'Infos'
                                : 'Récap'),
                    style: TextStyle(
                      fontSize: 11,
                      fontWeight:
                          i <= _currentStep ? FontWeight.w600 : FontWeight.w400,
                      color: i <= _currentStep ? bleuCoris : grisTexte,
                    ),
                  ),
                ],
              ),
            ),
            if (i < (_isCommercial ? 3 : 2))
              Expanded(
                child: Container(
                  height: 2,
                  margin: EdgeInsets.only(bottom: 20, left: 6, right: 6),
                  decoration: BoxDecoration(
                    color: i < _currentStep ? bleuCoris : grisLeger,
                    borderRadius: BorderRadius.circular(1),
                  ),
                ),
              ),
          ],
        ],
      ),
    );
  }

  Widget _buildStep1() {
    return AnimatedBuilder(
      animation: _fadeAnimation,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Padding(
              padding: EdgeInsets.symmetric(horizontal: 16),
              child: ListView(
                children: [
                  Container(
                    width: double.infinity,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Color.fromRGBO(0, 0, 0, 0.1),
                          blurRadius: 12,
                          offset: Offset(0, 6),
                        ),
                      ],
                    ),
                    child: Padding(
                      padding: EdgeInsets.all(16),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Container(
                                padding: EdgeInsets.all(8),
                                decoration: BoxDecoration(
                                  color: Color.fromRGBO(0, 43, 107, 0.1),
                                  borderRadius: BorderRadius.circular(10),
                                ),
                                child: Icon(
                                  Icons.settings,
                                  color: bleuCoris,
                                  size: 22,
                                ),
                              ),
                              SizedBox(width: 12),
                              Text(
                                "Paramètres de simulation",
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  color: bleuCoris,
                                ),
                              ),
                            ],
                          ),
                          SizedBox(height: 20),
                          _buildTypePretDropdown(),
                          SizedBox(height: 16),
                          _buildModernTextField(
                            controller: _capitalController,
                            label: 'Montant du prêt à couvrir',
                            hint: 'Saisissez le montant',
                            icon: Icons.monetization_on,
                            suffix: 'FCFA',
                            onChanged: (value) {
                              _formatTextField(_capitalController);

                              // Vérification du montant maximum (30 000 000 FCFA)
                              String cleanValue =
                                  _capitalController.text.replaceAll(' ', '');
                              double? montant = double.tryParse(cleanValue);
                              if (montant != null && montant > 30000000) {
                                _showProfessionalDialog(
                                  title: 'Limite de capital dépassée',
                                  message:
                                      'Le montant maximum du prêt à couvrir pour FLEX EMPRUNTEUR est de 30 000 000 FCFA.',
                                  icon: Icons.monetization_on_outlined,
                                  iconColor: orangeWarning,
                                  backgroundColor: orangeWarning,
                                );
                                _capitalController.text =
                                    _formatNumber(30000000);
                                _capitalController.selection =
                                    TextSelection.fromPosition(
                                  TextPosition(
                                      offset: _capitalController.text.length),
                                );
                              }

                              _effectuerCalcul();
                            },
                          ),
                          SizedBox(height: 16),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Durée du contrat',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                  color: bleuCoris,
                                ),
                              ),
                              SizedBox(height: 8),
                              Row(
                                children: [
                                  Expanded(
                                    flex: 3,
                                    child: TextField(
                                      controller: _dureeController,
                                      keyboardType: TextInputType.number,
                                      decoration: InputDecoration(
                                        hintText: 'Durée',
                                        prefixIcon:
                                            Icon(Icons.schedule, size: 20),
                                        filled: true,
                                        fillColor: fondCarte,
                                        border: OutlineInputBorder(
                                          borderRadius:
                                              BorderRadius.circular(12),
                                          borderSide: BorderSide.none,
                                        ),
                                        focusedBorder: OutlineInputBorder(
                                          borderRadius:
                                              BorderRadius.circular(12),
                                          borderSide: BorderSide(
                                              color: bleuCoris, width: 2),
                                        ),
                                      ),
                                      onChanged: (value) => _effectuerCalcul(),
                                    ),
                                  ),
                                  SizedBox(width: 12),
                                  Expanded(
                                    flex: 2,
                                    child: DropdownButtonFormField<String>(
                                      value: _selectedDureeType,
                                      style: TextStyle(
                                          fontSize: 14, color: bleuCoris),
                                      decoration: InputDecoration(
                                        isDense: true,
                                        contentPadding: EdgeInsets.symmetric(
                                            horizontal: 12, vertical: 14),
                                        filled: true,
                                        fillColor: fondCarte,
                                        border: OutlineInputBorder(
                                          borderRadius:
                                              BorderRadius.circular(12),
                                          borderSide: BorderSide.none,
                                        ),
                                        focusedBorder: OutlineInputBorder(
                                          borderRadius:
                                              BorderRadius.circular(12),
                                          borderSide: BorderSide(
                                              color: bleuCoris, width: 2),
                                        ),
                                      ),
                                      items: _dureeOptions.map((String value) {
                                        return DropdownMenuItem<String>(
                                          value: value,
                                          child: Text(value,
                                              style: TextStyle(
                                                  fontSize: 14,
                                                  color: bleuCoris)),
                                        );
                                      }).toList(),
                                      onChanged: (value) {
                                        setState(() {
                                          _selectedDureeType = value!;
                                          _effectuerCalcul();
                                        });
                                      },
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                          SizedBox(height: 20),
                          if (_selectedTypePret != 'Prêt scolaire')
                            _buildGarantiesSection(),
                          if (_calculatedPrime > 0) _buildPrimeResult(),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildTypePretDropdown() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.1),
            blurRadius: 10,
            offset: Offset(0, 5),
          ),
        ],
      ),
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: 16.0),
        child: DropdownButtonFormField<String>(
          value: _selectedTypePret,
          decoration: InputDecoration(
            border: InputBorder.none,
            prefixIcon: Icon(Icons.account_balance, color: bleuCoris),
            labelText: 'Type de prêt à assurer',
          ),
          items: _typePretOptions.map((String value) {
            return DropdownMenuItem<String>(
              value: value,
              child: Text(value),
            );
          }).toList(),
          onChanged: (value) {
            setState(() {
              _selectedTypePret = value!;
              if (_selectedTypePret == 'Prêt scolaire') {
                _garantiePrevoyance = false;
                _garantiePerteEmploi = false;
              }
              _effectuerCalcul();
            });
          },
        ),
      ),
    );
  }

  Widget _buildGarantiesSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          "Garanties optionnelles",
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        SizedBox(height: 16),
        Container(
          decoration: BoxDecoration(
            color: Color.fromRGBO(0, 43, 107, 0.05),
            borderRadius: BorderRadius.circular(12),
          ),
          child: CheckboxListTile(
            title: Text(
              'Garantie Prévoyance (Décès)',
              style: TextStyle(fontWeight: FontWeight.w600),
            ),
            subtitle: Text('Protection en cas de décès'),
            value: _garantiePrevoyance,
            activeColor: bleuCoris,
            onChanged: (val) {
              setState(() {
                _garantiePrevoyance = val!;
                if (_garantiePrevoyance &&
                    _capitalPrevoyanceController.text.isEmpty) {
                  _capitalPrevoyanceController.text = _capitalController.text;
                }
                _effectuerCalcul();
              });
            },
          ),
        ),
        if (_garantiePrevoyance) ...[
          SizedBox(height: 16),
          _buildModernTextField(
            controller: _capitalPrevoyanceController,
            label: 'Capital Prévoyance',
            hint: 'Montant',
            icon: Icons.security,
            suffix: 'FCFA',
            onChanged: (value) {
              _formatTextField(_capitalPrevoyanceController);
              _effectuerCalcul();
            },
          ),
        ],
        SizedBox(height: 16),
        Container(
          decoration: BoxDecoration(
            color: Color.fromRGBO(0, 43, 107, 0.05),
            borderRadius: BorderRadius.circular(12),
          ),
          child: CheckboxListTile(
            title: Text(
              'Garantie Perte d\'emploi',
              style: TextStyle(fontWeight: FontWeight.w600),
            ),
            subtitle: Text('Protection en cas de perte d\'emploi'),
            value: _garantiePerteEmploi,
            activeColor: bleuCoris,
            onChanged: (val) {
              setState(() {
                _garantiePerteEmploi = val!;
                if (_garantiePerteEmploi &&
                    _capitalPerteEmploiController.text.isEmpty) {
                  _capitalPerteEmploiController.text = _capitalController.text;
                }
                _effectuerCalcul();
              });
            },
          ),
        ),
        if (_garantiePerteEmploi) ...[
          SizedBox(height: 16),
          _buildModernTextField(
            controller: _capitalPerteEmploiController,
            label: 'Montant d\'échéance',
            hint: 'Montant de la traite',
            icon: Icons.savings,
            suffix: 'FCFA',
            onChanged: (value) {
              _formatTextField(_capitalPerteEmploiController);
              _effectuerCalcul();
            },
          ),
        ],
      ],
    );
  }

  Widget _buildPrimeResult() {
    return Container(
      margin: EdgeInsets.only(top: 16),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Color.fromRGBO(16, 185, 129, 0.1),
            Color.fromRGBO(16, 185, 129, 0.05)
          ],
        ),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Color.fromRGBO(16, 185, 129, 0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.check_circle, color: vertSucces, size: 18),
              SizedBox(width: 8),
              Text(
                'Résultat de la simulation',
                style: TextStyle(
                  fontWeight: FontWeight.w700,
                  color: vertSucces,
                  fontSize: 14,
                ),
              ),
            ],
          ),
          SizedBox(height: 10),
          _buildResultRow(
              'Prime annuelle totale', _formatMontant(_calculatedPrime)),
          _buildResultRow(
              'Capital à garantir', _formatMontant(_calculatedCapital)),
          if (_garantiePrevoyance && _selectedTypePret != 'Prêt scolaire')
            _buildResultRow(
                'Prime Prévoyance', _formatMontant(_primePrevoyance)),
          if (_garantiePerteEmploi && _selectedTypePret != 'Prêt scolaire')
            _buildResultRow(
                'Prime Perte d\'emploi', _formatMontant(_primePerteEmploi)),
        ],
      ),
    );
  }

  Widget _buildResultRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: TextStyle(color: grisTexte, fontSize: 14)),
          Text(
            value,
            style: TextStyle(
              fontWeight: FontWeight.w600,
              color: bleuCoris,
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildModernTextField({
    required TextEditingController controller,
    required String label,
    required String hint,
    required IconData icon,
    String? suffix,
    required Function(String) onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        SizedBox(height: 8),
        TextField(
          controller: controller,
          keyboardType: TextInputType.number,
          onChanged: onChanged,
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: TextStyle(fontSize: 14),
            prefixIcon: Icon(icon, color: Color.fromRGBO(0, 43, 107, 0.7)),
            suffixText: suffix,
            suffixStyle: TextStyle(color: Color.fromRGBO(0, 43, 107, 0.7)),
            filled: true,
            fillColor: fondCarte,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: bleuCoris, width: 2),
            ),
          ),
        ),
      ],
    );
  }

  /// Page séparée pour les informations client (uniquement pour les commerciaux)
  Widget _buildStepClientInfo() {
    return AnimatedBuilder(
      animation: _fadeAnimation,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Padding(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Form(
                key: _formKeyClientInfo,
                child: ListView(
                  children: [
                    _buildFormSection(
                      'Informations du Client',
                      Icons.person,
                      [
                        _buildDropdownFieldStep2(
                          value: _selectedClientCivilite,
                          label: 'Civilité',
                          icon: Icons.person_outline,
                          items: ['Monsieur', 'Madame', 'Mademoiselle'],
                          onChanged: (value) {
                            setState(() {
                              _selectedClientCivilite = value!;
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientNomController,
                          label: 'Nom du client',
                          icon: Icons.person_outline,
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientPrenomController,
                          label: 'Prénom du client',
                          icon: Icons.person_outline,
                        ),
                        SizedBox(height: 16),
                        _buildDateField(
                          controller: _clientDateNaissanceController,
                          label: 'Date de naissance',
                          icon: Icons.calendar_today,
                          onDateSelected: (date) {
                            setState(() {
                              _clientDateNaissance = date;
                              _clientDateNaissanceController.text =
                                  '${date.day.toString().padLeft(2, '0')}/${date.month.toString().padLeft(2, '0')}/${date.year}';
                              // Calculer l'âge et effectuer le calcul
                              final maintenant = DateTime.now();
                              _clientAge = maintenant.year - date.year;
                              if (maintenant.month < date.month ||
                                  (maintenant.month == date.month &&
                                      maintenant.day < date.day)) {
                                _clientAge--;
                              }
                              _age = _clientAge;
                              _effectuerCalcul();
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientLieuNaissanceController,
                          label: 'Lieu de naissance',
                          icon: Icons.location_on,
                        ),
                        SizedBox(height: 16),
                        _buildPhoneFieldWithIndicatif(
                          controller: _clientTelephoneController,
                          label: 'Téléphone du client',
                          selectedIndicatif: _selectedClientIndicatif,
                          onIndicatifChanged: (value) {
                            setState(() {
                              _selectedClientIndicatif = value!;
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientEmailController,
                          label: 'Email du client',
                          icon: Icons.email,
                          keyboardType: TextInputType.emailAddress,
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientAdresseController,
                          label: 'Adresse du client',
                          icon: Icons.home,
                        ),
                        SizedBox(height: 16),
                        _buildModernTextFieldStep2(
                          controller: _clientNumeroPieceController,
                          label: 'Numéro de pièce d\'identité',
                          icon: Icons.badge,
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildStep2() {
    return AnimatedBuilder(
      animation: _fadeAnimation,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Padding(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Form(
                key: _formKeyStep2,
                child: ListView(
                  children: [
                    _buildFormSection(
                      'Bénéficiaire en cas de décès',
                      Icons.family_restroom,
                      [
                        _buildModernTextFieldStep2(
                          controller: _beneficiaireNomController,
                          label: 'Nom complet du bénéficiaire',
                          icon: Icons.person_outline,
                        ),
                        SizedBox(height: 16),
                        _buildPhoneFieldWithIndicatif(
                          controller: _beneficiaireContactController,
                          label: 'Contact du bénéficiaire',
                          selectedIndicatif: _selectedBeneficiaireIndicatif,
                          onIndicatifChanged: (value) {
                            setState(() {
                              _selectedBeneficiaireIndicatif = value!;
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildDropdownFieldStep2(
                          value: _selectedLienParente,
                          label: 'Lien de parenté',
                          icon: Icons.link,
                          items: _lienParenteOptions,
                          onChanged: (value) {
                            setState(() {
                              _selectedLienParente = value!;
                            });
                          },
                        ),
                      ],
                    ),
                    SizedBox(height: 20),
                    _buildFormSection(
                      'Contact d\'urgence',
                      Icons.contact_phone,
                      [
                        _buildModernTextFieldStep2(
                          controller: _personneContactNomController,
                          label: 'Nom complet',
                          icon: Icons.person_outline,
                        ),
                        SizedBox(height: 16),
                        _buildPhoneFieldWithIndicatif(
                          controller: _personneContactTelController,
                          label: 'Contact téléphonique',
                          selectedIndicatif: _selectedContactIndicatif,
                          onIndicatifChanged: (value) {
                            setState(() {
                              _selectedContactIndicatif = value!;
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildDropdownFieldStep2(
                          value: _selectedLienParenteUrgence,
                          label: 'Lien de parenté',
                          icon: Icons.link,
                          items: _lienParenteOptions,
                          onChanged: (value) {
                            setState(() {
                              _selectedLienParenteUrgence = value!;
                            });
                          },
                        ),
                        SizedBox(height: 16),
                        _buildDateEffetField(
                          controller: _dateEffetController,
                          label: 'Date d\'effet du contrat',
                          icon: Icons.event,
                          onDateSelected: (date) {
                            setState(() {
                              _dateEffetContrat = date;
                            });
                          },
                        ),
                      ],
                    ),
                    SizedBox(height: 20),
                    _buildDocumentUploadSection(),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildFormSection(String title, IconData icon, List<Widget> children) {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: blanc,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 10,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: bleuCoris, size: 20),
              SizedBox(width: 12),
              Text(
                title,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: bleuCoris,
                ),
              ),
            ],
          ),
          SizedBox(height: 16),
          ...children,
        ],
      ),
    );
  }

  Widget _buildModernTextFieldStep2({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    TextInputType? keyboardType,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: keyboardType,
      decoration: InputDecoration(
        labelText: label,
        prefixIcon: Container(
          margin: EdgeInsets.all(8),
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: Color.fromRGBO(0, 43, 107, 0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: bleuCoris, size: 20),
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: grisLeger),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: grisLeger),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: bleuCoris, width: 2),
        ),
        filled: true,
        fillColor: fondCarte,
        contentPadding: EdgeInsets.symmetric(vertical: 16, horizontal: 16),
      ),
      validator: (value) {
        if (value == null || value.trim().isEmpty) {
          return 'Ce champ est obligatoire';
        }
        return null;
      },
    );
  }

  Widget _buildDropdownFieldStep2({
    required String? value,
    required String label,
    required IconData icon,
    required List<String> items,
    required ValueChanged<String?> onChanged,
  }) {
    // Vérifier si la valeur est valide (null ou dans la liste)
    final validValue = (value != null && items.contains(value)) ? value : null;

    return DropdownButtonFormField<String>(
      value: validValue,
      decoration: InputDecoration(
        labelText: label,
        prefixIcon: Container(
          margin: EdgeInsets.all(8),
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: Color.fromRGBO(0, 43, 107, 0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: bleuCoris, size: 20),
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: grisLeger),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: grisLeger),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: bleuCoris, width: 2),
        ),
        filled: true,
        fillColor: fondCarte,
        contentPadding: EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      ),
      items: items.map((String value) {
        return DropdownMenuItem<String>(
          value: value,
          child: Text(value),
        );
      }).toList(),
      onChanged: onChanged,
      validator: (value) {
        if (value == null || value.isEmpty) {
          return 'Ce champ est obligatoire';
        }
        return null;
      },
    );
  }

  Widget _buildDateField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    required ValueChanged<DateTime> onDateSelected,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        SizedBox(height: 6),
        GestureDetector(
          onTap: () async {
            final DateTime? picked = await showDatePicker(
              context: context,
              initialDate: DateTime.now().subtract(Duration(days: 365 * 30)),
              firstDate: DateTime(1900),
              lastDate: DateTime.now(),
              locale: const Locale('fr', 'FR'),
              builder: (context, child) {
                return Theme(
                  data: Theme.of(context).copyWith(
                    colorScheme: ColorScheme.light(
                      primary: bleuCoris,
                      onPrimary: blanc,
                    ),
                    dialogTheme: DialogThemeData(
                      backgroundColor: blanc,
                    ),
                  ),
                  child: child!,
                );
              },
            );
            if (picked != null) {
              onDateSelected(picked);
            }
          },
          child: AbsorbPointer(
            child: TextFormField(
              controller: controller,
              decoration: InputDecoration(
                labelText: label,
                prefixIcon: Container(
                  margin: EdgeInsets.all(8),
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Color.fromRGBO(0, 43, 107, 0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: bleuCoris, size: 20),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: grisLeger),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: grisLeger),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: bleuCoris, width: 2),
                ),
                filled: true,
                fillColor: fondCarte,
                contentPadding:
                    EdgeInsets.symmetric(vertical: 16, horizontal: 16),
                suffixIcon: Icon(Icons.calendar_today, color: bleuCoris),
              ),
              validator: (value) {
                if (value == null || value.trim().isEmpty) {
                  return 'Ce champ est obligatoire';
                }
                return null;
              },
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDateEffetField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    required ValueChanged<DateTime> onDateSelected,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: bleuCoris,
          ),
        ),
        SizedBox(height: 6),
        GestureDetector(
          onTap: () async {
            final DateTime? picked = await showDatePicker(
              context: context,
              initialDate: DateTime.now(),
              firstDate: DateTime.now(),
              lastDate: DateTime(2100),
              locale: const Locale('fr', 'FR'),
              builder: (context, child) {
                return Theme(
                  data: Theme.of(context).copyWith(
                    colorScheme: ColorScheme.light(
                      primary: bleuCoris,
                      onPrimary: blanc,
                    ),
                    dialogTheme: DialogThemeData(
                      backgroundColor: blanc,
                    ),
                  ),
                  child: child!,
                );
              },
            );
            if (picked != null) {
              controller.text = '${picked.day}/${picked.month}/${picked.year}';
              onDateSelected(picked);
            }
          },
          child: AbsorbPointer(
            child: TextFormField(
              controller: controller,
              decoration: InputDecoration(
                labelText: label,
                prefixIcon: Container(
                  margin: EdgeInsets.all(8),
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Color.fromRGBO(0, 43, 107, 0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: bleuCoris, size: 20),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
                filled: true,
                fillColor: blanc,
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPhoneFieldWithIndicatif({
    required TextEditingController controller,
    required String label,
    required String selectedIndicatif,
    required ValueChanged<String?> onIndicatifChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: TextStyle(
                fontSize: 16, fontWeight: FontWeight.w600, color: bleuCoris)),
        SizedBox(height: 6),
        Row(
          children: [
            Container(
              width: 100,
              decoration: BoxDecoration(
                color: fondCarte,
                borderRadius: BorderRadius.circular(10),
                border: Border.all(color: grisLeger),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: selectedIndicatif,
                  isExpanded: true,
                  items: _indicatifs.map((String value) {
                    return DropdownMenuItem<String>(
                      value: value,
                      child: Padding(
                        padding: EdgeInsets.symmetric(horizontal: 12),
                        child: Text(value, style: TextStyle(fontSize: 14)),
                      ),
                    );
                  }).toList(),
                  onChanged: onIndicatifChanged,
                ),
              ),
            ),
            SizedBox(width: 10),
            Expanded(
              child: TextFormField(
                controller: controller,
                keyboardType: TextInputType.phone,
                decoration: InputDecoration(
                  isDense: true,
                  contentPadding:
                      EdgeInsets.symmetric(horizontal: 12, vertical: 14),
                  hintText: '00 00 00 00',
                  hintStyle: TextStyle(fontSize: 14),
                  prefixIcon: Icon(Icons.phone_outlined,
                      size: 20, color: Color.fromRGBO(0, 43, 107, 0.7)),
                  filled: true,
                  fillColor: fondCarte,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(10),
                    borderSide: BorderSide.none,
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(10),
                    borderSide: BorderSide(color: bleuCoris, width: 1.5),
                  ),
                ),
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return 'Ce champ est obligatoire';
                  }
                  if (!RegExp(r'^[0-9]{8,15}$')
                      .hasMatch(value.replaceAll(' ', ''))) {
                    return 'Numéro de téléphone invalide';
                  }
                  return null;
                },
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildDocumentUploadSection() {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: blanc,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 10,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.document_scanner, color: bleuCoris, size: 20),
              SizedBox(width: 12),
              Text(
                'Pièce d\'identité',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: bleuCoris,
                ),
              ),
            ],
          ),
          SizedBox(height: 16),
          GestureDetector(
            onTap: _pickDocument,
            child: AnimatedContainer(
              duration: Duration(milliseconds: 300),
              width: double.infinity,
              padding: EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: _pieceIdentite != null
                    ? Color.fromRGBO(16, 185, 129, 0.1)
                    : Color.fromRGBO(0, 43, 107, 0.05),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: _pieceIdentite != null
                      ? vertSucces
                      : Color.fromRGBO(0, 43, 107, 0.3),
                  width: 2,
                ),
              ),
              child: Column(
                children: [
                  AnimatedSwitcher(
                    duration: Duration(milliseconds: 300),
                    child: Icon(
                      _pieceIdentite != null
                          ? Icons.check_circle_outline
                          : Icons.cloud_upload_outlined,
                      size: 40,
                      color: _pieceIdentite != null ? vertSucces : bleuCoris,
                      key: ValueKey(_pieceIdentite != null),
                    ),
                  ),
                  SizedBox(height: 10),
                  Text(
                    _pieceIdentite != null
                        ? 'Document ajouté avec succès'
                        : 'Télécharger votre pièce d\'identité',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: _pieceIdentite != null ? vertSucces : bleuCoris,
                    ),
                  ),
                  SizedBox(height: 6),
                  Text(
                    _pieceIdentite != null
                        ? _pieceIdentite!.path.split('/').last
                        : 'Formats acceptés: PDF, JPG, PNG (Max: 5MB)',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 11,
                      color: grisTexte,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStep3() {
    /**
     * MODIFICATION IMPORTANTE:
     * 
     * Pour les CLIENTS (plateforme client):
     * - Les informations sont déjà pré-enregistrées dans la base de données lors de l'inscription
     * - On doit TOUJOURS charger les données depuis _loadUserData() qui récupère le profil de l'utilisateur connecté
     * - _userData doit contenir les informations du client connecté
     * 
     * Pour les COMMERCIAUX (plateforme commercial):
     * - Le commercial saisit les informations du client dans les champs du formulaire
     * - On utilise les valeurs des contrôleurs (_clientNomController, etc.)
     * - Ces informations sont ensuite stockées dans souscriptiondata.client_info
     */
    return AnimatedBuilder(
      animation: _fadeAnimation,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: _isCommercial
                ? _buildRecapContent()
                : FutureBuilder<Map<String, dynamic>>(
                    future: _loadUserDataForRecap(),
                    builder: (context, snapshot) {
                      // Pour les clients, attendre le chargement des données
                      if (snapshot.connectionState == ConnectionState.waiting) {
                        return Center(
                          child: CircularProgressIndicator(color: bleuCoris),
                        );
                      }

                      if (snapshot.hasError) {
                        debugPrint(
                            'Erreur chargement données récapitulatif: ${snapshot.error}');
                        // En cas d'erreur, essayer d'utiliser _userData si disponible
                        if (_userData.isNotEmpty) {
                          return _buildRecapContent(userData: _userData);
                        }
                        return Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(Icons.error, size: 48, color: rougeCoris),
                              SizedBox(height: 16),
                              Text('Erreur lors du chargement des données'),
                              TextButton(
                                onPressed: () => setState(() {}),
                                child: Text('Réessayer'),
                              ),
                            ],
                          ),
                        );
                      }

                      // Utiliser les données chargées ou _userData en fallback
                      final userData = snapshot.data ?? _userData;

                      // Si userData est vide, recharger les données
                      if (userData.isEmpty && !_isCommercial) {
                        // Recharger les données utilisateur
                        _loadUserDataForRecap().then((data) {
                          if (mounted && data.isNotEmpty) {
                            setState(() {
                              _userData = data;
                            });
                          }
                        });
                        return Center(
                            child: CircularProgressIndicator(color: bleuCoris));
                      }

                      return _buildRecapContent(userData: userData);
                    },
                  ),
          ),
        );
      },
    );
  }

  /// Charge les données utilisateur pour le récapitulatif (uniquement pour les clients)
  /// Cette méthode est appelée dans le FutureBuilder pour charger les données à la volée
  /// si elles ne sont pas déjà disponibles dans _userData
  Future<Map<String, dynamic>> _loadUserDataForRecap() async {
    try {
      // Si _userData est déjà chargé et non vide, l'utiliser directement
      if (_userData.isNotEmpty) {
        debugPrint('✅ Utilisation des données utilisateur déjà chargées');
        return _userData;
      }

      final token = await storage.read(key: 'token');
      if (token == null) {
        debugPrint('❌ Token non trouvé');
        // Retourner un map vide au lieu de lever une exception
        return {};
      }

      debugPrint('🔄 Chargement des données utilisateur depuis l\'API...');
      final response = await http.get(
        Uri.parse('${AppConfig.baseUrl}/users/profile'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        if (data != null && data is Map) {
          // 1) Cas standard: { success: true, user: { ... } }
          if (data['success'] == true &&
              data['user'] != null &&
              data['user'] is Map) {
            final userData = Map<String, dynamic>.from(data['user']);
            debugPrint(
                '✅ Données utilisateur: ${userData['nom']} ${userData['prenom']}');
            if (mounted) {
              setState(() {
                _userData = userData;
              });
            }
            return userData;
          }

          // 2) Cas nested: { success: true, data: { id, civilite, nom, ... } }
          if (data['success'] == true &&
              data['data'] != null &&
              data['data'] is Map) {
            final dataObj = data['data'] as Map<String, dynamic>;
            if (dataObj.containsKey('id') && dataObj.containsKey('email')) {
              final userData = Map<String, dynamic>.from(dataObj);
              debugPrint(
                  '✅ Données utilisateur depuis data: ${userData['nom']} ${userData['prenom']}');
              if (mounted) {
                setState(() {
                  _userData = userData;
                });
              }
              return userData;
            }
          }

          // 3) Cas nested avec user object: { data: { user: { ... } } }
          if (data['data'] != null &&
              data['data'] is Map &&
              data['data']['user'] != null &&
              data['data']['user'] is Map) {
            final userData = Map<String, dynamic>.from(data['data']['user']);
            debugPrint(
                '✅ Données utilisateur depuis data.user: ${userData['nom']} ${userData['prenom']}');
            if (mounted) {
              setState(() {
                _userData = userData;
              });
            }
            return userData;
          }

          // 4) Direct user object: { id, civilite, nom, ... }
          if (data.containsKey('id') && data.containsKey('email')) {
            final userData = Map<String, dynamic>.from(data);
            debugPrint(
                '✅ Données utilisateur directes: ${userData['nom']} ${userData['prenom']}');
            if (mounted) {
              setState(() {
                _userData = userData;
              });
            }
            return userData;
          }

          debugPrint(
              '⚠️ Réponse API inattendue (${response.statusCode}): ${response.body}');
        } else {
          debugPrint('⚠️ Format invalide (non-Map): ${response.body}');
        }
      } else {
        debugPrint('❌ Erreur HTTP ${response.statusCode}: ${response.body}');
      }

      // Fallback vers _userData si la requête échoue
      return _userData.isNotEmpty ? _userData : {};
    } catch (e) {
      debugPrint(
          '❌ Erreur chargement données utilisateur pour récapitulatif: $e');
      // Fallback vers _userData en cas d'erreur
      final result = _userData.isNotEmpty ? _userData : <String, dynamic>{};
      return result;
    }
  }

  Widget _buildRecapContent({Map<String, dynamic>? userData}) {
    /**
     * CONSTRUCTION DU RÉCAPITULATIF:
     * 
     * - Si _isCommercial = true: Utiliser les données des contrôleurs (infos client saisies par le commercial)
     * - Si _isCommercial = false: Utiliser userData (infos du client connecté depuis la base de données)
     */
    Map<String, dynamic>? raw = _isCommercial ? null : (userData ?? _userData);

    String pick(List<String> keys) {
      if (raw == null) return '';
      for (final k in keys) {
        if (raw.containsKey(k) && raw[k] != null) {
          final v = raw[k];
          if (v is String && v.trim().isNotEmpty) return v;
          if (v is int || v is double) return v.toString();
          if (v is DateTime) return v.toIso8601String();
        }
      }
      return '';
    }

    final displayData = _isCommercial
        ? {
            'civilite': _selectedClientCivilite,
            'nom': _clientNomController.text,
            'prenom': _clientPrenomController.text,
            'email': _clientEmailController.text,
            'telephone':
                '$_selectedClientIndicatif ${_clientTelephoneController.text}',
            'date_naissance': _clientDateNaissance?.toIso8601String(),
            'lieu_naissance': _clientLieuNaissanceController.text,
            'adresse': _clientAdresseController.text,
          }
        : {
            'civilite': pick(['civilite', 'title', 'gender']),
            'nom': pick(['nom', 'last_name', 'name', 'full_name', 'prenom']),
            'prenom': pick(['prenom', 'first_name', 'given_name']),
            'email': pick(['email', 'mail']),
            'telephone': pick(['telephone', 'phone', 'phone_number', 'tel']),
            'date_naissance': pick(['date_naissance', 'birth_date', 'dob']),
            'lieu_naissance':
                pick(['lieu_naissance', 'place_of_birth', 'birth_place']),
            'adresse': pick(['adresse', 'address']),
          };

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: 20),
      child: ListView(
        children: [
          _buildRecapSection(
            'Informations Personnelles',
            Icons.person,
            bleuCoris,
            [
              _buildCombinedRecapRow(
                'Civilité',
                displayData['civilite'] ?? 'Non renseigné',
                'Nom',
                displayData['nom'] ?? 'Non renseigné',
              ),
              _buildCombinedRecapRow(
                'Prénom',
                displayData['prenom'] ?? 'Non renseigné',
                'Email',
                displayData['email'] ?? 'Non renseigné',
              ),
              _buildCombinedRecapRow(
                'Téléphone',
                displayData['telephone'] ?? 'Non renseigné',
                'Date de naissance',
                displayData['date_naissance'] != null
                    ? _formatDate(displayData['date_naissance'].toString())
                    : 'Non renseigné',
              ),
              _buildCombinedRecapRow(
                'Lieu de naissance',
                displayData['lieu_naissance'] ?? 'Non renseigné',
                'Adresse',
                displayData['adresse'] ?? 'Non renseigné',
              ),
            ],
          ),
          SizedBox(height: 20),
          _buildRecapSection(
            'Produit Souscrit',
            Icons.account_balance,
            vertSucces,
            [
              _buildCombinedRecapRow('Produit', 'FLEX EMPRUNTEUR',
                  'Type de prêt', _selectedTypePret),
              _buildCombinedRecapRow(
                  'Capital à garantir',
                  _formatMontant(_calculatedCapital),
                  'Durée',
                  '${_dureeController.text} $_selectedDureeType'),
              if (_dateEffetContrat != null && _dateEcheanceContrat != null)
                _buildCombinedRecapRow(
                    'Date d\'effet',
                    _formatDate(_dateEffetContrat!.toString()),
                    'Date d\'échéance',
                    _formatDate(_dateEcheanceContrat!.toString())),
              if (_dateEffetContrat != null && _dateEcheanceContrat == null)
                _buildCombinedRecapRow('Date d\'effet',
                    _formatDate(_dateEffetContrat!.toString()), '', ''),
              if (_dateEffetContrat == null && _dateEcheanceContrat != null)
                _buildCombinedRecapRow('Date d\'échéance',
                    _formatDate(_dateEcheanceContrat!.toString()), '', ''),
              _buildCombinedRecapRow('Prime annuelle totale',
                  _formatMontant(_calculatedPrime), '', ''),
              // Afficher les garanties optionnelles avec capital ET prime
              if (_garantiePrevoyance)
                _buildCombinedRecapRow(
                    'Capital Prévoyance',
                    _formatMontant(
                        _parseDouble(_capitalPrevoyanceController.text)),
                    'Prime Prévoyance',
                    _formatMontant(_primePrevoyance)),
              if (_garantiePerteEmploi)
                _buildCombinedRecapRow(
                    'Capital Perte d\'emploi',
                    _formatMontant(
                        _parseDouble(_capitalPerteEmploiController.text)),
                    'Prime Perte d\'emploi',
                    _formatMontant(_primePerteEmploi)),
            ],
          ),
          SizedBox(height: 20),
          _buildRecapSection(
            'Bénéficiaire et Contact d\'urgence',
            Icons.contacts,
            orangeWarning,
            [
              _buildSubsectionTitle('Bénéficiaire'),
              _buildRecapRow(
                  'Nom complet',
                  _beneficiaireNomController.text.isEmpty
                      ? 'Non renseigné'
                      : _beneficiaireNomController.text),
              _buildRecapRow('Contact',
                  '$_selectedBeneficiaireIndicatif ${_beneficiaireContactController.text.isEmpty ? 'Non renseigné' : _beneficiaireContactController.text}'),
              _buildRecapRow('Lien de parenté', _selectedLienParente),
              SizedBox(height: 12),
              _buildSubsectionTitle('Contact d\'urgence'),
              _buildRecapRow(
                  'Nom complet',
                  _personneContactNomController.text.isEmpty
                      ? 'Non renseigné'
                      : _personneContactNomController.text),
              _buildRecapRow('Contact',
                  '$_selectedContactIndicatif ${_personneContactTelController.text.isEmpty ? 'Non renseigné' : _personneContactTelController.text}'),
              _buildRecapRow('Lien de parenté', _selectedLienParenteUrgence),
            ],
          ),
          SizedBox(height: 20),
          SubscriptionRecapWidgets.buildDocumentsSection(
            pieceIdentite: _pieceIdentiteLabel ?? _pieceIdentite?.path.split('/').last,
            onDocumentTap: _pieceIdentite != null
                ? () => _viewLocalDocument(
                    _pieceIdentite!, _pieceIdentiteLabel ?? _pieceIdentite!.path.split('/').last)
                : null,
          ),
          SizedBox(height: 20),
          Container(
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Color.fromRGBO(245, 158, 11, 0.1),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Color.fromRGBO(245, 158, 11, 0.3)),
            ),
            child: Column(
              children: [
                Icon(Icons.info_outline, color: orangeWarning, size: 28),
                SizedBox(height: 10),
                Text(
                  'Vérification Importante',
                  style: TextStyle(
                    fontWeight: FontWeight.w700,
                    color: orangeWarning,
                    fontSize: 14,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: 8),
                Text(
                  'Vérifiez attentivement toutes les informations ci-dessus. Une fois la souscription validée, certaines modifications ne seront plus possibles.',
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: grisTexte,
                    fontSize: 12,
                    height: 1.4,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 20),
        ],
      ),
    );
  }

  String _formatDate(String dateString) {
    try {
      final date = DateTime.parse(dateString);
      return "${date.day.toString().padLeft(2, '0')}/${date.month.toString().padLeft(2, '0')}/${date.year}";
    } catch (e) {
      return dateString;
    }
  }

  Widget _buildRecapRow(String label, String value,
      {bool isHighlighted = false}) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 110,
            child: Text(
              '$label :',
              style: TextStyle(
                fontWeight: FontWeight.w500,
                color: grisTexte,
                fontSize: 12,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                fontWeight: FontWeight.w600,
                color: isHighlighted ? vertSucces : bleuCoris,
                fontSize: isHighlighted ? 13 : 12,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildRecapSection(
      String title, IconData icon, Color color, List<Widget> children) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: blanc,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 10,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: color.withOpacity(0.10),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, color: color, size: 18),
              ),
              SizedBox(width: 10),
              Text(
                title,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w700,
                  color: color,
                ),
              ),
            ],
          ),
          SizedBox(height: 12),
          ...children,
        ],
      ),
    );
  }

  Widget _buildSubsectionTitle(String title) {
    return Text(
      title,
      style: TextStyle(
        fontWeight: FontWeight.w600,
        color: bleuCoris,
        fontSize: 14,
      ),
    );
  }

  Widget _buildCombinedRecapRow(
      String label1, String value1, String label2, String value2) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  '$label1 :',
                  style: TextStyle(
                    fontWeight: FontWeight.w500,
                    color: grisTexte,
                    fontSize: 12,
                  ),
                ),
                Text(
                  value1,
                  style: TextStyle(
                    fontWeight: FontWeight.w600,
                    color: bleuCoris,
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (label2.isNotEmpty)
                  Text(
                    '$label2 :',
                    style: TextStyle(
                      fontWeight: FontWeight.w500,
                      color: grisTexte,
                      fontSize: 12,
                    ),
                  ),
                if (value2.isNotEmpty)
                  Text(
                    value2,
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      color: bleuCoris,
                      fontSize: 12,
                    ),
                  ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _viewLocalDocument(File document, String filename) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => DocumentViewerPage(
          localFile: document,
          documentName: filename,
        ),
      ),
    );
  }

  Widget _buildNavigationButtons() {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: blanc,
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.05),
            blurRadius: 20,
            offset: Offset(0, -4),
          ),
        ],
      ),
      child: SafeArea(
        child: Row(
          children: [
            if (_currentStep > 0)
              Expanded(
                child: OutlinedButton(
                  onPressed: _previousStep,
                  style: OutlinedButton.styleFrom(
                    side: BorderSide(color: bleuCoris, width: 2),
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.arrow_back, color: bleuCoris, size: 20),
                      SizedBox(width: 8),
                      Text(
                        'Précédent',
                        style: TextStyle(
                          color: bleuCoris,
                          fontWeight: FontWeight.w600,
                          fontSize: 16,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            if (_currentStep > 0) SizedBox(width: 16),
            Expanded(
              child: ElevatedButton(
                onPressed: _currentStep == (_isCommercial ? 3 : 2)
                    ? _showSignatureAndPayment
                    : _nextStep,
                style: ElevatedButton.styleFrom(
                  backgroundColor: bleuCoris,
                  padding: EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 0,
                  shadowColor: Color.fromRGBO(0, 43, 107, 0.3),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(
                      _currentStep == (_isCommercial ? 3 : 2)
                          ? Icons.draw
                          : Icons.arrow_forward,
                      color: blanc,
                      size: 20,
                    ),
                    SizedBox(width: 8),
                    Text(
                      _currentStep == (_isCommercial ? 3 : 2)
                          ? 'Signer et Finaliser'
                          : 'Suivant',
                      style: TextStyle(
                        color: blanc,
                        fontWeight: FontWeight.w700,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _showSignatureAndPayment() async {
    // 1. Afficher le dialogue de signature
    final Uint8List? signature = await showDialog<Uint8List>(
      context: context,
      barrierDismissible: false,
      builder: (context) => const SignatureDialogFile.SignatureDialog(),
    );

    // Si l'utilisateur annule la signature, on arrête
    if (signature == null) return;

    // Sauvegarder la signature
    setState(() {
      _clientSignature = signature;
    });

    // 2. Afficher les options de paiement
    if (!mounted) return;
    _showPaymentOptions();
  }

  void _showPaymentOptions() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _PaymentBottomSheet(
        onPayNow: (paymentMethod) {
          Navigator.pop(context);
          _processPayment(paymentMethod);
        },
        onPayLater: () {
          Navigator.pop(context);
          _saveAsProposition();
        },
      ),
    );
  }

  Future<int> _saveSubscriptionData() async {
    try {
      final subscriptionService = SubscriptionService();

      final subscriptionData = {
        'product_type': 'flex_emprunteur',
        'type_pret': _selectedTypePret,
        'capital': _parseDouble(_capitalController.text),
        'duree': _parseInt(_dureeController.text),
        'duree_type': _selectedDureeType,
        'garantie_prevoyance': _garantiePrevoyance,
        'garantie_perte_emploi': _garantiePerteEmploi,
        'capital_prevoyance': _garantiePrevoyance
            ? _parseDouble(_capitalPrevoyanceController.text)
            : 0,
        'capital_perte_emploi': _garantiePerteEmploi
            ? _parseDouble(_capitalPerteEmploiController.text)
            : 0,
        'prime_prevoyance': _primePrevoyance,
        'prime_perte_emploi': _primePerteEmploi,
        'beneficiaire': {
          'nom': _beneficiaireNomController.text.trim(),
          'contact':
              '$_selectedBeneficiaireIndicatif ${_beneficiaireContactController.text.trim()}',
          'lien_parente': _selectedLienParente,
        },
        'contact_urgence': {
          'nom': _personneContactNomController.text.trim(),
          'contact':
              '$_selectedContactIndicatif ${_personneContactTelController.text.trim()}',
          'lien_parente': _selectedLienParenteUrgence,
        },
        'piece_identite': _pieceIdentite?.path.split('/').last ?? '',
        'prime_annuelle': _calculatedPrime,
        'capital_garanti': _calculatedCapital,
        'date_effet': _dateEffetContrat?.toIso8601String(),
        'date_echeance': _dateEcheanceContrat?.toIso8601String(),
      };

      // Ajouter la signature si elle existe
      if (_clientSignature != null) {
        subscriptionData['signature'] = base64Encode(_clientSignature!);
      }

      // Si c'est un commercial, ajouter les infos client
      if (_isCommercial) {
        subscriptionData['client_info'] = {
          'nom': _clientNomController.text.trim(),
          'prenom': _clientPrenomController.text.trim(),
          'date_naissance':
              _clientDateNaissance?.toIso8601String().split('T').first,
          'lieu_naissance': _clientLieuNaissanceController.text.trim(),
          'telephone':
              '$_selectedClientIndicatif ${_clientTelephoneController.text.trim()}',
          'email': _clientEmailController.text.trim(),
          'adresse': _clientAdresseController.text.trim(),
          'civilite': _selectedClientCivilite,
          'numero_piece_identite': _clientNumeroPieceController.text.trim(),
        };
      }

      final http.Response response;
      if (widget.subscriptionId != null) {
        response = await subscriptionService.updateSubscription(
            widget.subscriptionId!, subscriptionData);
      } else {
        response =
            await subscriptionService.createSubscription(subscriptionData);
      }

      final responseData = jsonDecode(response.body);

      if ((response.statusCode != 201 && response.statusCode != 200) ||
          !responseData['success']) {
        throw Exception(
            responseData['message'] ?? 'Erreur lors de la sauvegarde');
      }

      return widget.subscriptionId ?? responseData['data']['id'];
    } catch (e) {
      debugPrint('Erreur sauvegarde souscription: $e');
      rethrow;
    }
  }

  Future<void> _updatePaymentStatus(int subscriptionId, bool paymentSuccess,
      {String? paymentMethod}) async {
    try {
      final subscriptionService = SubscriptionService();
      final response = await subscriptionService.updatePaymentStatus(
        subscriptionId,
        paymentSuccess,
        paymentMethod: paymentMethod,
      );

      final responseData = jsonDecode(response.body);

      if (response.statusCode != 200 || !responseData['success']) {
        throw Exception(responseData['message'] ??
            'Erreur lors de la mise à jour du statut');
      }

      debugPrint(
          'Statut mis à jour: ${paymentSuccess ? 'contrat' : 'proposition'}');
    } catch (e) {
      debugPrint('Erreur mise à jour statut: $e');
      rethrow;
    }
  }

  Future<bool> _simulatePayment(String paymentMethod) async {
    await Future.delayed(const Duration(seconds: 2));
    return true;
  }

  void _processPayment(String paymentMethod) async {
    if (!mounted) return;

    // Si CORIS Money est sélectionné, utiliser le modal de paiement
    if (paymentMethod == 'CORIS Money') {
      try {
        final subscriptionId = await _saveSubscriptionData();

        // Upload du document pièce d'identité si présent
        if (_pieceIdentite != null) {
          await _uploadDocument(subscriptionId);
        }

        // Afficher le modal de paiement CorisMoney
        if (mounted) {
          showDialog(
            context: context,
            barrierDismissible: false,
            builder: (context) => CorisMoneyPaymentModal(
              subscriptionId: subscriptionId,
              montant: _calculatedPrime,
              description: 'Paiement prime CORIS FLEX',
              onPaymentSuccess: () {
                if (mounted) {
                  Navigator.pop(context);
                  _showSuccessDialog(true);
                }
              },
            ),
          );
        }
      } catch (e) {
        debugPrint('❌ Erreur lors du processus: $e');
        if (mounted) {
          _showErrorSnackBar('Erreur lors du traitement: $e');
        }
      }
      return;
    }

    showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => LoadingDialog(paymentMethod: paymentMethod));

    try {
      final subscriptionId = await _saveSubscriptionData();

      // Upload du document pièce d'identité si présent
      if (_pieceIdentite != null) {
        await _uploadDocument(subscriptionId);
      }

      final paymentSuccess = await _simulatePayment(paymentMethod);
      await _updatePaymentStatus(subscriptionId, paymentSuccess,
          paymentMethod: paymentMethod);

      if (!mounted) return;
      Navigator.pop(context);

      if (paymentSuccess) {
        _showSuccessDialog(true);
      } else {
        _showErrorSnackBar(
            'Paiement échoué. Votre proposition a été sauvegardée.');
      }
    } catch (e) {
      if (mounted) {
        Navigator.pop(context);
        _showErrorSnackBar('Erreur lors du traitement: $e');
      }
    }
  }

  void _saveAsProposition() async {
    try {
      final subscriptionId = await _saveSubscriptionData();

      // Upload du document pièce d'identité si présent
      if (_pieceIdentite != null) {
        await _uploadDocument(subscriptionId);
      }

      if (mounted) {
        _showSuccessDialog(false);
      }
    } catch (e) {
      if (mounted) {
        _showErrorSnackBar('Erreur lors de la sauvegarde: $e');
      }
    }
  }

  /// Upload le document pièce d'identité vers le serveur
  Future<void> _uploadDocument(int subscriptionId) async {
    try {
      debugPrint('📤 Upload document pour souscription $subscriptionId');
      final subscriptionService = SubscriptionService();
      final response = await subscriptionService.uploadDocument(
        subscriptionId,
        _pieceIdentite!.path,
      );
      final responseData = jsonDecode(response.body);
      if (response.statusCode != 200 || !responseData['success']) {
        debugPrint('❌ Erreur upload: ${responseData['message']}');
      }
      
      // Récupérer le label original si présent dans la réponse
      try {
        final updated = responseData['data']?['subscription'];
        if (updated != null) {
          final souscriptiondata = updated['souscriptiondata'];
          if (souscriptiondata != null) {
            if (souscriptiondata is Map) {
              _pieceIdentiteLabel = souscriptiondata['piece_identite_label'];
            } else if (souscriptiondata is String) {
              try {
                final parsed = jsonDecode(souscriptiondata);
                _pieceIdentiteLabel = parsed['piece_identite_label'];
              } catch (_) {}
            }
          }
        }
      } catch (e) {
        debugPrint('⚠️ Impossible de lire piece_identite_label depuis la réponse: $e');
      }
      
      debugPrint('✅ Document uploadé avec succès');
    } catch (e) {
      debugPrint('❌ Exception upload document: $e');
    }
  }

  void _showSuccessDialog(bool isPaid) {
    if (!mounted) return;
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => SuccessDialog(isPaid: isPaid),
    );
  }

  @override
  void dispose() {
    _animationController.dispose();
    _progressController.dispose();
    _pageController.dispose();
    _capitalController.dispose();
    _dureeController.dispose();
    _capitalPrevoyanceController.dispose();
    _capitalPerteEmploiController.dispose();
    _beneficiaireNomController.dispose();
    _beneficiaireContactController.dispose();
    _personneContactNomController.dispose();
    _personneContactTelController.dispose();
    // Dispose des contrôleurs client
    _clientNomController.dispose();
    _clientPrenomController.dispose();
    _clientDateNaissanceController.dispose();
    _clientLieuNaissanceController.dispose();
    _clientTelephoneController.dispose();
    _clientEmailController.dispose();
    _clientAdresseController.dispose();
    _clientNumeroPieceController.dispose();
    _dateEffetController.dispose();
    super.dispose();
  }
}

class LoadingDialog extends StatelessWidget {
  final String paymentMethod;
  const LoadingDialog({super.key, required this.paymentMethod});

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Color.fromRGBO(0, 0, 0, 0.1),
              blurRadius: 20,
              offset: Offset(0, 8),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            SizedBox(
              width: 60,
              height: 60,
              child: CircularProgressIndicator(
                color: Color(0xFF002B6B),
                strokeWidth: 3,
              ),
            ),
            SizedBox(height: 20),
            Text(
              'Traitement en cours',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w700,
                color: Color(0xFF002B6B),
              ),
            ),
            SizedBox(height: 8),
            Text(
              'Paiement via $paymentMethod...',
              textAlign: TextAlign.center,
              style: TextStyle(
                color: Color(0xFF64748B),
                fontSize: 14,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class SuccessDialog extends StatelessWidget {
  final bool isPaid;
  const SuccessDialog({super.key, required this.isPaid});

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Color.fromRGBO(0, 0, 0, 0.1),
              blurRadius: 20,
              offset: Offset(0, 8),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                color: isPaid
                    ? Color(0xFF10B981).withAlpha(26)
                    : Color(0xFFF59E0B)
                        .withAlpha(26), // .withOpacity(0.1) remplacé
                shape: BoxShape.circle,
              ),
              child: Icon(
                isPaid ? Icons.check_circle : Icons.schedule,
                color: isPaid ? Color(0xFF10B981) : Color(0xFFF59E0B),
                size: 40,
              ),
            ),
            SizedBox(height: 20),
            Text(
              isPaid ? 'Souscription Réussie!' : 'Proposition Enregistrée!',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w700,
                color: Color(0xFF002B6B),
              ),
            ),
            SizedBox(height: 12),
            Text(
              isPaid
                  ? 'Félicitations! Votre contrat FLEX EMPRUNTEUR est maintenant actif. Vous recevrez un message de confirmation sous peu.'
                  : 'Votre proposition a été enregistrée avec succès. Vous pouvez effectuer le paiement plus tard depuis votre espace client.',
              textAlign: TextAlign.center,
              style: TextStyle(
                color: Color(0xFF64748B),
                fontSize: 14,
                height: 1.4,
              ),
            ),
            SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                  // Retour à la page d'accueil client
                  Navigator.pushNamedAndRemoveUntil(
                      context, '/client_home', (route) => false);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFF002B6B),
                  padding: EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                child: Text(
                  'Retour à l\'accueil',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _PaymentBottomSheet extends StatelessWidget {
  final Function(String) onPayNow;
  final VoidCallback onPayLater;
  const _PaymentBottomSheet({
    required this.onPayNow,
    required this.onPayLater,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(0, 0, 0, 0.1),
            blurRadius: 20,
            offset: Offset(0, -4),
          ),
        ],
      ),
      child: SafeArea(
        child: Padding(
          padding: EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Color.fromRGBO(158, 158, 158, 77), // 0.3 alpha
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              SizedBox(height: 24),
              Row(
                children: [
                  Icon(Icons.payment, color: Color(0xFF002B6B), size: 28),
                  SizedBox(width: 12),
                  Text(
                    'Options de Paiement',
                    style: TextStyle(
                      fontSize: 22,
                      fontWeight: FontWeight.w700,
                      color: Color(0xFF002B6B),
                    ),
                  ),
                ],
              ),
              SizedBox(height: 24),
              _buildPaymentOptionWithImage(
                'Wave',
                'assets/images/icone_wave.jpeg',
                const Color(0xFF1976D2),
                'Paiement mobile sécurisé',
                () => onPayNow('Wave'),
              ),
              SizedBox(height: 12),
              _buildPaymentOptionWithImage(
                'Orange Money',
                'assets/images/icone_orange_money.jpeg',
                const Color(0xFFE65100),
                'Paiement mobile Orange',
                () => onPayNow('Orange Money'),
              ),
              SizedBox(height: 12),
              _buildPaymentOptionWithImage(
                'CORIS Money',
                'assets/images/icone_corismoney.jpeg',
                const Color(0xFF1E3A8A),
                'Paiement par CORIS Money',
                () => onPayNow('CORIS Money'),
              ),
              SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                      child: Divider(color: Color.fromRGBO(158, 158, 158, 77))),
                  Padding(
                    padding: EdgeInsets.symmetric(horizontal: 16),
                    child: Text(
                      'OU',
                      style: TextStyle(
                        color: Color(0xFF64748B),
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                  Expanded(
                      child: Divider(color: Color.fromRGBO(158, 158, 158, 77))),
                ],
              ),
              SizedBox(height: 20),
              SizedBox(
                width: double.infinity,
                child: OutlinedButton(
                  onPressed: onPayLater,
                  style: OutlinedButton.styleFrom(
                    side: BorderSide(color: Color(0xFF002B6B), width: 2),
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.schedule, color: Color(0xFF002B6B)),
                      SizedBox(width: 8),
                      Text(
                        'Payer plus tard',
                        style: TextStyle(
                          color: Color(0xFF002B6B),
                          fontWeight: FontWeight.w600,
                          fontSize: 16,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
              SizedBox(height: MediaQuery.of(context).viewInsets.bottom),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPaymentOption(String title, IconData icon, Color color,
      String subtitle, VoidCallback onTap) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: const Color(0xFFF8FAFC),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
              color: const Color.fromRGBO(158, 158, 158, 51)), // 0.2 alpha
        ),
        child: Row(
          children: [
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: color, // Couleur pleine pour meilleure visibilité
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icon, color: Colors.white, size: 28),
            ),
            SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      color: const Color(0xFF002B6B),
                      fontSize: 16,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: const Color(0xFF64748B),
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              Icons.arrow_forward_ios,
              color: const Color(0xFF64748B),
              size: 16,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPaymentOptionWithImage(String title, String imagePath, Color color,
      String subtitle, VoidCallback onTap) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: const Color(0xFFF8FAFC),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
              color: const Color.fromRGBO(158, 158, 158, 51)), // 0.2 alpha
        ),
        child: Row(
          children: [
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: const Color.fromRGBO(158, 158, 158, 51)),
              ),
              child: Image.asset(
                imagePath,
                width: 32,
                height: 32,
                fit: BoxFit.contain,
                errorBuilder: (context, error, stackTrace) {
                  print('❌ Erreur chargement image: $imagePath - $error');
                  return Icon(Icons.image_not_supported, size: 32, color: Colors.grey);
                },
              ),
            ),
            SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      color: const Color(0xFF002B6B),
                      fontSize: 16,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: const Color(0xFF64748B),
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              Icons.arrow_forward_ios,
              color: const Color(0xFF64748B),
              size: 16,
            ),
          ],
        ),
      ),
    );
  }
}
